<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Galactic Math Quest 🚀 - Ultimate Enhanced Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Enhanced fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* =========[ ENHANCED GLOBAL RESET ]========= */
    *{box-sizing:border-box;margin:0;padding:0}

    /* =========[ EXPANDED COLOUR VARIABLES ]========= */
    :root{
      --bg-space:#0d0221;
      --bg-nebula:#1a0b2e;
      --star:#12063d;
      --star-bright:#2a1555;
      --text:#e6e6e6;
      --accent:#ffca3a;
      --good:#2ec4b6;
      --bad:#e71d36;
      --asteroid:#b08968;
      --ship-size:60px;
      --powerup:#ff00ff;
      --combo:#00ff88;
      --panel-bg:rgba(13,2,33,0.95);
      --border-glow:#5a3a8a;
      --mission:#ff6b6b;
      --algebra:#4ecdc4;
      --geometry:#95e1d3;
      --fraction:#f38181;
      --calculus:#9b59b6;
      --trigonometry:#f39c12;
      --statistics:#16a085;
      --advanced:#e74c3c;
      --tutorial:#3498db;
      --success:#27ae60;
      --warning:#f1c40f;
      --danger:#e74c3c;
      --info:#3498db;
      --premium:#d4af37;
      --legendary:#ff1493;
    }
    
    /* Enhanced theme variations */
    body.theme-nebula{
      --bg-space:#2d1b69;
      --star:#3d2b79;
      --accent:#ff006e;
      --good:#00ff94;
    }
    body.theme-nova{
      --bg-space:#440a67;
      --star:#93329e;
      --accent:#ff7b00;
      --good:#00d4ff;
    }
    body.theme-matrix{
      --bg-space:#000;
      --star:#0f0;
      --accent:#0f0;
      --good:#0f0;
      --text:#0f0;
    }
    body.theme-cyberpunk{
      --bg-space:#0a0a0a;
      --star:#ff00ff;
      --accent:#00ffff;
      --good:#ff0080;
    }
    body.high-contrast{
      --bg-space:#000;
      --star:#222;
      --text:#fff;
      --accent:#ff0;
      --good:#0f0;
      --bad:#f00;
    }

    /* =========[ ENHANCED BODY / SCENE ]========= */
    body{
      font-family:'Press Start 2P',monospace;
      color:var(--text);
      background:var(--bg-space);
      height:100vh;
      overflow:hidden;
      user-select:none;
      display:flex;
      transition:all 0.5s ease;
    }
    
    /* Advanced animated starfield with multiple layers */
    #starfield{
      position:fixed;
      width:100%;
      height:100%;
      background:
        radial-gradient(2px 2px at 20% 30%, var(--star-bright), transparent),
        radial-gradient(2px 2px at 60% 70%, var(--star), transparent),
        radial-gradient(1px 1px at 50% 50%, var(--star), transparent),
        radial-gradient(1px 1px at 80% 10%, var(--star-bright), transparent),
        radial-gradient(3px 3px at 40% 40%, var(--star-bright), transparent),
        radial-gradient(1px 1px at 90% 20%, var(--star), transparent);
      background-size: 400px 400px, 500px 500px, 600px 600px, 700px 700px, 800px 800px, 300px 300px;
      animation: starMove 120s linear infinite, starTwinkle 3s ease-in-out infinite;
    }
    
    /* Enhanced nebula with animated colors */
    #nebula{
      position:fixed;
      width:100%;
      height:100%;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(138, 43, 226, 0.3) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255, 105, 180, 0.2) 0%, transparent 50%),
        radial-gradient(ellipse at center, transparent 0%, var(--bg-nebula) 100%);
      opacity:0.5;
      animation:nebulaPulse 30s ease-in-out infinite, nebulaRotate 120s linear infinite;
    }
    
    /* Shooting stars */
    .shootingStar{
      position:fixed;
      width:2px;
      height:2px;
      background:var(--star-bright);
      box-shadow:0 0 0 1px var(--star-bright);
      animation:shootingStar 3s linear infinite;
      opacity:0;
    }
    
    @keyframes starMove{
      from{transform:translateY(0)}
      to{transform:translateY(400px)}
    }
    @keyframes starTwinkle{
      0%,100%{opacity:0.8}
      50%{opacity:1}
    }
    @keyframes nebulaPulse{
      0%,100%{opacity:0.3}
      50%{opacity:0.7}
    }
    @keyframes nebulaRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    @keyframes shootingStar{
      0%{opacity:0;transform:translateX(-100px) translateY(100px)}
      10%{opacity:1}
      90%{opacity:1}
      100%{opacity:0;transform:translateX(100vw) translateY(-100px)}
    }
    
    /* =========[ ENHANCED MAIN LAYOUT ]========= */
    #mainContainer{
      width:100%;
      display:flex;
      position:relative;
      z-index:1;
    }
    
    #sidePanel{
      width:320px;
      background:var(--panel-bg);
      border-right:3px solid var(--border-glow);
      padding:20px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:15px;
      backdrop-filter:blur(15px);
      box-shadow:0 0 30px rgba(0,0,0,0.7);
      transition:all 0.3s ease;
    }
    
    #gameArea{
      flex:1;
      position:relative;
      overflow:hidden;
    }

    /* =========[ ENHANCED SIDE PANEL SECTIONS ]========= */
    .panel-section{
      background:rgba(0,0,0,0.6);
      border:2px solid var(--border-glow);
      border-radius:12px;
      padding:15px;
      animation:borderGlow 4s ease-in-out infinite;
      position:relative;
      backdrop-filter:blur(5px);
    }
    
    .panel-section::before{
      content:'';
      position:absolute;
      top:-2px;
      left:-2px;
      right:-2px;
      bottom:-2px;
      background:linear-gradient(45deg, var(--border-glow), var(--accent), var(--border-glow));
      border-radius:12px;
      z-index:-1;
      opacity:0.3;
      animation:borderRotate 8s linear infinite;
    }
    
    @keyframes borderGlow{
      0%,100%{border-color:var(--border-glow)}
      25%{border-color:var(--accent)}
      50%{border-color:var(--good)}
      75%{border-color:var(--combo)}
    }
    @keyframes borderRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    .panel-title{
      font-size:0.8rem;
      color:var(--accent);
      margin-bottom:12px;
      text-align:center;
      text-shadow:2px 2px 0 #000;
      position:relative;
    }
    
    .panel-title::after{
      content:'';
      position:absolute;
      bottom:-5px;
      left:50%;
      transform:translateX(-50%);
      width:50px;
      height:2px;
      background:linear-gradient(90deg, transparent, var(--accent), transparent);
    }
    
    /* Enhanced mission briefing */
    #missionBrief{
      font-size:0.55rem;
      line-height:1.8;
      color:var(--mission);
      font-family:'JetBrains Mono',monospace;
    }
    
    .mission-stat{
      display:flex;
      justify-content:space-between;
      margin:8px 0;
      padding:5px;
      background:rgba(255,255,255,0.05);
      border-radius:5px;
      transition:background 0.3s;
    }
    
    .mission-stat:hover{
      background:rgba(255,255,255,0.1);
    }
    
    /* Enhanced mini map with radar effect */
    #miniMap{
      height:150px;
      background:
        radial-gradient(circle at center, rgba(0,255,0,0.1) 20%, transparent 20%),
        radial-gradient(circle at center, rgba(0,255,0,0.05) 40%, transparent 40%),
        radial-gradient(circle at center, rgba(0,255,0,0.03) 60%, transparent 60%),
        radial-gradient(ellipse at center, rgba(0,50,0,0.8), rgba(0,0,0,0.9));
      border:2px solid #0f0;
      position:relative;
      overflow:hidden;
      border-radius:50%;
    }
    
    .radarSweep{
      position:absolute;
      top:50%;
      left:50%;
      width:2px;
      height:75px;
      background:linear-gradient(to bottom, #0f0, transparent);
      transform-origin:bottom center;
      animation:radarSweep 4s linear infinite;
    }
    
    @keyframes radarSweep{
      from{transform:translate(-50%, -100%) rotate(0deg)}
      to{transform:translate(-50%, -100%) rotate(360deg)}
    }
    
    .miniMapDot{
      position:absolute;
      width:6px;
      height:6px;
      border-radius:50%;
      animation:mapPing 2s infinite;
      z-index:2;
    }
    
    .miniMapDot.asteroid{background:#f00;box-shadow:0 0 10px #f00}
    .miniMapDot.powerup{background:#f0f;box-shadow:0 0 10px #f0f}
    .miniMapDot.ship{background:#0f0;box-shadow:0 0 10px #0f0}
    
    @keyframes mapPing{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.5;transform:scale(1.5)}
    }
    
    /* Enhanced formula reference with categories */
    #formulaRef{
      font-size:0.5rem;
      line-height:1.8;
      max-height:200px;
      overflow-y:auto;
    }
    
    .formula{
      background:rgba(255,255,255,0.1);
      padding:8px;
      margin:8px 0;
      border-left:4px solid var(--accent);
      font-family:'JetBrains Mono',monospace;
      border-radius:5px;
      transition:all 0.3s;
      cursor:pointer;
    }
    
    .formula:hover{
      background:rgba(255,255,255,0.2);
      transform:translateX(5px);
    }
    
    .formula.algebra{border-left-color:var(--algebra)}
    .formula.geometry{border-left-color:var(--geometry)}
    .formula.calculus{border-left-color:var(--calculus)}
    .formula.trigonometry{border-left-color:var(--trigonometry)}
    
    /* Learning analytics section */
    #learningAnalytics{
      font-size:0.5rem;
    }
    
    .analytics-chart{
      height:80px;
      background:rgba(0,0,0,0.3);
      margin:10px 0;
      border:1px solid var(--border-glow);
      border-radius:5px;
      position:relative;
      overflow:hidden;
    }
    
    .chart-bar{
      position:absolute;
      bottom:0;
      width:8px;
      background:linear-gradient(to top, var(--bad), var(--accent), var(--good));
      margin:1px;
      border-radius:2px 2px 0 0;
      transition:height 0.5s ease;
    }

    /* =========[ ADVANCED HUD SYSTEM ]========= */
    #hud{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:15px;
      pointer-events:none;
      z-index:5;
    }
    
    #hudTop{
      display:flex;
      gap:25px;
      font-size:0.8rem;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
    }
    
    #question{
      font-size:1.2rem;
      color:var(--accent);
      background:rgba(0,0,0,0.9);
      padding:12px 25px;
      border:3px solid var(--accent);
      border-radius:8px;
      min-width:300px;
      text-align:center;
      position:relative;
      font-family:'JetBrains Mono',monospace;
      box-shadow:0 0 20px rgba(255,202,58,0.3);
    }
    
    #question::before{
      content:'';
      position:absolute;
      top:-3px;
      left:-3px;
      right:-3px;
      bottom:-3px;
      background:linear-gradient(45deg, var(--accent), var(--good), var(--accent));
      border-radius:8px;
      z-index:-1;
      animation:questionGlow 2s ease-in-out infinite;
    }
    
    @keyframes questionGlow{
      0%,100%{opacity:0.5}
      50%{opacity:1}
    }
    
    #score,#lives,#combo{
      min-width:130px;
      text-align:center;
      background:rgba(0,0,0,0.8);
      padding:10px;
      border-radius:8px;
      border:2px solid var(--border-glow);
      position:relative;
      backdrop-filter:blur(5px);
    }
    
    #combo{
      color:var(--combo);
      border-color:var(--combo);
    }
    
    #comboMeter{
      width:200px;
      height:10px;
      background:rgba(0,255,136,0.2);
      border:2px solid var(--combo);
      border-radius:10px;
      margin-top:8px;
      overflow:hidden;
      position:relative;
    }
    
    #comboFill{
      height:100%;
      background:linear-gradient(90deg, var(--combo), var(--accent));
      width:0%;
      transition:width 0.3s;
      border-radius:8px;
      position:relative;
    }
    
    #comboFill::after{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation:comboShine 2s ease-in-out infinite;
    }
    
    @keyframes comboShine{
      0%{left:-100%}
      100%{left:100%}
    }
    
    /* Enhanced timer and streak displays */
    #timerDisplay{
      position:absolute;
      top:10px;
      right:10px;
      background:rgba(0,0,0,0.8);
      padding:10px;
      border:2px solid var(--warning);
      border-radius:8px;
      font-size:0.8rem;
      color:var(--warning);
    }
    
    #streakDisplay{
      position:absolute;
      top:60px;
      right:10px;
      background:rgba(0,0,0,0.8);
      padding:8px;
      border:2px solid var(--success);
      border-radius:8px;
      font-size:0.7rem;
      color:var(--success);
    }
    
    /* Enhanced wave indicator with progress */
    #waveIndicator{
      position:absolute;
      top:80px;
      left:50%;
      transform:translateX(-50%);
      font-size:0.8rem;
      color:var(--mission);
      background:rgba(0,0,0,0.9);
      padding:8px 20px;
      border-radius:25px;
      border:3px solid var(--mission);
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .wave-progress{
      width:100px;
      height:6px;
      background:rgba(255,255,255,0.2);
      border-radius:3px;
      overflow:hidden;
    }
    
    .wave-progress-fill{
      height:100%;
      background:var(--mission);
      width:0%;
      transition:width 0.5s;
      border-radius:3px;
    }
    
    /* Enhanced speed control with visual feedback */
    #speedControl{
      position:absolute;
      top:140px;
      right:20px;
      background:rgba(0,0,0,0.9);
      padding:15px;
      border:3px solid var(--accent);
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:180px;
    }
    
    #speedSlider{
      width:150px;
      -webkit-appearance:none;
      height:8px;
      background:rgba(255,255,255,0.2);
      outline:none;
      border-radius:4px;
      position:relative;
    }
    
    #speedSlider::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:20px;
      height:20px;
      background:var(--accent);
      cursor:pointer;
      border-radius:50%;
      box-shadow:0 0 10px var(--accent);
    }
    
    .speed-presets{
      display:flex;
      gap:5px;
      margin-top:5px;
    }
    
    .speed-preset{
      padding:3px 8px;
      background:rgba(255,255,255,0.1);
      border:1px solid var(--border-glow);
      border-radius:4px;
      font-size:0.5rem;
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .speed-preset:hover{
      background:rgba(255,255,255,0.2);
      border-color:var(--accent);
    }

    /* =========[ ADVANCED PLAYER SHIP SYSTEM ]========= */
    #ship{
      position:absolute;
      bottom:15px;
      left:50%;
      width:var(--ship-size);
      height:var(--ship-size);
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index:4;
      filter:drop-shadow(0 0 20px var(--good));
    }
    
    .ship-body{
      width:100%;
      height:100%;
      background:linear-gradient(135deg, var(--good) 0%, #1a8a7f 100%);
      clip-path:polygon(50% 0%, 100% 100%, 50% 85%, 0% 100%);
      position:relative;
      animation:shipHover 2s ease-in-out infinite;
    }
    
    @keyframes shipHover{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-3px)}
    }
    
    .ship-window{
      position:absolute;
      top:20%;
      left:50%;
      transform:translateX(-50%);
      width:30%;
      height:25%;
      background:radial-gradient(ellipse at center, #6cf, #048);
      border-radius:50%;
      animation:windowPulse 3s ease-in-out infinite;
    }
    
    @keyframes windowPulse{
      0%,100%{box-shadow:0 0 5px #6cf}
      50%{box-shadow:0 0 15px #6cf, 0 0 25px #048}
    }
    
    .ship-engine{
      position:absolute;
      bottom:-35px;
      left:50%;
      transform:translateX(-50%);
      width:45px;
      height:45px;
    }
    
    .engine-flame{
      width:100%;
      height:100%;
      background:radial-gradient(ellipse at center top, #ff0, #f80, #f40, transparent);
      animation:enginePulse 0.15s infinite, engineFlicker 0.05s infinite;
      filter:blur(1px);
      border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;
    }
    
    @keyframes enginePulse{
      0%,100%{transform:scaleY(1);opacity:0.9}
      50%{transform:scaleY(1.3);opacity:1}
    }
    
    @keyframes engineFlicker{
      0%,100%{filter:blur(1px) brightness(1)}
      50%{filter:blur(2px) brightness(1.2)}
    }
    
    /* Enhanced ship states */
    #ship.boosted{
      transform:scale(1.1);
      filter:drop-shadow(0 0 30px var(--combo));
    }
    
    #ship.boosted .engine-flame{
      background:radial-gradient(ellipse at center top, #0ff, #0af, #08f, transparent);
      animation-duration:0.1s;
    }
    
    #ship.shielded::before{
      content:'';
      position:absolute;
      top:-25px;
      left:-25px;
      right:-25px;
      bottom:-25px;
      border:4px solid var(--powerup);
      border-radius:50%;
      animation:shieldRotate 1.5s linear infinite, shieldPulse 2s ease-in-out infinite;
      box-shadow:0 0 20px var(--powerup);
    }
    
    @keyframes shieldRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    @keyframes shieldPulse{
      0%,100%{opacity:0.8;transform:scale(1)}
      50%{opacity:1;transform:scale(1.05)}
    }
    
    #ship.invulnerable{
      animation:invulnerableFlash 0.2s infinite;
    }
    
    @keyframes invulnerableFlash{
      0%,100%{opacity:1}
      50%{opacity:0.5}
    }

    /* =========[ ADVANCED ASTEROID SYSTEM ]========= */
    .asteroid{
      position:absolute;
      top:-150px;
      width:100px;
      height:100px;
      cursor:pointer;
      animation:fall linear forwards;
      filter:drop-shadow(0 0 15px rgba(0,0,0,0.8));
      transition:transform 0.2s ease;
    }
    
    .asteroid:hover{
      transform:scale(1.05);
    }
    
    .asteroid-body{
      width:100%;
      height:100%;
      background:radial-gradient(circle at 30% 30%, #d9a874 0%, var(--asteroid) 60%);
      border-radius:45% 55% 50% 50%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#000;
      font-size:1.2rem;
      font-weight:bold;
      position:relative;
      animation:asteroidRotate 4s linear infinite;
      border:2px solid rgba(255,255,255,0.1);
      box-shadow:inset 0 0 20px rgba(0,0,0,0.3);
    }
    
    .asteroid-crater{
      position:absolute;
      width:20%;
      height:20%;
      background:rgba(0,0,0,0.3);
      border-radius:50%;
      top:20%;
      right:25%;
      box-shadow:inset 0 0 5px rgba(0,0,0,0.5);
    }
    
    .asteroid-crater:nth-child(2){
      width:15%;
      height:15%;
      top:60%;
      left:15%;
    }
    
    @keyframes fall{from{top:-150px}to{top:110vh}}
    @keyframes asteroidRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    
    /* Enhanced asteroid types with unique visuals */
    .asteroid.type-algebra .asteroid-body{
      background:linear-gradient(135deg, var(--algebra), #2aa198);
      color:#fff;
      font-family:'JetBrains Mono',monospace;
      border-color:var(--algebra);
      box-shadow:0 0 20px var(--algebra);
    }
    
    .asteroid.type-geometry .asteroid-body{
      background:linear-gradient(135deg, var(--geometry), #6bc5b7);
      color:#000;
      border-radius:20%;
      transform-origin:center;
      animation:geometryRotate 3s linear infinite;
    }
    
    @keyframes geometryRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    .asteroid.type-fraction .asteroid-body{
      background:linear-gradient(135deg, var(--fraction), #d66767);
      color:#fff;
      border-color:var(--fraction);
      position:relative;
    }
    
    .asteroid.type-fraction .asteroid-body::after{
      content:'';
      position:absolute;
      top:50%;
      left:10%;
      right:10%;
      height:2px;
      background:#fff;
      transform:translateY(-50%);
    }
    
    .asteroid.type-calculus .asteroid-body{
      background:linear-gradient(135deg, var(--calculus), #8e44ad);
      color:#fff;
      border-color:var(--calculus);
      animation:calculusPulse 2s ease-in-out infinite;
    }
    
    @keyframes calculusPulse{
      0%,100%{box-shadow:0 0 10px var(--calculus)}
      50%{box-shadow:0 0 30px var(--calculus), 0 0 50px var(--calculus)}
    }
    
    .asteroid.type-trigonometry .asteroid-body{
      background:linear-gradient(135deg, var(--trigonometry), #e67e22);
      color:#000;
      border-color:var(--trigonometry);
      border-radius:50%;
    }
    
    .asteroid.type-statistics .asteroid-body{
      background:linear-gradient(135deg, var(--statistics), #138d75);
      color:#fff;
      border-color:var(--statistics);
    }
    
    .asteroid.type-boss{
      width:180px;
      height:180px;
      animation-duration:10s !important;
    }
    
    .asteroid.type-boss .asteroid-body{
      background:radial-gradient(circle at center, #f00, #800, #400, #200);
      animation:bossPulse 1s infinite, bossRotate 8s linear infinite;
      border:4px solid #f00;
      box-shadow:0 0 40px #f00, inset 0 0 20px rgba(0,0,0,0.5);
      font-size:1.5rem;
    }
    
    @keyframes bossPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    @keyframes bossRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    /* Special effects for asteroids */
    .asteroid.critical{
      animation:criticalFlash 0.5s infinite;
    }
    
    @keyframes criticalFlash{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(2)}
    }
    
    .asteroid.frozen{
      filter:hue-rotate(180deg) brightness(0.7);
      animation-play-state:paused;
    }

    /* =========[ ENHANCED POWER-UP SYSTEM ]========= */
    .powerup{
      position:absolute;
      top:-80px;
      width:70px;
      height:70px;
      cursor:pointer;
      animation:fall linear forwards, powerupFloat 2s ease-in-out infinite;
      filter:drop-shadow(0 0 20px var(--powerup));
    }
    
    @keyframes powerupFloat{
      0%,100%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-15px) rotate(10deg)}
    }
    
    .powerup-body{
      width:100%;
      height:100%;
      background:var(--powerup);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2rem;
      border-radius:20px;
      border:4px solid #fff;
      position:relative;
      animation:powerupGlow 1.5s infinite;
      box-shadow:0 0 30px var(--powerup);
    }
    
    .powerup-ring{
      position:absolute;
      top:-15px;
      left:-15px;
      right:-15px;
      bottom:-15px;
      border:3px solid var(--powerup);
      border-radius:50%;
      animation:ringExpand 2s infinite;
    }
    
    .powerup-ring:nth-child(2){
      animation-delay:0.5s;
      border-width:2px;
    }
    
    .powerup-ring:nth-child(3){
      animation-delay:1s;
      border-width:1px;
    }
    
    @keyframes powerupGlow{
      0%,100%{box-shadow:0 0 30px var(--powerup)}
      50%{box-shadow:0 0 60px var(--powerup), 0 0 90px var(--powerup)}
    }
    
    @keyframes ringExpand{
      0%{transform:scale(0.8);opacity:1}
      100%{transform:scale(2);opacity:0}
    }
    
    /* Special powerup types with unique effects */
    .powerup.type-mega .powerup-body{
      background:linear-gradient(135deg, #ff006e, #8338ec, #3a0ca3);
      animation:rainbow 2s linear infinite, megaPulse 1s ease-in-out infinite;
      font-size:2.5rem;
    }
    
    @keyframes rainbow{
      0%{filter:hue-rotate(0deg)}
      100%{filter:hue-rotate(360deg)}
    }
    
    @keyframes megaPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.2)}
    }
    
    .powerup.type-legendary .powerup-body{
      background:radial-gradient(circle, var(--legendary), var(--premium));
      animation:legendaryShine 3s ease-in-out infinite;
      border-color:var(--legendary);
    }
    
    @keyframes legendaryShine{
      0%,100%{box-shadow:0 0 30px var(--legendary)}
      50%{box-shadow:0 0 60px var(--legendary), 0 0 90px var(--premium)}
    }
    
    .powerup.type-rare .powerup-body{
      background:linear-gradient(45deg, var(--premium), var(--accent));
      animation:rareGlow 2s ease-in-out infinite;
    }
    
    @keyframes rareGlow{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.5)}
    }

    /* =========[ ENHANCED SCREEN SYSTEMS ]========= */
    #startScreen,#gameOver,#pauseScreen,#settingsScreen,#tutorialScreen,
    #shopScreen,#achievementScreen,#leaderboardScreen,#analyticsScreen,
    #helpScreen,#customizeScreen,#multiplayerScreen{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.95);
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:20px;
      z-index:20;
      backdrop-filter:blur(15px);
      padding:20px;
      overflow-y:auto;
      animation:screenFadeIn 0.5s ease-out;
    }
    
    @keyframes screenFadeIn{
      from{opacity:0;transform:scale(0.9)}
      to{opacity:1;transform:scale(1)}
    }
    
    #startScreen:not([hidden]),#gameOver:not([hidden]),
    #pauseScreen:not([hidden]),#settingsScreen:not([hidden]),
    #tutorialScreen:not([hidden]),#shopScreen:not([hidden]),
    #achievementScreen:not([hidden]),#leaderboardScreen:not([hidden]),
    #analyticsScreen:not([hidden]),#helpScreen:not([hidden]),
    #customizeScreen:not([hidden]),#multiplayerScreen:not([hidden]){
      display:flex;
    }
    
    h1{
      font-size:2.5rem;
      color:var(--good);
      text-shadow:4px 4px 0 #000, 0 0 20px var(--good);
      animation:titlePulse 3s ease-in-out infinite;
      position:relative;
    }
    
    h1::after{
      content:'';
      position:absolute;
      bottom:-10px;
      left:50%;
      transform:translateX(-50%);
      width:80%;
      height:3px;
      background:linear-gradient(90deg, transparent, var(--good), transparent);
      animation:titleUnderline 2s ease-in-out infinite;
    }
    
    @keyframes titlePulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.03)}
    }
    
    @keyframes titleUnderline{
      0%,100%{opacity:0.5;transform:translateX(-50%) scaleX(0.5)}
      50%{opacity:1;transform:translateX(-50%) scaleX(1)}
    }
    
    h2{
      font-size:1.3rem;
      color:var(--accent);
      margin:15px 0;
      text-shadow:2px 2px 0 #000;
    }

    /* Enhanced button system */
    button{
      font-family:'Press Start 2P',monospace;
      background:linear-gradient(135deg, var(--accent), #e5b027);
      border:none;
      padding:15px 30px;
      font-size:0.8rem;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 6px 0 #b8901a, 0 10px 20px rgba(0,0,0,0.4);
      position:relative;
      top:0;
      text-transform:uppercase;
      letter-spacing:1px;
      border-radius:8px;
      overflow:hidden;
    }
    
    button::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition:left 0.5s;
    }
    
    button:hover::before{
      left:100%;
    }
    
    button:hover{
      transform:translateY(2px);
      box-shadow:0 4px 0 #b8901a, 0 8px 15px rgba(0,0,0,0.4);
      background:linear-gradient(135deg, #f5d142, var(--accent));
    }
    
    button:active{
      transform:translateY(5px);
      box-shadow:0 1px 0 #b8901a, 0 2px 5px rgba(0,0,0,0.3);
    }
    
    button:focus{
      outline:3px dashed #fff;
      outline-offset:5px;
    }
    
    button.secondary{
      background:linear-gradient(135deg, #666, #444);
      box-shadow:0 6px 0 #333, 0 10px 20px rgba(0,0,0,0.4);
    }
    
    button.secondary:hover{
      background:linear-gradient(135deg, #777, #555);
      box-shadow:0 4px 0 #333, 0 8px 15px rgba(0,0,0,0.4);
    }
    
    button.danger{
      background:linear-gradient(135deg, var(--bad), #c41929);
      box-shadow:0 6px 0 #8a1020, 0 10px 20px rgba(0,0,0,0.4);
    }
    
    button.premium{
      background:linear-gradient(135deg, var(--premium), var(--legendary));
      box-shadow:0 6px 0 #b8901a, 0 10px 20px rgba(212,175,55,0.4);
      animation:premiumGlow 2s ease-in-out infinite;
    }
    
    @keyframes premiumGlow{
      0%,100%{box-shadow:0 6px 0 #b8901a, 0 10px 20px rgba(212,175,55,0.4)}
      50%{box-shadow:0 6px 0 #b8901a, 0 10px 30px rgba(212,175,55,0.6), 0 0 40px var(--premium)}
    }

    /* Enhanced game mode selection */
    .modeGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin:30px 0;
      max-width:1000px;
    }
    
    .modeCard{
      background:rgba(255,255,255,0.1);
      border:3px solid var(--accent);
      padding:25px;
      cursor:pointer;
      transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
      border-radius:15px;
      backdrop-filter:blur(10px);
    }
    
    .modeCard::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition:left 0.6s;
    }
    
    .modeCard:hover::before{
      left:100%;
    }
    
    .modeCard:hover{
      background:rgba(255,255,255,0.2);
      transform:scale(1.05) translateY(-5px);
      border-color:var(--good);
      box-shadow:0 10px 30px rgba(0,0,0,0.3), 0 0 40px var(--good);
    }
    
    .modeCard.selected{
      border-color:var(--combo);
      background:rgba(0,255,136,0.15);
      transform:scale(1.02);
    }
    
    .modeCard.locked{
      opacity:0.5;
      cursor:not-allowed;
      filter:grayscale(1);
    }
    
    .modeCard.locked::after{
      content:'🔒';
      position:absolute;
      top:15px;
      right:15px;
      font-size:2rem;
      animation:lockShake 2s ease-in-out infinite;
    }
    
    @keyframes lockShake{
      0%,100%{transform:rotate(0deg)}
      10%{transform:rotate(5deg)}
      20%{transform:rotate(-5deg)}
      30%{transform:rotate(5deg)}
      40%{transform:rotate(0deg)}
    }
    
    .modeCard h3{
      font-size:1.1rem;
      color:var(--good);
      margin-bottom:15px;
      text-shadow:2px 2px 0 #000;
    }
    
    .modeCard p{
      font-size:0.6rem;
      line-height:1.6;
      margin-bottom:10px;
    }
    
    .modeCard .difficulty{
      display:flex;
      justify-content:space-between;
      margin-top:15px;
      font-size:0.5rem;
    }
    
    .difficulty-stars{
      color:var(--accent);
    }

    /* Enhanced shop system */
    .shopGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:20px;
      max-width:900px;
      margin:20px 0;
    }
    
    .shopItem{
      background:rgba(255,255,255,0.1);
      border:3px solid var(--border-glow);
      padding:20px;
      cursor:pointer;
      transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      border-radius:12px;
      backdrop-filter:blur(10px);
    }
    
    .shopItem:hover{
      background:rgba(255,255,255,0.2);
      border-color:var(--accent);
      transform:translateY(-5px);
      box-shadow:0 10px 25px rgba(0,0,0,0.3);
    }
    
    .shopItem.purchased{
      background:rgba(0,255,136,0.2);
      border-color:var(--combo);
      position:relative;
    }
    
    .shopItem.purchased::after{
      content:'✓';
      position:absolute;
      top:10px;
      right:10px;
      color:var(--combo);
      font-size:1.5rem;
      font-weight:bold;
    }
    
    .shopItem .icon{
      font-size:3rem;
      margin-bottom:10px;
    }
    
    .shopItem .name{
      font-size:0.7rem;
      margin-bottom:8px;
      color:var(--accent);
    }
    
    .shopItem .description{
      font-size:0.5rem;
      line-height:1.4;
      margin-bottom:10px;
      opacity:0.8;
    }
    
    .shopItem .price{
      color:var(--premium);
      font-size:0.6rem;
      font-weight:bold;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
    }
    
    .shopItem .price::before{
      content:'💰';
    }

    /* Enhanced achievement system */
    .achievementGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:15px;
      max-width:1000px;
      margin:20px 0;
    }
    
    .achievementCard{
      background:rgba(255,255,255,0.1);
      border:2px solid var(--border-glow);
      padding:15px;
      position:relative;
      transition:all 0.4s ease;
      border-radius:10px;
      backdrop-filter:blur(5px);
      cursor:pointer;
    }
    
    .achievementCard:hover{
      background:rgba(255,255,255,0.15);
      transform:translateY(-3px);
      box-shadow:0 5px 15px rgba(0,0,0,0.3);
    }
    
    .achievementCard.unlocked{
      background:rgba(0,255,136,0.2);
      border-color:var(--combo);
      animation:achievementGlow 3s ease-in-out infinite;
    }
    
    @keyframes achievementGlow{
      0%,100%{box-shadow:0 0 10px var(--combo)}
      50%{box-shadow:0 0 20px var(--combo), 0 0 30px var(--combo)}
    }
    
    .achievementCard .icon{
      font-size:2.5rem;
      margin-bottom:8px;
      filter:grayscale(1);
      transition:filter 0.3s;
    }
    
    .achievementCard.unlocked .icon{
      filter:grayscale(0);
      animation:iconBounce 2s ease-in-out infinite;
    }
    
    @keyframes iconBounce{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    .achievementCard .name{
      font-size:0.55rem;
      color:var(--accent);
      margin-bottom:5px;
      line-height:1.3;
    }
    
    .achievementCard .description{
      font-size:0.4rem;
      opacity:0.7;
      line-height:1.2;
      margin-bottom:8px;
    }
    
    .achievementCard .progress{
      width:100%;
      height:6px;
      background:rgba(255,255,255,0.2);
      margin-top:8px;
      border-radius:3px;
      overflow:hidden;
    }
    
    .achievementCard .progressFill{
      height:100%;
      background:linear-gradient(90deg, var(--combo), var(--accent));
      transition:width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius:3px;
    }

    /* Enhanced statistics display */
    .stats{
      background:rgba(0,0,0,0.6);
      padding:25px;
      border:3px solid var(--accent);
      border-radius:15px;
      font-size:0.7rem;
      line-height:2;
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:15px;
      text-align:left;
      backdrop-filter:blur(10px);
      max-width:600px;
    }
    
    .stats-full{
      grid-template-columns:repeat(3, 1fr);
      max-width:900px;
    }
    
    .stat-item{
      display:flex;
      justify-content:space-between;
      padding:8px 12px;
      background:rgba(255,255,255,0.05);
      border-radius:8px;
      border-left:4px solid var(--accent);
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    
    .stat-item::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transform:translateX(-100%);
      transition:transform 0.5s;
    }
    
    .stat-item:hover{
      background:rgba(255,255,255,0.1);
      transform:translateX(5px);
    }
    
    .stat-item:hover::before{
      transform:translateX(100%);
    }
    
    .stat-label{
      color:var(--text);
      font-weight:bold;
    }
    
    .stat-value{
      color:var(--accent);
      font-family:'JetBrains Mono',monospace;
      font-weight:bold;
    }

    /* Tutorial enhancement */
    .tutorialSlide{
      max-width:700px;
      background:rgba(0,0,0,0.8);
      padding:35px;
      border:3px solid var(--accent);
      border-radius:15px;
      backdrop-filter:blur(10px);
      position:relative;
    }
    
    .tutorialSlide::before{
      content:'';
      position:absolute;
      top:-3px;
      left:-3px;
      right:-3px;
      bottom:-3px;
      background:linear-gradient(45deg, var(--accent), var(--good), var(--accent));
      border-radius:15px;
      z-index:-1;
      animation:tutorialBorder 4s linear infinite;
    }
    
    @keyframes tutorialBorder{
      0%{filter:hue-rotate(0deg)}
      100%{filter:hue-rotate(360deg)}
    }
    
    .tutorialSlide h3{
      color:var(--good);
      margin-bottom:20px;
      font-size:1.2rem;
      text-shadow:2px 2px 0 #000;
    }
    
    .tutorialSlide p{
      font-size:0.65rem;
      line-height:2;
      margin-bottom:15px;
    }
    
    .tutorialSlide .highlight{
      background:rgba(255,202,58,0.2);
      padding:2px 5px;
      border-radius:3px;
      color:var(--accent);
    }
    
    .tutorialNav{
      display:flex;
      gap:20px;
      margin-top:25px;
      justify-content:center;
    }
    
    .tutorial-progress{
      display:flex;
      gap:8px;
      margin-top:15px;
      justify-content:center;
    }
    
    .progress-dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transition:background 0.3s;
    }
    
    .progress-dot.active{
      background:var(--accent);
      animation:dotPulse 1s ease-in-out infinite;
    }
    
    @keyframes dotPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.2)}
    }

    /* Enhanced leaderboard */
    .leaderboard{
      background:rgba(0,0,0,0.8);
      padding:25px;
      border:3px solid var(--accent);
      border-radius:15px;
      max-width:700px;
      width:100%;
      backdrop-filter:blur(10px);
    }
    
    .leaderboardEntry{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 15px;
      margin:8px 0;
      background:rgba(255,255,255,0.05);
      border-left:4px solid transparent;
      border-radius:8px;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    
    .leaderboardEntry::before{
      content:'';
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:0;
      background:linear-gradient(90deg, var(--accent), transparent);
      transition:width 0.3s;
    }
    
    .leaderboardEntry:hover{
      background:rgba(255,255,255,0.1);
      border-left-color:var(--accent);
      transform:translateX(5px);
    }
    
    .leaderboardEntry:hover::before{
      width:100%;
    }
    
    .leaderboardEntry.current{
      background:rgba(255,202,58,0.2);
      border-left-color:var(--accent);
      animation:currentPlayerGlow 2s ease-in-out infinite;
    }
    
    @keyframes currentPlayerGlow{
      0%,100%{box-shadow:0 0 10px rgba(255,202,58,0.3)}
      50%{box-shadow:0 0 20px rgba(255,202,58,0.5)}
    }
    
    .leaderboardEntry .rank{
      color:var(--combo);
      font-family:'JetBrains Mono',monospace;
      min-width:60px;
      font-weight:bold;
      font-size:0.9rem;
    }
    
    .leaderboardEntry .rank.gold{color:var(--premium)}
    .leaderboardEntry .rank.silver{color:#c0c0c0}
    .leaderboardEntry .rank.bronze{color:#cd7f32}
    
    .leaderboardEntry .name{
      flex:1;
      color:var(--text);
      margin:0 15px;
      font-size:0.8rem;
    }
    
    .leaderboardEntry .score{
      color:var(--accent);
      font-family:'JetBrains Mono',monospace;
      font-weight:bold;
      font-size:0.8rem;
    }
    
    .leaderboardEntry .extras{
      font-size:0.6rem;
      opacity:0.7;
      margin-left:10px;
    }

    /* =========[ ENHANCED EFFECTS SYSTEM ]========= */
    .flash{animation:flash 0.5s}
    @keyframes flash{
      0%,100%{filter:brightness(1)}
      25%{filter:brightness(3)}
      50%{filter:brightness(1)}
      75%{filter:brightness(2)}
    }
    
    .shake{animation:shake 0.6s}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      10%{transform:translateX(-10px)}
      20%{transform:translateX(10px)}
      30%{transform:translateX(-8px)}
      40%{transform:translateX(8px)}
      50%{transform:translateX(-6px)}
      60%{transform:translateX(6px)}
      70%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
      90%{transform:translateX(-2px)}
    }
    
    .screenShake{
      animation:screenShake 0.5s ease-in-out;
    }
    
    @keyframes screenShake{
      0%{transform:translate(0)}
      10%{transform:translate(-2px, -1px)}
      20%{transform:translate(2px, 1px)}
      30%{transform:translate(-1px, 2px)}
      40%{transform:translate(1px, -1px)}
      50%{transform:translate(-1px, 1px)}
      60%{transform:translate(2px, -2px)}
      70%{transform:translate(-2px, 2px)}
      80%{transform:translate(1px, -2px)}
      90%{transform:translate(-1px, 1px)}
      100%{transform:translate(0)}
    }
    
    /* Enhanced particle system */
    .particle{
      position:absolute;
      width:8px;
      height:8px;
      background:var(--accent);
      animation:particle 2s ease-out forwards;
      pointer-events:none;
      z-index:15;
      border-radius:50%;
    }
    
    @keyframes particle{
      0%{
        transform:translate(0, 0) scale(1) rotate(0deg);
        opacity:1;
      }
      100%{
        transform:translate(var(--tx), var(--ty)) scale(0) rotate(720deg);
        opacity:0;
      }
    }
    
    .particle.trail{
      width:4px;
      height:20px;
      border-radius:0;
      background:linear-gradient(to bottom, transparent, var(--accent), transparent);
      animation:trailFade 1s ease-out forwards;
    }
    
    @keyframes trailFade{
      0%{opacity:1;transform:translateY(0)}
      100%{opacity:0;transform:translateY(var(--ty, -100px))}
    }
    
    .particle.spark{
      width:3px;
      height:3px;
      background:radial-gradient(circle, #fff, var(--accent));
      box-shadow:0 0 10px var(--accent);
      animation:sparkle 1.5s ease-out forwards;
    }
    
    @keyframes sparkle{
      0%{opacity:1;transform:scale(1)}
      50%{opacity:0.8;transform:scale(1.5)}
      100%{opacity:0;transform:scale(0)}
    }
    
    /* Enhanced weather effects */
    .meteorShower{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:1;
    }
    
    .meteor{
      position:absolute;
      width:4px;
      height:4px;
      background:radial-gradient(circle, #fff, #ffa500);
      border-radius:50%;
      box-shadow:0 0 20px #ffa500;
      animation:meteorFall 3s linear infinite;
    }
    
    @keyframes meteorFall{
      0%{
        transform:translateX(-50px) translateY(-50px);
        opacity:0;
      }
      10%{opacity:1}
      90%{opacity:1}
      100%{
        transform:translateX(100vw) translateY(100vh);
        opacity:0;
      }
    }
    
    /* Enhanced notification system */
    .notification{
      position:fixed;
      top:20px;
      right:20px;
      background:linear-gradient(135deg, var(--good), #1a8a7f);
      color:#000;
      padding:15px 25px;
      font-size:0.7rem;
      animation:notificationSlide 5s forwards;
      z-index:25;
      border:3px solid #000;
      border-radius:10px;
      box-shadow:0 5px 20px rgba(0,0,0,0.6);
      max-width:350px;
      backdrop-filter:blur(10px);
    }
    
    @keyframes notificationSlide{
      0%{transform:translateX(450px);opacity:0}
      15%{transform:translateX(0);opacity:1}
      85%{transform:translateX(0);opacity:1}
      100%{transform:translateX(450px);opacity:0}
    }
    
    .notification.achievement{
      background:linear-gradient(135deg, var(--combo), #00cc6f);
      border-color:var(--combo);
      animation:achievementNotification 6s forwards;
    }
    
    @keyframes achievementNotification{
      0%{transform:translateX(450px) scale(0.8);opacity:0}
      15%{transform:translateX(0) scale(1.05);opacity:1}
      20%{transform:translateX(0) scale(1);opacity:1}
      80%{transform:translateX(0) scale(1);opacity:1}
      100%{transform:translateX(450px) scale(0.8);opacity:0}
    }
    
    .notification.warning{
      background:linear-gradient(135deg, var(--bad), #b91c2c);
      color:#fff;
      border-color:var(--bad);
    }
    
    .notification.info{
      background:linear-gradient(135deg, var(--info), #2980b9);
      color:#fff;
      border-color:var(--info);
    }
    
    .notification.premium{
      background:linear-gradient(135deg, var(--premium), var(--legendary));
      color:#000;
      border-color:var(--premium);
      animation:premiumNotification 6s forwards;
    }
    
    @keyframes premiumNotification{
      0%{transform:translateX(450px);opacity:0;filter:brightness(1)}
      15%{transform:translateX(0);opacity:1;filter:brightness(1.2)}
      80%{transform:translateX(0);opacity:1;filter:brightness(1)}
      100%{transform:translateX(450px);opacity:0;filter:brightness(1)}
    }

    /* Enhanced wave transition */
    .waveTransition{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      font-size:3.5rem;
      color:var(--mission);
      text-shadow:4px 4px 0 #000, 0 0 30px var(--mission);
      animation:waveAnnounce 4s forwards;
      z-index:30;
      pointer-events:none;
      text-align:center;
    }
    
    @keyframes waveAnnounce{
      0%{transform:translate(-50%, -50%) scale(0) rotate(-180deg);opacity:0}
      25%{transform:translate(-50%, -50%) scale(1.3) rotate(0deg);opacity:1}
      75%{transform:translate(-50%, -50%) scale(1) rotate(0deg);opacity:1}
      100%{transform:translate(-50%, -50%) scale(0.7) rotate(180deg);opacity:0}
    }
    
    .waveTransition .subtitle{
      font-size:1rem;
      margin-top:20px;
      animation:subtitleFade 4s forwards;
    }
    
    @keyframes subtitleFade{
      0%,25%{opacity:0;transform:translateY(20px)}
      50%{opacity:1;transform:translateY(0)}
      75%{opacity:1;transform:translateY(0)}
      100%{opacity:0;transform:translateY(-20px)}
    }

    /* Enhanced boss warning system */
    .bossWarning{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:
        radial-gradient(ellipse at center, transparent 0%, rgba(255,0,0,0.3) 100%),
        linear-gradient(45deg, transparent 48%, rgba(255,0,0,0.1) 50%, transparent 52%);
      animation:bossWarningPulse 1s infinite, bossWarningRotate 10s linear infinite;
      pointer-events:none;
      z-index:10;
    }
    
    @keyframes bossWarningPulse{
      0%,100%{opacity:0}
      50%{opacity:1}
    }
    
    @keyframes bossWarningRotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    .bossHealthBar{
      position:fixed;
      top:100px;
      left:50%;
      transform:translateX(-50%);
      width:400px;
      height:20px;
      background:rgba(0,0,0,0.8);
      border:3px solid #f00;
      border-radius:15px;
      z-index:15;
      overflow:hidden;
    }
    
    .bossHealthFill{
      height:100%;
      background:linear-gradient(90deg, #f00, #ff4500, #f00);
      width:100%;
      transition:width 0.5s ease;
      border-radius:12px;
      animation:healthPulse 1s ease-in-out infinite;
    }
    
    @keyframes healthPulse{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.3)}
    }

    /* Enhanced loading system */
    .loadingScreen{
      position:fixed;
      inset:0;
      background:var(--bg-space);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    
    .spinner{
      width:80px;
      height:80px;
      border:8px solid rgba(255,255,255,0.1);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:30px;
    }
    
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    
    .loadingText{
      font-size:1.2rem;
      color:var(--accent);
      margin-bottom:20px;
      animation:loadingPulse 2s ease-in-out infinite;
    }
    
    @keyframes loadingPulse{
      0%,100%{opacity:0.7}
      50%{opacity:1}
    }
    
    .loadingBar{
      width:300px;
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:4px;
      overflow:hidden;
    }
    
    .loadingBarFill{
      height:100%;
      background:linear-gradient(90deg, var(--accent), var(--good));
      width:0%;
      transition:width 0.3s ease;
      border-radius:4px;
    }

    /* =========[ ENHANCED MOBILE OPTIMIZATIONS ]========= */
    @media(max-width:1024px){
      #sidePanel{
        position:fixed;
        left:-320px;
        z-index:25;
        transition:left 0.3s ease;
        width:300px;
      }
      #sidePanel.open{left:0}
      
      #menuToggle{
        position:fixed;
        top:10px;
        left:10px;
        z-index:26;
        background:var(--accent);
        border:none;
        padding:12px;
        font-size:1.2rem;
        cursor:pointer;
        border-radius:8px;
        box-shadow:0 4px 15px rgba(0,0,0,0.3);
      }
      
      #gameArea{
        width:100%;
      }
    }
    
    @media(max-width:767px){
      h1{font-size:1.8rem}
      #hud{font-size:0.65rem}
      #question{font-size:1rem;min-width:250px;padding:10px 20px}
      .asteroid{width:80px;height:80px}
      .asteroid-body{font-size:1rem}
      #ship{--ship-size:50px}
      .modeGrid{grid-template-columns:1fr}
      .shopGrid{grid-template-columns:repeat(2, 1fr)}
      .achievementGrid{grid-template-columns:repeat(3, 1fr)}
      .stats{grid-template-columns:1fr;font-size:0.6rem}
      .stats-full{grid-template-columns:repeat(2, 1fr)}
      
      /* Enhanced mobile controls */
      #speedControl{display:none}
      #timerDisplay,#streakDisplay{right:5px;font-size:0.7rem}
      
      .tutorialSlide{padding:20px;max-width:95%}
      .leaderboard{padding:15px}
      .shopGrid{gap:10px}
      .achievementGrid{gap:8px}
      
      /* Touch zones for better mobile experience */
      .touchZone{
        position:absolute;
        bottom:0;
        height:200px;
        width:33.333%;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:2rem;
        opacity:0.3;
        transition:opacity 0.3s;
      }
      
      .touchZone:active{
        opacity:0.6;
        background:rgba(255,255,255,0.1);
      }
      
      .touchZone.left{left:0}
      .touchZone.center{left:33.333%}
      .touchZone.right{left:66.666%}
    }
    
    @media(max-width:480px){
      h1{font-size:1.5rem}
      #question{font-size:0.9rem;min-width:200px}
      .asteroid{width:70px;height:70px}
      .powerup{width:60px;height:60px}
      #ship{--ship-size:45px}
      .achievementGrid{grid-template-columns:repeat(2, 1fr)}
      .shopGrid{grid-template-columns:1fr}
      
      button{
        padding:12px 20px;
        font-size:0.7rem;
      }
      
      .tutorialSlide{
        padding:15px;
        font-size:0.6rem;
      }
      
      .modeCard{
        padding:15px;
      }
      
      .notification{
        right:10px;
        max-width:280px;
        font-size:0.6rem;
      }
    }
    
    /* Enhanced touch feedback */
    .touchable{
      -webkit-tap-highlight-color:rgba(255,255,255,0.2);
      touch-action:manipulation;
      transition:transform 0.1s ease;
    }
    
    .touchable:active{
      transform:scale(0.98);
    }
    
    /* Enhanced accessibility */
    @media(prefers-reduced-motion: reduce){
      *,
      *::before,
      *::after{
        animation-duration:0.01ms !important;
        animation-iteration-count:1 !important;
        transition-duration:0.01ms !important;
        scroll-behavior:auto !important;
      }
      
      .particle,
      .meteor,
      .shootingStar{
        display:none;
      }
    }
    
    @media(prefers-contrast: high){
      :root{
        --bg-space:#000;
        --text:#fff;
        --accent:#ff0;
        --good:#0f0;
        --bad:#f00;
        --border-glow:#fff;
      }
    }
    
    /* Focus indicators for accessibility */
    .focusable:focus{
      outline:3px solid var(--accent);
      outline-offset:2px;
    }
    
    /* High contrast mode support */
    @media(forced-colors: active){
      .asteroid-body,
      .powerup-body,
      .ship-body{
        forced-color-adjust:none;
      }
    }
  </style>
</head>

<body>
  <div id="starfield"></div>
  <div id="nebula"></div>
  
  <!-- Shooting stars -->
  <div class="shootingStar" style="top:10%;left:-50px;animation-delay:0s"></div>
  <div class="shootingStar" style="top:30%;left:-50px;animation-delay:2s"></div>
  <div class="shootingStar" style="top:60%;left:-50px;animation-delay:4s"></div>
  
  <button id="menuToggle" class="touchable" hidden>☰</button>

  <div id="mainContainer">
    <!-- ENHANCED SIDE PANEL -->
    <aside id="sidePanel">
      <div class="panel-section">
        <h3 class="panel-title">🚀 MISSION STATUS</h3>
        <div id="missionBrief">
          <div class="mission-stat">
            <span>Current Wave:</span>
            <span id="currentWave">1</span>
          </div>
          <div class="mission-stat">
            <span>Threat Level:</span>
            <span id="threatLevel">LOW</span>
          </div>
          <div class="mission-stat">
            <span>Destroyed:</span>
            <span id="destroyedCount">0</span>
          </div>
          <div class="mission-stat">
            <span>Accuracy:</span>
            <span id="accuracyRate">100%</span>
          </div>
          <div class="mission-stat">
            <span>Time Played:</span>
            <span id="sessionTime">0:00</span>
          </div>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">📡 TACTICAL RADAR</h3>
        <div id="miniMap">
          <div class="radarSweep"></div>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">📚 QUICK REFERENCE</h3>
        <div id="formulaRef">
          <div class="formula algebra">x + a = b → x = b - a</div>
          <div class="formula geometry">Area = π × r²</div>
          <div class="formula geometry">Volume = l × w × h</div>
          <div class="formula trigonometry">sin²θ + cos²θ = 1</div>
          <div class="formula calculus">d/dx(x²) = 2x</div>
          <div class="formula">Speed = Distance ÷ Time</div>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🎒 INVENTORY</h3>
        <div id="powerupInventory">
          <div class="mission-stat">
            <span>🛡️ Shield:</span>
            <span id="shieldCount">0</span>
          </div>
          <div class="mission-stat">
            <span>⏱️ Slow Time:</span>
            <span id="slowCount">0</span>
          </div>
          <div class="mission-stat">
            <span>2x Double Score:</span>
            <span id="doubleCount">0</span>
          </div>
          <div class="mission-stat">
            <span>💰 Coins:</span>
            <span id="currentCoins">0</span>
          </div>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">📊 LEARNING ANALYTICS</h3>
        <div id="learningAnalytics">
          <div style="margin-bottom:10px">Subject Mastery:</div>
          <div class="analytics-chart" id="masteryChart"></div>
          <div style="font-size:0.45rem;text-align:center;margin-top:5px">
            Algebra | Geometry | Calculus | Stats
          </div>
        </div>
      </div>
    </aside>

    <!-- ENHANCED GAME AREA -->
    <div id="gameArea">
      <div id="hud">
        <div id="question" class="touchable">Get Ready, Space Cadet!</div>
        <div id="hudTop">
          <div id="score">Score: 0</div>
          <div id="lives">Lives: ❤❤❤</div>
          <div id="combo">
            Combo: x1
            <div id="comboMeter"><div id="comboFill"></div></div>
          </div>
        </div>
      </div>
      
      <div id="timerDisplay" hidden>Time: 0:00</div>
      <div id="streakDisplay" hidden>Streak: 0</div>
      
      <div id="waveIndicator" hidden>
        <span>Wave 1 - Basic Training</span>
        <div class="wave-progress">
          <div class="wave-progress-fill"></div>
        </div>
      </div>
      
      <div id="speedControl">
        <label for="speedSlider">🚀 Game Speed</label>
        <input type="range" id="speedSlider" min="50" max="150" value="100">
        <span id="speedValue">100%</span>
        <div class="speed-presets">
          <button class="speed-preset" data-speed="75">Slow</button>
          <button class="speed-preset" data-speed="100">Normal</button>
          <button class="speed-preset" data-speed="125">Fast</button>
        </div>
      </div>
      
      <!-- Touch zones for mobile -->
      <div class="touchZone left" data-lane="0">←</div>
      <div class="touchZone center" data-lane="1">🎯</div>
      <div class="touchZone right" data-lane="2">→</div>
      
      <div id="ship">
        <div class="ship-body">
          <div class="ship-window"></div>
        </div>
        <div class="ship-engine">
          <div class="engine-flame"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENHANCED START SCREEN -->
  <section id="startScreen">
    <h1>🚀 GALACTIC MATH QUEST 🚀</h1>
    <p style="color:var(--accent);font-size:0.9rem;margin-bottom:10px">Ultimate Enhanced Edition v3.0</p>
    <p style="color:var(--combo);font-size:0.6rem">Master Mathematics • Save the Galaxy • Become a Legend</p>
    
    <div class="modeGrid">
      <div class="modeCard touchable" data-mode="classic">
        <h3>🎮 CLASSIC MODE</h3>
        <p>The original asteroid dodging experience with endless waves of mathematical challenges.</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐⭐</span>
        </div>
      </div>
      <div class="modeCard touchable" data-mode="adventure">
        <h3>🗺️ ADVENTURE MODE</h3>
        <p>Journey through 25 progressively challenging waves with unique boss encounters.</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐⭐⭐</span>
        </div>
      </div>
      <div class="modeCard touchable" data-mode="survival">
        <h3>💀 SURVIVAL MODE</h3>
        <p>One life, infinite challenges. How long can you survive the mathematical onslaught?</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐⭐⭐⭐</span>
        </div>
      </div>
      <div class="modeCard touchable" data-mode="timeAttack">
        <h3>⏱️ TIME ATTACK</h3>
        <p>Race against time! Answer as many questions as possible in 5 minutes.</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐⭐⭐</span>
        </div>
      </div>
      <div class="modeCard touchable" data-mode="practice">
        <h3>📚 PRACTICE MODE</h3>
        <p>Focus on specific math topics with adjustable difficulty and detailed explanations.</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐</span>
        </div>
      </div>
      <div class="modeCard touchable locked" data-mode="challenge">
        <h3>🏆 DAILY CHALLENGE</h3>
        <p>Unique puzzle every day with special rewards and global leaderboards.</p>
        <div class="difficulty">
          <span>Difficulty:</span>
          <span class="difficulty-stars">⭐⭐⭐⭐⭐</span>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-bottom:20px">
      <button id="startBtn" class="touchable">🚀 START MISSION</button>
      <button id="tutorialBtn" class="touchable secondary">📚 TRAINING</button>
      <button id="shopBtn" class="touchable secondary">🛒 UPGRADES</button>
      <button id="achievementsBtn" class="touchable secondary">🏆 ACHIEVEMENTS</button>
    </div>
    
    <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;justify-content:center">
      <button id="analyticsBtn" class="touchable secondary">📊 ANALYTICS</button>
      <button id="customizeBtn" class="touchable secondary">🎨 CUSTOMIZE</button>
      <button id="helpBtn" class="touchable secondary">❓ HELP</button>
      <button id="multiplayerBtn" class="touchable premium">👥 MULTIPLAYER</button>
    </div>
    
    <div style="display:flex;gap:15px;margin-top:10px">
      <button id="settingsMainBtn" class="touchable secondary">⚙️</button>
      <button id="leaderboardBtn" class="touchable secondary">🏆</button>
      <button id="soundMainBtn" class="touchable secondary">🔊</button>
      <button id="fullscreenBtn" class="touchable secondary">⛶</button>
    </div>
  </section>

  <!-- ENHANCED TUTORIAL SCREEN -->
  <section id="tutorialScreen" hidden>
    <div class="tutorialSlide" id="tutorialSlide1">
      <h3>Welcome to Galactic Math Quest! 🚀</h3>
      <p>You are <span class="highlight">Captain Mathematical</span>, commander of Earth's last defense ship against the asteroid invasion!</p>
      <p>Each asteroid carries a <span class="highlight">number</span> - your mission is to solve the equation and destroy the correct asteroid before it reaches Earth.</p>
      <p>Your mathematical skills are humanity's only hope! 🌍</p>
      <div class="tutorial-progress">
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>
      <div class="tutorialNav">
        <button class="tutNextBtn touchable">NEXT →</button>
      </div>
    </div>
    
    <div class="tutorialSlide" id="tutorialSlide2" hidden>
      <h3>Master the Controls 🎮</h3>
      <p><strong>Desktop:</strong> Use ← → arrow keys or A/D keys to move your ship</p>
      <p><strong>Shooting:</strong> Press ↓ or S to fire, or click asteroids directly</p>
      <p><strong>Mobile:</strong> Tap the screen zones or asteroids directly</p>
      <p><strong>Pause:</strong> Press Escape or the pause button anytime</p>
      <p><strong>Speed Control:</strong> Adjust game speed with the slider for comfortable learning</p>
      <div class="tutorial-progress">
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>
      <div class="tutorialNav">
        <button class="tutPrevBtn touchable secondary">← BACK</button>
        <button class="tutNextBtn touchable">NEXT →</button>
      </div>
    </div>
    
    <div class="tutorialSlide" id="tutorialSlide3" hidden>
      <h3>Power-Up Arsenal 💎</h3>
      <p><strong>🛡️ Shield:</strong> Absorbs one wrong answer - essential for survival!</p>
      <p><strong>❤️ Extra Life:</strong> Adds one life to your total (maximum 5)</p>
      <p><strong>⏱️ Time Slow:</strong> Slows down all asteroids for 10 seconds</p>
      <p><strong>2x Double Score:</strong> All points are worth double for 15 seconds</p>
      <p><strong>💣 Bomb:</strong> Clears all asteroids from the field instantly</p>
      <p><strong>⭐ Mega Power:</strong> Activates ALL power-ups simultaneously!</p>
      <div class="tutorial-progress">
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>
      <div class="tutorialNav">
        <button class="tutPrevBtn touchable secondary">← BACK</button>
        <button class="tutNextBtn touchable">NEXT →</button>
      </div>
    </div>
    
    <div class="tutorialSlide" id="tutorialSlide4" hidden>
      <h3>Mathematical Mastery 🧮</h3>
      <p>Progress through <span class="highlight">8 mathematical disciplines:</span></p>
      <p><strong>Basic Math:</strong> Addition, subtraction, multiplication, division</p>
      <p><strong>Algebra:</strong> Solve for x, linear equations, inequalities</p>
      <p><strong>Geometry:</strong> Areas, volumes, perimeters, angles</p>
      <p><strong>Fractions:</strong> Adding, subtracting, simplifying fractions</p>
      <p><strong>Trigonometry:</strong> Sin, cos, tan, and their applications</p>
      <p><strong>Calculus:</strong> Derivatives, integrals, limits</p>
      <p><strong>Statistics:</strong> Mean, median, probability, data analysis</p>
      <p><strong>Advanced:</strong> Complex numbers, matrices, advanced functions</p>
      <div class="tutorial-progress">
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
      </div>
      <div class="tutorialNav">
        <button class="tutPrevBtn touchable secondary">← BACK</button>
        <button class="tutNextBtn touchable">NEXT →</button>
      </div>
    </div>
    
    <div class="tutorialSlide" id="tutorialSlide5" hidden>
      <h3>Ready for Launch! 🚀</h3>
      <p>You're now ready to defend Earth with the power of mathematics!</p>
      <p><strong>Pro Tips:</strong></p>
      <p>• Build combos for massive score multipliers</p>
      <p>• Use the radar to track incoming threats</p>
      <p>• Practice mode helps master specific topics</p>
      <p>• Earn coins to unlock ship upgrades</p>
      <p>• Check analytics to track your progress</p>
      <p>Good luck, Captain Mathematical! The galaxy is counting on you! 🌌</p>
      <div class="tutorial-progress">
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
      </div>
      <div class="tutorialNav">
        <button class="tutPrevBtn touchable secondary">← BACK</button>
        <button class="tutEndBtn touchable">🚀 START PLAYING</button>
      </div>
    </div>
  </section>

  <!-- ENHANCED SHOP SCREEN -->
  <section id="shopScreen" hidden>
    <h1>🛒 GALACTIC SHOP</h1>
    <p>Credits Available: <span id="shopCoins" style="color:var(--premium)">0</span> 💰</p>
    
    <div class="shopGrid">
      <div class="shopItem touchable" data-item="shipBlue">
        <div class="icon">🔷</div>
        <div class="name">Azure Interceptor</div>
        <div class="description">Fast and agile ship with enhanced maneuverability</div>
        <div class="price">50</div>
      </div>
      <div class="shopItem touchable" data-item="shipRed">
        <div class="icon">🔴</div>
        <div class="name">Crimson Fighter</div>
        <div class="description">Robust ship with increased damage resistance</div>
        <div class="price">75</div>
      </div>
      <div class="shopItem touchable" data-item="shipGold">
        <div class="icon">⭐</div>
        <div class="name">Golden Phoenix</div>
        <div class="description">Legendary ship with premium effects and aura</div>
        <div class="price">150</div>
      </div>
      <div class="shopItem touchable" data-item="shipRainbow">
        <div class="icon">🌈</div>
        <div class="name">Prismatic Guardian</div>
        <div class="description">Ultimate ship with rainbow effects and special abilities</div>
        <div class="price">300</div>
      </div>
      <div class="shopItem touchable" data-item="extraLife">
        <div class="icon">❤️</div>
        <div class="name">Life Extension Module</div>
        <div class="description">Start each game with +1 additional life</div>
        <div class="price">100</div>
      </div>
      <div class="shopItem touchable" data-item="comboBoost">
        <div class="icon">🔥</div>
        <div class="name">Combo Accelerator</div>
        <div class="description">Combo multiplier increases 2x faster</div>
        <div class="price">200</div>
      </div>
      <div class="shopItem touchable" data-item="magnetPower">
        <div class="icon">🧲</div>
        <div class="name">Power-up Magnet</div>
        <div class="description">Automatically collect nearby power-ups</div>
        <div class="price">250</div>
      </div>
      <div class="shopItem touchable" data-item="shieldGen">
        <div class="icon">🛡️</div>
        <div class="name">Shield Generator</div>
        <div class="description">Start each wave with an active shield</div>
        <div class="price">180</div>
      </div>
      <div class="shopItem touchable" data-item="scoreBoost">
        <div class="icon">💎</div>
        <div class="name">Score Amplifier</div>
        <div class="description">All points worth 25% more</div>
        <div class="price">220</div>
      </div>
      <div class="shopItem touchable" data-item="timeExtend">
        <div class="icon">⏰</div>
        <div class="name">Time Dilation Field</div>
        <div class="description">Power-up effects last 50% longer</div>
        <div class="price">280</div>
      </div>
      <div class="shopItem touchable" data-item="mathTutor">
        <div class="icon">🧠</div>
        <div class="name">AI Math Tutor</div>
        <div class="description">Get hints and explanations for difficult problems</div>
        <div class="price">350</div>
      </div>
      <div class="shopItem touchable" data-item="premiumPass">
        <div class="icon">👑</div>
        <div class="name">Galactic Premium Pass</div>
        <div class="description">Unlock all premium features and bonuses</div>
        <div class="price">500</div>
      </div>
    </div>
    
    <button id="shopBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- ENHANCED ACHIEVEMENTS SCREEN -->
  <section id="achievementScreen" hidden>
    <h1>🏆 ACHIEVEMENT VAULT</h1>
    <p>Unlocked: <span id="achievementCount">0/36</span> | Completion: <span id="achievementPercent">0%</span></p>
    
    <div class="achievementGrid">
      <!-- Basic Achievements -->
      <div class="achievementCard" data-achievement="firstWin">
        <div class="icon">🎯</div>
        <div class="name">First Contact</div>
        <div class="description">Complete your first mission</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="combo5">
        <div class="icon">🔥</div>
        <div class="name">Heating Up</div>
        <div class="description">Achieve a 5x combo</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="combo10">
        <div class="icon">💥</div>
        <div class="name">On Fire</div>
        <div class="description">Achieve a 10x combo</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="combo25">
        <div class="icon">⚡</div>
        <div class="name">Lightning Strike</div>
        <div class="description">Achieve a 25x combo</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Survival Achievements -->
      <div class="achievementCard" data-achievement="survivor">
        <div class="icon">💪</div>
        <div class="name">Space Survivor</div>
        <div class="description">Survive 10 waves</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="veteran">
        <div class="icon">🎖️</div>
        <div class="name">Veteran Pilot</div>
        <div class="description">Survive 25 waves</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="legend">
        <div class="icon">👑</div>
        <div class="name">Living Legend</div>
        <div class="description">Survive 50 waves</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Accuracy Achievements -->
      <div class="achievementCard" data-achievement="accurate">
        <div class="icon">🎯</div>
        <div class="name">Sharpshooter</div>
        <div class="description">95% accuracy in a game</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="perfect">
        <div class="icon">⭐</div>
        <div class="name">Perfect Precision</div>
        <div class="description">100% accuracy for 10 questions</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Subject Mastery -->
      <div class="achievementCard" data-achievement="algebraMaster">
        <div class="icon">📐</div>
        <div class="name">Algebra Ace</div>
        <div class="description">Answer 100 algebra questions correctly</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="geometryGuru">
        <div class="icon">📏</div>
        <div class="name">Geometry Genius</div>
        <div class="description">Answer 100 geometry questions correctly</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="calculusKing">
        <div class="icon">∫</div>
        <div class="name">Calculus Champion</div>
        <div class="description">Answer 100 calculus questions correctly</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Speed Achievements -->
      <div class="achievementCard" data-achievement="speedster">
        <div class="icon">⚡</div>
        <div class="name">Speed Demon</div>
        <div class="description">Answer 10 questions in under 5 seconds each</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="lightning">
        <div class="icon">🌩️</div>
        <div class="name">Lightning Calculator</div>
        <div class="description">Answer 25 questions in under 3 seconds each</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Collection Achievements -->
      <div class="achievementCard" data-achievement="collector">
        <div class="icon">💎</div>
        <div class="name">Power Collector</div>
        <div class="description">Collect 50 power-ups</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="hoarder">
        <div class="icon">🗃️</div>
        <div class="name">Power Hoarder</div>
        <div class="description">Collect 200 power-ups</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Score Achievements -->
      <div class="achievementCard" data-achievement="highScore">
        <div class="icon">🏆</div>
        <div class="name">High Scorer</div>
        <div class="description">Score 10,000 points in one game</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="megaScore">
        <div class="icon">💫</div>
        <div class="name">Mega Scorer</div>
        <div class="description">Score 50,000 points in one game</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Boss Achievements -->
      <div class="achievementCard" data-achievement="bossSlayer">
        <div class="icon">👹</div>
        <div class="name">Boss Slayer</div>
        <div class="description">Defeat your first boss asteroid</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="bossHunter">
        <div class="icon">🗡️</div>
        <div class="name">Boss Hunter</div>
        <div class="description">Defeat 10 boss asteroids</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Special Achievements -->
      <div class="achievementCard" data-achievement="mathematician">
        <div class="icon">🧮</div>
        <div class="name">Master Mathematician</div>
        <div class="description">Answer 1000 questions correctly</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="scholar">
        <div class="icon">🎓</div>
        <div class="name">Galactic Scholar</div>
        <div class="description">Complete tutorial and practice mode</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="explorer">
        <div class="icon">🚀</div>
        <div class="name">Space Explorer</div>
        <div class="description">Try all game modes</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="shopper">
        <div class="icon">🛒</div>
        <div class="name">Cosmic Shopper</div>
        <div class="description">Purchase 5 shop items</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="wealthy">
        <div class="icon">💰</div>
        <div class="name">Space Millionaire</div>
        <div class="description">Earn 10,000 total coins</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Time-based Achievements -->
      <div class="achievementCard" data-achievement="marathon">
        <div class="icon">⏰</div>
        <div class="name">Math Marathon</div>
        <div class="description">Play for 60 minutes total</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="dedication">
        <div class="icon">📅</div>
        <div class="name">Dedicated Student</div>
        <div class="description">Play 10 different days</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Secret Achievements -->
      <div class="achievementCard" data-achievement="konami">
        <div class="icon">🎮</div>
        <div class="name">Code Breaker</div>
        <div class="description">Find the secret code</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <div class="achievementCard" data-achievement="easter">
        <div class="icon">🥚</div>
        <div class="name">Easter Hunter</div>
        <div class="description">Discover a hidden easter egg</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
      
      <!-- Ultimate Achievement -->
      <div class="achievementCard" data-achievement="ultimate">
        <div class="icon">🌟</div>
        <div class="name">Ultimate Champion</div>
        <div class="description">Unlock all other achievements</div>
        <div class="progress"><div class="progressFill" style="width:0%"></div></div>
      </div>
    </div>
    
    <button id="achievementBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- NEW LEARNING ANALYTICS SCREEN -->
  <section id="analyticsScreen" hidden>
    <h1>📊 LEARNING ANALYTICS</h1>
    <h2>Your Mathematical Journey</h2>
    
    <div class="stats stats-full">
      <div class="stat-item">
        <span class="stat-label">📈 Overall Progress</span>
        <span class="stat-value" id="overallProgress">0%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🎯 Average Accuracy</span>
        <span class="stat-value" id="avgAccuracy">0%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">⚡ Average Speed</span>
        <span class="stat-value" id="avgSpeed">0s</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🔥 Longest Streak</span>
        <span class="stat-value" id="longestStreak">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">📚 Subjects Mastered</span>
        <span class="stat-value" id="subjectsMastered">0/8</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🏆 Skill Level</span>
        <span class="stat-value" id="skillLevel">Novice</span>
      </div>
    </div>
    
    <h2>Subject Mastery Breakdown</h2>
    <div class="analytics-chart" id="subjectChart" style="height:200px;margin:20px 0">
      <!-- Dynamic chart will be generated here -->
    </div>
    
    <h2>Weekly Progress</h2>
    <div class="analytics-chart" id="progressChart" style="height:150px;margin:20px 0">
      <!-- Weekly progress chart -->
    </div>
    
    <h2>Recommendations</h2>
    <div id="recommendations" style="background:rgba(0,0,0,0.6);padding:20px;border-radius:10px;margin:20px 0;text-align:left;max-width:600px">
      <div class="stat-item">
        <span class="stat-label">🎯 Focus Area:</span>
        <span class="stat-value" id="focusArea">Loading...</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">📈 Next Goal:</span>
        <span class="stat-value" id="nextGoal">Loading...</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">⭐ Suggested Practice:</span>
        <span class="stat-value" id="suggestedPractice">Loading...</span>
      </div>
    </div>
    
    <button id="analyticsBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- NEW CUSTOMIZATION SCREEN -->
  <section id="customizeScreen" hidden>
    <h1>🎨 SHIP CUSTOMIZATION</h1>
    <h2>Personalize Your Galactic Experience</h2>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:30px 0;max-width:1000px">
      <div class="panel-section">
        <h3 class="panel-title">🚀 SHIP COLORS</h3>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
          <button class="color-option" data-color="default" style="background:var(--good)">Default</button>
          <button class="color-option" data-color="blue" style="background:#0077b6">Blue</button>
          <button class="color-option" data-color="red" style="background:#e63946">Red</button>
          <button class="color-option" data-color="purple" style="background:#9b59b6">Purple</button>
          <button class="color-option" data-color="gold" style="background:#ffd700">Gold</button>
          <button class="color-option" data-color="rainbow" style="background:linear-gradient(45deg,red,orange,yellow,green,blue,purple)">Rainbow</button>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🌌 THEMES</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
          <button class="theme-option" data-theme="space">🌌 Space</button>
          <button class="theme-option" data-theme="nebula">🌊 Nebula</button>
          <button class="theme-option" data-theme="nova">⭐ Nova</button>
          <button class="theme-option" data-theme="matrix">💚 Matrix</button>
          <button class="theme-option" data-theme="cyberpunk">🌆 Cyberpunk</button>
          <button class="theme-option" data-theme="retro">📼 Retro</button>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🎵 SOUND EFFECTS</h3>
        <div style="display:grid;gap:10px">
          <button class="sound-option" data-sound="classic">🎮 Classic</button>
          <button class="sound-option" data-sound="space">🚀 Space</button>
          <button class="sound-option" data-sound="retro">📼 8-bit</button>
          <button class="sound-option" data-sound="orchestral">🎼 Orchestral</button>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">✨ VISUAL EFFECTS</h3>
        <div style="display:grid;gap:10px">
          <label style="display:flex;justify-content:space-between;align-items:center">
            <span>Particles</span>
            <input type="checkbox" id="particlesToggle" checked>
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center">
            <span>Screen Shake</span>
            <input type="checkbox" id="shakeToggle" checked>
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center">
            <span>Shooting Stars</span>
            <input type="checkbox" id="starsToggle" checked>
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center">
            <span>Enhanced Glow</span>
            <input type="checkbox" id="glowToggle" checked>
          </label>
        </div>
      </div>
    </div>
    
    <div style="margin:30px 0">
      <h3>🔮 SHIP PREVIEW</h3>
      <div id="shipPreview" style="display:flex;justify-content:center;margin:20px 0">
        <div class="ship-body" style="width:80px;height:80px;position:relative">
          <div class="ship-window"></div>
        </div>
      </div>
    </div>
    
    <button id="customizeBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- NEW HELP SCREEN -->
  <section id="helpScreen" hidden>
    <h1>❓ MISSION BRIEFING</h1>
    <h2>Everything You Need to Know</h2>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:30px 0;max-width:1200px">
      <div class="panel-section">
        <h3 class="panel-title">🎮 GAME MODES</h3>
        <div style="text-align:left;font-size:0.55rem;line-height:1.6">
          <p><strong>Classic:</strong> Endless waves with increasing difficulty</p>
          <p><strong>Adventure:</strong> 25 waves with boss encounters</p>
          <p><strong>Survival:</strong> One life, maximum challenge</p>
          <p><strong>Time Attack:</strong> 5-minute score rush</p>
          <p><strong>Practice:</strong> Focus on specific topics</p>
          <p><strong>Daily Challenge:</strong> Special daily puzzles</p>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🧮 MATH TOPICS</h3>
        <div style="text-align:left;font-size:0.55rem;line-height:1.6">
          <p><strong>Basic Math:</strong> +, -, ×, ÷ operations</p>
          <p><strong>Algebra:</strong> Solving for x, equations</p>
          <p><strong>Geometry:</strong> Areas, perimeters, volumes</p>
          <p><strong>Fractions:</strong> Adding, subtracting fractions</p>
          <p><strong>Trigonometry:</strong> Sin, cos, tan functions</p>
          <p><strong>Calculus:</strong> Derivatives and integrals</p>
          <p><strong>Statistics:</strong> Mean, median, probability</p>
          <p><strong>Advanced:</strong> Complex numbers, matrices</p>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🎯 SCORING SYSTEM</h3>
        <div style="text-align:left;font-size:0.55rem;line-height:1.6">
          <p><strong>Base Score:</strong> 10 points per correct answer</p>
          <p><strong>Combo Bonus:</strong> +1 point per combo level</p>
          <p><strong>Speed Bonus:</strong> Extra points for quick answers</p>
          <p><strong>Difficulty Bonus:</strong> Higher waves = more points</p>
          <p><strong>Power-up Multipliers:</strong> 2x score power-up</p>
          <p><strong>Perfect Round:</strong> 50% bonus for 100% accuracy</p>
        </div>
      </div>
      
      <div class="panel-section">
        <h3 class="panel-title">🏆 ACHIEVEMENTS</h3>
        <div style="text-align:left;font-size:0.55rem;line-height:1.6">
          <p><strong>Progress:</strong> Unlock by playing and improving</p>
          <p><strong>Mastery:</strong> Excel in specific math topics</p>
          <p><strong>Speed:</strong> Answer questions quickly</p>
          <p><strong>Survival:</strong> Last longer in each game</p>
          <p><strong>Collection:</strong> Gather power-ups and coins</p>
          <p><strong>Secret:</strong> Hidden achievements to discover</p>
        </div>
      </div>
    </div>
    
    <div class="panel-section" style="max-width:600px;margin:20px 0">
      <h3 class="panel-title">⌨️ KEYBOARD SHORTCUTS</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;text-align:left;font-size:0.6rem">
        <div>← → A D: Move ship</div>
        <div>↓ S: Fire/Select</div>
        <div>Escape: Pause game</div>
        <div>Space: Quick restart</div>
        <div>F: Toggle fullscreen</div>
        <div>M: Mute/Unmute</div>
        <div>P: Power-up info</div>
        <div>H: Show this help</div>
      </div>
    </div>
    
    <button id="helpBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- NEW MULTIPLAYER SCREEN (PREMIUM) -->
  <section id="multiplayerScreen" hidden>
    <h1>👥 MULTIPLAYER ARENA</h1>
    <h2 style="color:var(--premium)">🌟 Premium Feature 🌟</h2>
    
    <div style="background:rgba(212,175,55,0.1);border:2px solid var(--premium);border-radius:15px;padding:30px;margin:30px 0;max-width:600px">
      <h3 style="color:var(--premium);margin-bottom:20px">🚀 Coming Soon!</h3>
      <div style="text-align:left;font-size:0.7rem;line-height:1.8">
        <p>🏟️ <strong>Competitive Battles:</strong> Challenge friends in real-time math duels</p>
        <p>👥 <strong>Team Mode:</strong> Work together to solve complex problems</p>
        <p>🏆 <strong>Tournaments:</strong> Weekly competitions with special rewards</p>
        <p>💬 <strong>Study Groups:</strong> Learn together with classmates</p>
        <p>📊 <strong>Class Leaderboards:</strong> Track progress against peers</p>
        <p>🎓 <strong>Teacher Dashboard:</strong> Classroom management tools</p>
      </div>
    </div>
    
    <div style="margin:30px 0">
      <h3>🔓 Unlock Multiplayer</h3>
      <p style="margin:15px 0;font-size:0.7rem">Get access to all multiplayer features with Premium Pass</p>
      <button class="premium touchable" id="unlockMultiplayer">👑 UPGRADE TO PREMIUM</button>
    </div>
    
    <button id="multiplayerBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- ENHANCED LEADERBOARD SCREEN -->
  <section id="leaderboardScreen" hidden>
    <h1>🏆 GALACTIC LEADERBOARD</h1>
    <h2>Top Mathematical Pilots</h2>
    
    <div style="display:flex;gap:15px;margin:20px 0;justify-content:center;flex-wrap:wrap">
      <button class="leaderboard-tab secondary touchable active" data-tab="overall">🌟 Overall</button>
      <button class="leaderboard-tab secondary touchable" data-tab="weekly">📅 Weekly</button>
      <button class="leaderboard-tab secondary touchable" data-tab="speed">⚡ Speed</button>
      <button class="leaderboard-tab secondary touchable" data-tab="accuracy">🎯 Accuracy</button>
    </div>
    
    <div class="leaderboard">
      <div class="leaderboardEntry">
        <span class="rank gold">#1</span>
        <span class="name">ACE_PILOT_2024</span>
        <span class="score">25,000</span>
        <span class="extras">🏆 👑</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank silver">#2</span>
        <span class="name">MATH_WIZARD_PRO</span>
        <span class="score">22,500</span>
        <span class="extras">🧙‍♂️ ⭐</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank bronze">#3</span>
        <span class="name">SPACE_HERO_99</span>
        <span class="score">20,100</span>
        <span class="extras">🚀 🔥</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank">#4</span>
        <span class="name">CALC_MASTER</span>
        <span class="score">18,750</span>
        <span class="extras">📐</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank">#5</span>
        <span class="name">GEOMETRY_GURU</span>
        <span class="score">17,200</span>
        <span class="extras">📏</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank">#6</span>
        <span class="name">ALGEBRA_ANGEL</span>
        <span class="score">16,500</span>
        <span class="extras">👼</span>
      </div>
      <div class="leaderboardEntry">
        <span class="rank">#7</span>
        <span class="name">TRIG_TITAN</span>
        <span class="score">15,800</span>
        <span class="extras">📊</span>
      </div>
      <div class="leaderboardEntry current">
        <span class="rank">#47</span>
        <span class="name">YOU</span>
        <span class="score" id="yourHighScore">0</span>
        <span class="extras">🌟</span>
      </div>
    </div>
    
    <div style="margin-top:20px;font-size:0.6rem;opacity:0.8">
      <p>🔄 Updated every 5 minutes</p>
      <p>🏆 Prizes awarded weekly to top performers</p>
    </div>
    
    <button id="leaderboardBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- ENHANCED SETTINGS SCREEN -->
  <section id="settingsScreen" hidden>
    <h1>⚙️ MISSION CONTROL</h1>
    
    <div class="stats stats-full">
      <div class="stat-item">
        <span class="stat-label">🎮 Games Played</span>
        <span class="stat-value" id="gamesPlayed">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">📊 Total Score</span>
        <span class="stat-value" id="totalScore">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🔥 Best Combo</span>
        <span class="stat-value" id="bestCombo">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🎯 Overall Accuracy</span>
        <span class="stat-value" id="accuracy">0%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">💎 Power-ups Used</span>
        <span class="stat-value" id="powerupsUsed">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">💰 Total Coins</span>
        <span class="stat-value" id="totalCoins">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🚀 Ships Unlocked</span>
        <span class="stat-value" id="shipsUnlocked">1/6</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🏆 Achievements</span>
        <span class="stat-value" id="achievementsUnlocked">0/36</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">⏰ Play Time</span>
        <span class="stat-value" id="playTime">0h 0m</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">📚 Questions Answered</span>
        <span class="stat-value" id="totalQuestions">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">✅ Correct Answers</span>
        <span class="stat-value" id="totalCorrect">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">🌟 Skill Rating</span>
        <span class="stat-value" id="skillRating">Novice</span>
      </div>
    </div>
    
    <h2>⚙️ Game Settings</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:30px 0;max-width:800px">
      <button id="themeBtn" class="touchable secondary">🌌 THEME: SPACE</button>
      <button id="qualityBtn" class="touchable secondary">✨ QUALITY: HIGH</button>
      <button id="difficultyBtn" class="touchable secondary">📈 DIFFICULTY: AUTO</button>
      <button id="languageBtn" class="touchable secondary">🌐 LANGUAGE: EN</button>
      <button id="notificationsBtn" class="touchable secondary">🔔 NOTIFICATIONS: ON</button>
      <button id="tutorialsBtn" class="touchable secondary">🎓 HINTS: ON</button>
      <button id="autoSaveBtn" class="touchable secondary">💾 AUTO-SAVE: ON</button>
      <button id="analyticsPermissionBtn" class="touchable secondary">📊 ANALYTICS: ON</button>
    </div>
    
    <h2>💾 Data Management</h2>
    <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin:20px 0">
      <button id="exportDataBtn" class="touchable secondary">📤 EXPORT DATA</button>
      <button id="importDataBtn" class="touchable secondary">📥 IMPORT DATA</button>
      <button id="backupBtn" class="touchable secondary">☁️ BACKUP TO CLOUD</button>
      <button id="resetStatsBtn" class="touchable danger">🗑️ RESET PROGRESS</button>
    </div>
    
    <h2>🔓 Premium Features</h2>
    <div style="background:rgba(212,175,55,0.1);border:2px solid var(--premium);border-radius:10px;padding:20px;margin:20px 0;max-width:500px">
      <p style="margin-bottom:15px;font-size:0.7rem">Unlock advanced features:</p>
      <ul style="text-align:left;font-size:0.6rem;line-height:1.6;list-style:none;padding-left:0">
        <li>👥 Multiplayer modes</li>
        <li>📊 Advanced analytics</li>
        <li>🎨 Premium themes</li>
        <li>🚀 Exclusive ships</li>
        <li>🎓 AI math tutor</li>
        <li>☁️ Cloud sync</li>
      </ul>
      <button class="premium touchable" style="margin-top:15px">👑 UPGRADE NOW</button>
    </div>
    
    <button id="settingsBackBtn" class="touchable" style="margin-top:20px">← BACK TO BRIDGE</button>
  </section>

  <!-- ENHANCED PAUSE SCREEN -->
  <section id="pauseScreen" hidden>
    <h1>⏸️ MISSION PAUSED</h1>
    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">Current Score</span>
        <span class="stat-value" id="pauseScore">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Current Wave</span>
        <span class="stat-value" id="pauseWave">1</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Combo Streak</span>
        <span class="stat-value" id="pauseCombo">x1</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Session Time</span>
        <span class="stat-value" id="pauseTime">0:00</span>
      </div>
    </div>
    
    <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-top:30px">
      <button id="resumeBtn" class="touchable">▶️ RESUME</button>
      <button id="hintBtn" class="touchable secondary">💡 HINT</button>
      <button id="restartBtn" class="touchable secondary">🔄 RESTART</button>
      <button id="mainMenuBtn" class="touchable secondary">🏠 MAIN MENU</button>
    </div>
  </section>

  <!-- ENHANCED GAME OVER SCREEN -->
  <section id="gameOver" hidden>
    <h1>🎯 MISSION COMPLETE</h1>
    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">Final Score</span>
        <span class="stat-value" id="finalScore">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Accuracy Rate</span>
        <span class="stat-value" id="finalAccuracy">0%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Best Combo</span>
        <span class="stat-value" id="finalCombo">x1</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Coins Earned</span>
        <span class="stat-value" id="coinsEarned">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Waves Survived</span>
        <span class="stat-value" id="wavesSurvived">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Time Played</span>
        <span class="stat-value" id="timePlayed">0:00</span>
      </div>
    </div>
    
    <div id="performanceRating" style="margin:20px 0;font-size:1.2rem">
      <div id="ratingStars">⭐⭐⭐</div>
      <div id="ratingText" style="color:var(--accent);margin-top:10px">Good Performance!</div>
    </div>
    
    <div id="newAchievements" style="margin-top:20px"></div>
    
    <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-top:30px">
      <button id="playAgainBtn" class="touchable">🔄 PLAY AGAIN</button>
      <button id="shareScoreBtn" class="touchable secondary">📤 SHARE SCORE</button>
      <button id="viewStatsBtn" class="touchable secondary">📊 VIEW STATS</button>
      <button id="gameOverMenuBtn" class="touchable secondary">🏠 MAIN MENU</button>
    </div>
  </section>

  <!-- Enhanced control buttons -->
  <button id="pauseBtn" class="touchable" style="position:fixed;top:10px;right:60px;z-index:15;background:var(--accent);border:none;padding:8px 12px;font-size:0.8rem;border-radius:5px">⏸️</button>
  <button id="helpGameBtn" class="touchable" style="position:fixed;top:10px;right:10px;z-index:15;background:var(--info);border:none;padding:8px 12px;font-size:0.8rem;border-radius:5px">❓</button>
  
  <!-- Loading screen -->
  <div id="loadingScreen" class="loadingScreen" hidden>
    <div class="spinner"></div>
    <div class="loadingText">Initializing Galactic Systems...</div>
    <div class="loadingBar">
      <div class="loadingBarFill" id="loadingBarFill"></div>
    </div>
    <div style="margin-top:20px;font-size:0.6rem;opacity:0.8" id="loadingStatus">Loading game engine...</div>
  </div>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
  
  <script>
  /* ================== GALACTIC MATH QUEST ULTIMATE ENHANCED v3.0 ================== */
  
  // === ENHANCED GAME ENGINE ===
  class EnhancedGameEngine {
    constructor() {
      this.state = {
        mode: 'classic',
        score: 0,
        lives: 3,
        combo: 1,
        maxCombo: 1,
        wave: 1,
        coins: 0,
        currentAnswer: null,
        isPlaying: false,
        isPaused: false,
        speed: 4000,
        speedMultiplier: 1,
        questionsAnswered: 0,
        correctAnswers: 0,
        asteroidsDestroyed: 0,
        powerupsCollected: 0,
        shieldActive: false,
        doubleScoreActive: false,
        timeSlowActive: false,
        invulnerableTime: 0,
        startTime: null,
        currentShipLane: 1,
        streak: 0,
        maxStreak: 0,
        sessionStartTime: null,
        lastAnswerTime: null,
        averageAnswerTime: 0,
        totalAnswerTime: 0,
        bossesDefeated: 0,
        perfectRounds: 0,
        subjectStats: {
          basic: { correct: 0, total: 0 },
          algebra: { correct: 0, total: 0 },
          geometry: { correct: 0, total: 0 },
          fraction: { correct: 0, total: 0 },
          trigonometry: { correct: 0, total: 0 },
          calculus: { correct: 0, total: 0 },
          statistics: { correct: 0, total: 0 },
          advanced: { correct: 0, total: 0 }
        }
      };
      
      this.config = {
        baseSpeed: 4000,
        minSpeed: 1500,
        maxLives: 5,
        comboDecay: 5000,
        powerupChance: 0.15,
        bossInterval: 10,
        coinMultiplier: 0.1,
        themes: ['space', 'nebula', 'nova', 'matrix', 'cyberpunk'],
        difficulties: ['easy', 'normal', 'hard', 'expert', 'nightmare'],
        languages: ['en', 'es', 'fr', 'de', 'zh'],
        maxSubjectQuestions: 100
      };
      
      this.modes = {
        classic: { waves: Infinity, lives: 3, description: "Classic endless mode", timeLimit: null },
        adventure: { waves: 25, lives: 4, description: "Complete 25 waves with bosses", timeLimit: null },
        survival: { waves: Infinity, lives: 1, description: "One life challenge", timeLimit: null },
        timeAttack: { waves: Infinity, lives: 3, description: "5-minute score rush", timeLimit: 300000 },
        practice: { waves: Infinity, lives: 5, description: "Practice specific topics", timeLimit: null },
        challenge: { waves: 5, lives: 3, description: "Daily special challenge", timeLimit: null }
      };
      
      // Enhanced systems
      this.stats = this.loadStats();
      this.settings = this.loadSettings();
      this.achievements = new EnhancedAchievementSystem();
      this.soundManager = new EnhancedSoundManager();
      this.particleSystem = new EnhancedParticleSystem();
      this.shop = new EnhancedShopSystem();
      this.analytics = new LearningAnalytics();
      this.aiTutor = new AITutor();
      this.weatherSystem = new WeatherSystem();
      this.customization = new CustomizationSystem();
      
      // Game objects
      this.asteroids = [];
      this.powerups = [];
      this.animations = [];
      this.meteors = [];
      this.notifications = [];
      
      // Enhanced features
      this.currentQuestionType = null;
      this.difficultyLevel = 1;
      this.adaptiveDifficulty = true;
      this.hintSystem = new HintSystem();
      this.explanationSystem = new ExplanationSystem();
      
      this.init();
    }
    
    async init() {
      this.showLoadingScreen();
      
      await this.delay(500);
      this.updateLoadingProgress(20, "Loading user interface...");
      
      this.bindElements();
      this.bindEvents();
      
      await this.delay(300);
      this.updateLoadingProgress(40, "Initializing math engine...");
      
      this.updateUI();
      this.loadTheme();
      this.shop.loadPurchases();
      
      await this.delay(400);
      this.updateLoadingProgress(60, "Loading achievements...");
      
      this.achievements.init();
      this.analytics.init();
      
      await this.delay(300);
      this.updateLoadingProgress(80, "Setting up visual effects...");
      
      this.weatherSystem.init();
      this.customization.init();
      
      await this.delay(200);
      this.updateLoadingProgress(100, "Ready for launch!");
      
      await this.delay(500);
      this.hideLoadingScreen();
      
      // Mobile menu toggle
      if (window.innerWidth <= 1024) {
        document.getElementById('menuToggle').hidden = false;
      }
      
      // Initialize session
      this.state.sessionStartTime = Date.now();
      this.startSessionTimer();
      
      // Show welcome message for first-time users
      if (this.stats.gamesPlayed === 0) {
        setTimeout(() => {
          this.showNotification('Welcome to Galactic Math Quest! 🚀', 'info');
          setTimeout(() => {
            this.showNotification('Try the tutorial to learn the basics! 📚', 'info');
          }, 3000);
        }, 2000);
      }
    }
    
    showLoadingScreen() {
      document.getElementById('loadingScreen').hidden = false;
    }
    
    hideLoadingScreen() {
      document.getElementById('loadingScreen').hidden = true;
    }
    
    updateLoadingProgress(percent, status) {
      document.getElementById('loadingBarFill').style.width = percent + '%';
      document.getElementById('loadingStatus').textContent = status;
    }
    
    delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    bindElements() {
      // Game area elements
      this.els = {
        ship: document.getElementById('ship'),
        gameArea: document.getElementById('gameArea'),
        question: document.getElementById('question'),
        score: document.getElementById('score'),
        lives: document.getElementById('lives'),
        combo: document.getElementById('combo'),
        comboFill: document.getElementById('comboFill'),
        
        // Enhanced HUD
        timerDisplay: document.getElementById('timerDisplay'),
        streakDisplay: document.getElementById('streakDisplay'),
        
        // Screens
        startScreen: document.getElementById('startScreen'),
        gameOverScreen: document.getElementById('gameOver'),
        pauseScreen: document.getElementById('pauseScreen'),
        tutorialScreen: document.getElementById('tutorialScreen'),
        shopScreen: document.getElementById('shopScreen'),
        achievementScreen: document.getElementById('achievementScreen'),
        leaderboardScreen: document.getElementById('leaderboardScreen'),
        settingsScreen: document.getElementById('settingsScreen'),
        analyticsScreen: document.getElementById('analyticsScreen'),
        helpScreen: document.getElementById('helpScreen'),
        customizeScreen: document.getElementById('customizeScreen'),
        multiplayerScreen: document.getElementById('multiplayerScreen'),
        
        // Side panel
        sidePanel: document.getElementById('sidePanel'),
        currentWave: document.getElementById('currentWave'),
        threatLevel: document.getElementById('threatLevel'),
        destroyedCount: document.getElementById('destroyedCount'),
        accuracyRate: document.getElementById('accuracyRate'),
        sessionTime: document.getElementById('sessionTime'),
        miniMap: document.getElementById('miniMap'),
        currentCoins: document.getElementById('currentCoins'),
        
        // Controls
        speedSlider: document.getElementById('speedSlider'),
        speedValue: document.getElementById('speedValue'),
        waveIndicator: document.getElementById('waveIndicator')
      };
    }
    
    bindEvents() {
      // Start screen
      document.getElementById('startBtn').addEventListener('click', () => this.startGame());
      document.getElementById('tutorialBtn').addEventListener('click', () => this.showTutorial());
      document.getElementById('shopBtn').addEventListener('click', () => this.showShop());
      document.getElementById('achievementsBtn').addEventListener('click', () => this.showAchievements());
      document.getElementById('leaderboardBtn').addEventListener('click', () => this.showLeaderboard());
      document.getElementById('settingsMainBtn').addEventListener('click', () => this.showSettings());
      document.getElementById('analyticsBtn').addEventListener('click', () => this.showAnalytics());
      document.getElementById('customizeBtn').addEventListener('click', () => this.showCustomization());
      document.getElementById('helpBtn').addEventListener('click', () => this.showHelp());
      document.getElementById('multiplayerBtn').addEventListener('click', () => this.showMultiplayer());
      
      // Enhanced controls
      document.getElementById('soundMainBtn')?.addEventListener('click', () => this.soundManager.toggle());
      document.getElementById('fullscreenBtn')?.addEventListener('click', () => this.toggleFullscreen());
      
      // Game mode selection with enhanced feedback
      document.querySelectorAll('.modeCard').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!card.classList.contains('locked')) {
            document.querySelectorAll('.modeCard').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            this.state.mode = card.dataset.mode;
            this.soundManager.play('click');
          } else {
            this.showNotification('Mode locked! Complete achievements to unlock.', 'warning');
            this.soundManager.play('locked');
          }
        });
      });
      
      // Enhanced pause controls
      document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
      document.getElementById('resumeBtn').addEventListener('click', () => this.togglePause());
      document.getElementById('restartBtn').addEventListener('click', () => this.restart());
      document.getElementById('mainMenuBtn').addEventListener('click', () => this.backToMenu());
      document.getElementById('hintBtn')?.addEventListener('click', () => this.showHint());
      
      // Enhanced game over controls
      document.getElementById('playAgainBtn').addEventListener('click', () => this.restart());
      document.getElementById('gameOverMenuBtn').addEventListener('click', () => this.backToMenu());
      document.getElementById('shareScoreBtn')?.addEventListener('click', () => this.shareScore());
      document.getElementById('viewStatsBtn')?.addEventListener('click', () => this.showAnalytics());
      
      // Settings with enhanced options
      document.getElementById('themeBtn').addEventListener('click', () => this.cycleTheme());
      document.getElementById('qualityBtn').addEventListener('click', () => this.cycleQuality());
      document.getElementById('difficultyBtn')?.addEventListener('click', () => this.cycleDifficulty());
      document.getElementById('languageBtn')?.addEventListener('click', () => this.cycleLanguage());
      document.getElementById('resetStatsBtn').addEventListener('click', () => this.resetStats());
      
      // Enhanced speed control
      this.els.speedSlider.addEventListener('input', (e) => {
        this.state.speedMultiplier = e.target.value / 100;
        this.els.speedValue.textContent = e.target.value + '%';
      });
      
      // Speed presets
      document.querySelectorAll('.speed-preset').forEach(preset => {
        preset.addEventListener('click', () => {
          const speed = parseInt(preset.dataset.speed);
          this.els.speedSlider.value = speed;
          this.state.speedMultiplier = speed / 100;
          this.els.speedValue.textContent = speed + '%';
          this.soundManager.play('click');
        });
      });
      
      // Enhanced keyboard controls
      document.addEventListener('keydown', (e) => this.handleKeyboard(e));
      
      // Enhanced touch controls with better feedback
      let touchStartX = null;
      this.els.gameArea.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        if (this.state.isPlaying) {
          this.addTouchFeedback(e.touches[0].clientX, e.touches[0].clientY);
        }
      });
      
      this.els.gameArea.addEventListener('touchend', (e) => {
        if (!touchStartX || !this.state.isPlaying) return;
        
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchEndX - touchStartX;
        
        if (Math.abs(diff) > 50) {
          this.moveShip(diff > 0 ? 1 : -1);
        }
      });
      
      // Touch zones for mobile
      document.querySelectorAll('.touchZone').forEach(zone => {
        zone.addEventListener('click', () => {
          const lane = parseInt(zone.dataset.lane);
          this.moveShipToLane(lane);
          
          // Auto-fire if there's an asteroid in that lane
          const asteroid = this.asteroids.find(a => 
            parseInt(a.dataset.lane) === lane && !a.dataset.destroyed
          );
          if (asteroid) {
            setTimeout(() => this.handleAsteroidClick(asteroid), 250);
          }
        });
      });
      
      // Back buttons with enhanced transitions
      document.querySelectorAll('[id$="BackBtn"]').forEach(btn => {
        btn.addEventListener('click', () => {
          this.soundManager.play('back');
          this.hideAllScreens();
        });
      });
      
      // Mobile menu toggle with animation
      document.getElementById('menuToggle')?.addEventListener('click', () => {
        this.els.sidePanel.classList.toggle('open');
        this.soundManager.play('click');
      });
      
      // Enhanced tutorial navigation
      document.querySelectorAll('.tutNextBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          this.soundManager.play('click');
          this.nextTutorialSlide();
        });
      });
      document.querySelectorAll('.tutPrevBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          this.soundManager.play('click');
          this.prevTutorialSlide();
        });
      });
      document.querySelector('.tutEndBtn')?.addEventListener('click', () => {
        this.hideAllScreens();
        this.startGame();
      });
      
      // Enhanced customization events
      this.customization.bindEvents();
      
      // Analytics events
      this.analytics.bindEvents();
      
      // Advanced features
      this.bindAdvancedEvents();
    }
    
    bindAdvancedEvents() {
      // Leaderboard tabs
      document.querySelectorAll('.leaderboard-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          this.loadLeaderboard(tab.dataset.tab);
          this.soundManager.play('click');
        });
      });
      
      // Data management
      document.getElementById('exportDataBtn')?.addEventListener('click', () => this.exportGameData());
      document.getElementById('importDataBtn')?.addEventListener('click', () => this.importGameData());
      document.getElementById('backupBtn')?.addEventListener('click', () => this.backupToCloud());
      
      // Help shortcuts
      document.getElementById('helpGameBtn')?.addEventListener('click', () => this.showQuickHelp());
      
      // Advanced settings toggles
      this.bindSettingsToggles();
      
      // Shop enhanced events
      this.shop.bindEnhancedEvents();
      
      // Weather system events
      this.weatherSystem.bindEvents();
    }
    
    bindSettingsToggles() {
      const toggles = [
        'notifications', 'tutorials', 'autoSave', 'analyticsPermission'
      ];
      
      toggles.forEach(toggle => {
        const btn = document.getElementById(toggle + 'Btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const current = this.settings[toggle];
            this.settings[toggle] = !current;
            btn.textContent = btn.textContent.replace(current ? 'ON' : 'OFF', !current ? 'ON' : 'OFF');
            this.saveSettings();
            this.soundManager.play('click');
          });
        }
      });
    }
    
    addTouchFeedback(x, y) {
      const feedback = document.createElement('div');
      feedback.style.position = 'absolute';
      feedback.style.left = x + 'px';
      feedback.style.top = y + 'px';
      feedback.style.width = '30px';
      feedback.style.height = '30px';
      feedback.style.background = 'rgba(255,255,255,0.3)';
      feedback.style.borderRadius = '50%';
      feedback.style.pointerEvents = 'none';
      feedback.style.zIndex = '20';
      feedback.style.animation = 'touchFeedback 0.3s ease-out forwards';
      
      document.body.appendChild(feedback);
      setTimeout(() => feedback.remove(), 300);
    }
    
    // === ENHANCED GAME FLOW ===
    startGame() {
      const modeConfig = this.modes[this.state.mode];
      
      this.state = {
        ...this.state,
        score: 0,
        lives: modeConfig.lives + (this.shop.hasItem('extraLife') ? 1 : 0),
        combo: 1,
        maxCombo: 1,
        wave: 1,
        questionsAnswered: 0,
        correctAnswers: 0,
        asteroidsDestroyed: 0,
        powerupsCollected: 0,
        isPlaying: true,
        isPaused: false,
        startTime: Date.now(),
        currentShipLane: 1,
        streak: 0,
        lastAnswerTime: null,
        totalAnswerTime: 0,
        bossesDefeated: 0,
        perfectRounds: 0,
        invulnerableTime: 0
      };
      
      // Reset subject stats for this session
      Object.keys(this.state.subjectStats).forEach(subject => {
        this.state.subjectStats[subject] = { correct: 0, total: 0 };
      });
      
      this.hideAllScreens();
      this.clearField();
      this.updateUI();
      this.showWaveTransition();
      this.soundManager.play('start');
      
      // Show enhanced HUD elements
      this.els.timerDisplay.hidden = false;
      this.els.streakDisplay.hidden = false;
      
      // Start weather effects
      this.weatherSystem.startWeather();
      
      // Initialize AI tutor if purchased
      if (this.shop.hasItem('mathTutor')) {
        this.aiTutor.enable();
      }
      
      setTimeout(() => this.spawnQuestion(), 2000);
      
      // Update stats
      this.stats.gamesPlayed++;
      this.saveStats();
      
      // Achievement check
      this.achievements.check('explorer', this.countTriedModes());
    }
    
    countTriedModes() {
      const tried = new Set();
      // This would be tracked in real implementation
      return tried.size;
    }
    
    spawnQuestion() {
      if (!this.state.isPlaying || this.state.isPaused) return;
      
      const question = this.generateQuestion();
      this.state.currentAnswer = question.answer;
      this.currentQuestionType = question.type;
      this.els.question.textContent = question.text;
      
      // Track question timing
      this.state.lastAnswerTime = Date.now();
      
      // Update subject stats
      this.state.subjectStats[question.type].total++;
      
      // Spawn asteroids with answers
      const lanes = [0, 1, 2];
      const correctLane = Math.floor(Math.random() * 3);
      
      lanes.forEach((lane, index) => {
        const value = index === correctLane ? question.answer : this.generateWrongAnswer(question.answer, question.type);
        this.spawnAsteroid(lane, value, index === correctLane, question.type);
      });
      
      // Update mini map with enhanced visuals
      this.updateMiniMap();
      
      // Enhanced power-up spawning logic
      const powerupChance = this.config.powerupChance + (this.state.wave * 0.01);
      if (Math.random() < powerupChance) {
        this.spawnPowerup();
      }
      
      // Enhanced boss logic
      if (this.state.wave % this.config.bossInterval === 0 && this.state.questionsAnswered === 0) {
        this.spawnBoss();
      }
      
      // Special events
      this.checkSpecialEvents();
    }
    
    checkSpecialEvents() {
      // Meteor shower event
      if (this.state.wave % 7 === 0 && Math.random() < 0.3) {
        this.weatherSystem.startMeteorShower();
      }
      
      // Double power-up event
      if (this.state.combo >= 15 && Math.random() < 0.4) {
        this.spawnPowerup();
        this.showNotification('Combo Bonus Power-up! 🎁', 'premium');
      }
    }
    
    generateQuestion() {
      const wave = this.state.wave;
      const types = this.getQuestionTypesForWave(wave);
      let type = types[Math.floor(Math.random() * types.length)];
      
      // Adaptive difficulty adjustment
      if (this.adaptiveDifficulty) {
        type = this.adjustDifficultyBasedOnPerformance(type);
      }
      
      switch(type) {
        case 'basic':
          return this.generateBasicMath(wave);
        case 'algebra':
          return this.generateAlgebra(wave);
        case 'geometry':
          return this.generateGeometry(wave);
        case 'fraction':
          return this.generateFraction(wave);
        case 'percentage':
          return this.generatePercentage(wave);
        case 'trigonometry':
          return this.generateTrigonometry(wave);
        case 'calculus':
          return this.generateCalculus(wave);
        case 'statistics':
          return this.generateStatistics(wave);
        case 'word':
          return this.generateWordProblem(wave);
        case 'advanced':
          return this.generateAdvanced(wave);
        default:
          return this.generateBasicMath(wave);
      }
    }
    
    adjustDifficultyBasedOnPerformance(type) {
      const stats = this.state.subjectStats[type];
      const accuracy = stats.total > 0 ? stats.correct / stats.total : 0.5;
      
      // If accuracy is high, increase difficulty
      if (accuracy > 0.8 && this.state.wave > 5) {
        const hardTypes = ['calculus', 'trigonometry', 'advanced'];
        if (hardTypes.includes(type)) return type;
        return hardTypes[Math.floor(Math.random() * hardTypes.length)];
      }
      
      // If accuracy is low, provide easier questions
      if (accuracy < 0.4) {
        return Math.random() < 0.5 ? 'basic' : 'fraction';
      }
      
      return type;
    }
    
    getQuestionTypesForWave(wave) {
      if (wave <= 2) return ['basic'];
      if (wave <= 5) return ['basic', 'basic', 'fraction'];
      if (wave <= 8) return ['basic', 'fraction', 'percentage'];
      if (wave <= 12) return ['basic', 'algebra', 'geometry', 'fraction'];
      if (wave <= 15) return ['algebra', 'geometry', 'percentage', 'word'];
      if (wave <= 20) return ['algebra', 'geometry', 'trigonometry', 'statistics'];
      if (wave <= 25) return ['trigonometry', 'calculus', 'statistics', 'advanced'];
      return ['calculus', 'trigonometry', 'advanced', 'statistics'];
    }
    
    // Enhanced question generators
    generateBasicMath(wave) {
      const max = 10 + wave * 2;
      const a = Math.floor(Math.random() * max) + 1;
      const b = Math.floor(Math.random() * max) + 1;
      const ops = wave > 3 ? ['+', '-', '×', '÷'] : ['+', '-', '×'];
      const op = ops[Math.floor(Math.random() * ops.length)];
      
      let answer, text;
      switch(op) {
        case '+':
          answer = a + b;
          text = `${a} + ${b} = ?`;
          break;
        case '-':
          answer = Math.max(a, b) - Math.min(a, b);
          text = `${Math.max(a, b)} - ${Math.min(a, b)} = ?`;
          break;
        case '×':
          answer = a * b;
          text = `${a} × ${b} = ?`;
          break;
        case '÷':
          answer = a;
          text = `${a * b} ÷ ${b} = ?`;
          break;
      }
      
      return { type: 'basic', text, answer };
    }
    
    generateAlgebra(wave) {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 20) + 1;
      const c = Math.floor(Math.random() * 15) + 1;
      
      const patterns = [
        { text: `x + ${a} = ${a + b}`, answer: b },
        { text: `${a}x = ${a * b}`, answer: b },
        { text: `x - ${a} = ${b}`, answer: a + b },
        { text: `x ÷ ${a} = ${b}`, answer: a * b },
        { text: `${a}x + ${b} = ${a * c + b}`, answer: c },
        { text: `${a}(x + ${b}) = ${a * (c + b)}`, answer: c }
      ];
      
      const pattern = patterns[Math.floor(Math.random() * Math.min(patterns.length, 2 + Math.floor(wave / 5)))];
      return { type: 'algebra', ...pattern };
    }
    
    generateGeometry(wave) {
      const shapes = [
        {
          name: 'square',
          question: (side) => `Square area: side = ${side}`,
          answer: (side) => side * side
        },
        {
          name: 'rectangle',
          question: (a, b) => `Rectangle area: ${a} × ${b}`,
          answer: (a, b) => a * b
        },
        {
          name: 'triangle',
          question: (base, height) => `Triangle area: base ${base}, height ${height}`,
          answer: (base, height) => Math.round((base * height) / 2)
        },
        {
          name: 'circle',
          question: (r) => `Circle area: radius = ${r} (use π ≈ 3.14)`,
          answer: (r) => Math.round(3.14 * r * r)
        },
        {
          name: 'cube',
          question: (side) => `Cube volume: side = ${side}`,
          answer: (side) => side * side * side
        }
      ];
      
      const shape = shapes[Math.floor(Math.random() * Math.min(shapes.length, 2 + Math.floor(wave / 5)))];
      const a = Math.floor(Math.random() * 8) + 2;
      const b = Math.floor(Math.random() * 8) + 2;
      
      return {
        type: 'geometry',
        text: shape.question(a, b),
        answer: shape.answer(a, b)
      };
    }
    
    generateFraction(wave) {
      const denominators = [2, 3, 4, 5, 6, 8, 10, 12];
      const d = denominators[Math.floor(Math.random() * Math.min(denominators.length, 3 + Math.floor(wave / 3)))];
      const n1 = Math.floor(Math.random() * d) + 1;
      const n2 = Math.floor(Math.random() * d) + 1;
      
      const patterns = [
        {
          text: `${n1}/${d} + ${n2}/${d} = ?/${d}`,
          answer: n1 + n2
        },
        {
          text: `${Math.max(n1, n2)}/${d} - ${Math.min(n1, n2)}/${d} = ?/${d}`,
          answer: Math.abs(n1 - n2)
        },
        {
          text: `Simplify: ${n1 * 2}/${d * 2} = ?/${d}`,
          answer: n1
        }
      ];
      
      const pattern = patterns[Math.floor(Math.random() * Math.min(patterns.length, 1 + Math.floor(wave / 7)))];
      return { type: 'fraction', ...pattern };
    }
    
    generatePercentage(wave) {
      const values = [10, 20, 25, 30, 40, 50, 60, 75, 80, 90];
      const percent = values[Math.floor(Math.random() * values.length)];
      const base = (Math.floor(Math.random() * 10) + 1) * 10;
      
      const patterns = [
        {
          text: `${percent}% of ${base} = ?`,
          answer: (percent * base) / 100
        },
        {
          text: `What % of ${base} is ${(percent * base) / 100}?`,
          answer: percent
        },
        {
          text: `${(percent * base) / 100} is ${percent}% of ?`,
          answer: base
        }
      ];
      
      const pattern = patterns[Math.floor(Math.random() * Math.min(patterns.length, 1 + Math.floor(wave / 8)))];
      return { type: 'percentage', ...pattern };
    }
    
    generateTrigonometry(wave) {
      const angles = [0, 30, 45, 60, 90];
      const angle = angles[Math.floor(Math.random() * angles.length)];
      const functions = ['sin', 'cos', 'tan'];
      const func = functions[Math.floor(Math.random() * functions.length)];
      
      const values = {
        sin: { 0: 0, 30: 0.5, 45: 0.71, 60: 0.87, 90: 1 },
        cos: { 0: 1, 30: 0.87, 45: 0.71, 60: 0.5, 90: 0 },
        tan: { 0: 0, 30: 0.58, 45: 1, 60: 1.73, 90: 'undefined' }
      };
      
      const answer = values[func][angle];
      if (answer === 'undefined') {
        return this.generateTrigonometry(wave); // Retry
      }
      
      return {
        type: 'trigonometry',
        text: `${func}(${angle}°) = ? (rounded to 2 decimal places)`,
        answer: Math.round(answer * 100) / 100
      };
    }
    
    generateCalculus(wave) {
      const x = Math.floor(Math.random() * 5) + 1;
      const power = Math.floor(Math.random() * 4) + 2;
      
      const problems = [
        {
          text: `d/dx(x²) = ?`,
          answer: '2x'
        },
        {
          text: `d/dx(${power}x³) = ?`,
          answer: `${power * 3}x²`
        },
        {
          text: `∫ 2x dx = ? + C`,
          answer: 'x²'
        },
        {
          text: `If f(x) = x² + ${x}, then f'(x) = ?`,
          answer: '2x'
        }
      ];
      
      const problem = problems[Math.floor(Math.random() * Math.min(problems.length, 1 + Math.floor(wave / 10)))];
      
      // Convert symbolic answers to numeric when possible
      if (typeof problem.answer === 'string') {
        // For demo purposes, convert some symbolic answers to numbers
        if (problem.answer === '2x' && x === 1) problem.answer = 2;
        else if (problem.answer === 'x²' && x === 2) problem.answer = 4;
        else return this.generateBasicMath(wave); // Fallback
      }
      
      return { type: 'calculus', ...problem };
    }
    
    generateStatistics(wave) {
      const data = [];
      const size = 3 + Math.floor(Math.random() * 4);
      for (let i = 0; i < size; i++) {
        data.push(Math.floor(Math.random() * 20) + 1);
      }
      
      const problems = [
        {
          text: `Mean of [${data.join(', ')}] = ?`,
          answer: Math.round(data.reduce((a, b) => a + b, 0) / data.length)
        },
        {
          text: `Median of [${data.sort((a, b) => a - b).join(', ')}] = ?`,
          answer: data[Math.floor(data.length / 2)]
        },
        {
          text: `Range of [${data.join(', ')}] = ?`,
          answer: Math.max(...data) - Math.min(...data)
        }
      ];
      
      const problem = problems[Math.floor(Math.random() * Math.min(problems.length, 1 + Math.floor(wave / 12)))];
      return { type: 'statistics', ...problem };
    }
    
    generateWordProblem(wave) {
      const problems = [
        {
          text: "A ship has {a} shields. It collects {b} more. Total shields?",
          calc: (a, b) => a + b
        },
        {
          text: "{a} asteroids approach. {b} are destroyed. How many remain?",
          calc: (a, b) => a - b
        },
        {
          text: "{a} waves with {b} asteroids each. Total asteroids?",
          calc: (a, b) => a * b
        },
        {
          text: "{a} power-ups shared among {b} players. Each gets how many?",
          calc: (a, b) => Math.floor(a / b)
        },
        {
          text: "Ship travels {a} units in {b} seconds. Speed per second?",
          calc: (a, b) => Math.round(a / b)
        }
      ];
      
      const problem = problems[Math.floor(Math.random() * Math.min(problems.length, 2 + Math.floor(wave / 6)))];
      const a = Math.floor(Math.random() * 50) + 10;
      const b = Math.floor(Math.random() * 10) + 2;
      
      return {
        type: 'word',
        text: problem.text.replace('{a}', a).replace('{b}', b),
        answer: problem.calc(a, b)
      };
    }
    
    generateAdvanced(wave) {
      const problems = [
        {
          text: `√${Math.pow(Math.floor(Math.random() * 10) + 2, 2)} = ?`,
          answer: Math.sqrt(Math.pow(Math.floor(Math.random() * 10) + 2, 2))
        },
        {
          text: `2³ + 3² = ?`,
          answer: 8 + 9
        },
        {
          text: `log₂(8) = ?`,
          answer: 3
        }
      ];
      
      const problem = problems[Math.floor(Math.random() * problems.length)];
      return { type: 'advanced', ...problem };
    }
    
    generateWrongAnswer(correct, type) {
      let wrong;
      do {
        const offset = Math.floor(Math.random() * 20) - 10;
        wrong = correct + offset;
        
        // Type-specific wrong answer generation
        if (type === 'percentage') {
          wrong = Math.max(0, Math.min(100, wrong));
        } else if (type === 'fraction') {
          wrong = Math.max(1, wrong);
        }
        
      } while (wrong === correct || wrong < 0);
      return wrong;
    }
    
    // [Previous methods continue with enhancements...]
    
    spawnAsteroid(lane, value, isCorrect, type = 'basic') {
      const asteroid = document.createElement('div');
      asteroid.className = `asteroid type-${type}`;
      asteroid.style.left = `${33.333 * lane + 16.666}%`;
      asteroid.style.animationDuration = `${this.state.speed * this.state.speedMultiplier}ms`;
      
      const body = document.createElement('div');
      body.className = 'asteroid-body';
      body.textContent = value;
      
      // Add multiple craters for realism
      for (let i = 0; i < Math.floor(Math.random() * 3) + 1; i++) {
        const crater = document.createElement('div');
        crater.className = 'asteroid-crater';
        crater.style.top = Math.random() * 70 + 10 + '%';
        crater.style.left = Math.random() * 70 + 10 + '%';
        crater.style.width = Math.random() * 15 + 10 + '%';
        crater.style.height = crater.style.width;
        body.appendChild(crater);
      }
      
      asteroid.appendChild(body);
      asteroid.dataset.correct = isCorrect;
      asteroid.dataset.lane = lane;
      asteroid.dataset.value = value;
      asteroid.dataset.type = type;
      
      // Enhanced interaction
      asteroid.addEventListener('click', () => this.handleAsteroidClick(asteroid));
      asteroid.addEventListener('animationend', () => this.handleAsteroidMiss(asteroid));
      
      // Add hover effects for desktop
      asteroid.addEventListener('mouseenter', () => {
        if (this.state.isPlaying && !this.state.isPaused) {
          asteroid.style.transform = 'scale(1.05)';
          this.particleSystem.createTrail(
            asteroid.offsetLeft + asteroid.offsetWidth / 2,
            asteroid.offsetTop + asteroid.offsetHeight / 2
          );
        }
      });
      
      asteroid.addEventListener('mouseleave', () => {
        asteroid.style.transform = 'scale(1)';
      });
      
      this.els.gameArea.appendChild(asteroid);
      this.asteroids.push(asteroid);
    }
    
    spawnPowerup() {
      const types = [
        { id: 'shield', icon: '🛡️', color: '#00f', rarity: 'common' },
        { id: 'life', icon: '❤️', color: '#f00', rarity: 'uncommon' },
        { id: 'slow', icon: '⏱️', color: '#0ff', rarity: 'common' },
        { id: 'double', icon: '2x', color: '#ff0', rarity: 'uncommon' },
        { id: 'bomb', icon: '💣', color: '#f60', rarity: 'rare' },
        { id: 'mega', icon: '⭐', color: 'rainbow', rarity: 'legendary' },
        { id: 'freeze', icon: '❄️', color: '#0af', rarity: 'rare' },
        { id: 'magnet', icon: '🧲', color: '#a0a', rarity: 'uncommon' }
      ];
      
      // Rarity-based selection
      const rarities = {
        common: 0.5,
        uncommon: 0.3,
        rare: 0.15,
        legendary: 0.05
      };
      
      const random = Math.random();
      let selectedRarity = 'common';
      let cumulative = 0;
      
      for (const [rarity, chance] of Object.entries(rarities)) {
        cumulative += chance;
        if (random <= cumulative) {
          selectedRarity = rarity;
          break;
        }
      }
      
      const availableTypes = types.filter(t => t.rarity === selectedRarity);
      const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
      
      const powerup = document.createElement('div');
      powerup.className = `powerup type-${type.id} type-${type.rarity}`;
      powerup.style.left = `${Math.random() * 80 + 10}%`;
      powerup.style.animationDuration = `${this.state.speed * this.state.speedMultiplier * 1.5}ms`;
      
      const body = document.createElement('div');
      body.className = 'powerup-body';
      body.textContent = type.icon;
      
      // Add multiple rings for rarer power-ups
      const ringCount = { common: 1, uncommon: 2, rare: 3, legendary: 4 }[type.rarity];
      for (let i = 0; i < ringCount; i++) {
        const ring = document.createElement('div');
        ring.className = 'powerup-ring';
        ring.style.animationDelay = (i * 0.3) + 's';
        body.appendChild(ring);
      }
      
      powerup.appendChild(body);
      powerup.dataset.type = type.id;
      powerup.dataset.rarity = type.rarity;
      
      powerup.addEventListener('click', () => this.collectPowerup(powerup));
      powerup.addEventListener('animationend', () => powerup.remove());
      
      this.els.gameArea.appendChild(powerup);
      this.powerups.push(powerup);
    }
    
    collectPowerup(powerup) {
      const type = powerup.dataset.type;
      const rarity = powerup.dataset.rarity;
      const rect = powerup.getBoundingClientRect();
      
      this.state.powerupsCollected++;
      
      // Enhanced particle effects based on rarity
      const colors = {
        common: '#00ff00',
        uncommon: '#0080ff',
        rare: '#ff0080',
        legendary: '#ffd700'
      };
      
      this.particleSystem.createExplosion(
        rect.left + rect.width / 2,
        rect.top + rect.height / 2,
        colors[rarity],
        rarity === 'legendary' ? 40 : 20
      );
      
      this.soundManager.play(`powerup_${rarity}`);
      
      switch(type) {
        case 'shield':
          this.state.shieldActive = true;
          this.els.ship.classList.add('shielded');
          this.showNotification('Shield Active! 🛡️', 'info');
          break;
          
        case 'life':
          this.state.lives = Math.min(this.state.lives + 1, this.config.maxLives);
          this.showNotification('+1 Life! ❤️', 'achievement');
          break;
          
        case 'slow':
          this.activateTimeSlow();
          break;
          
        case 'double':
          this.activateDoubleScore();
          break;
          
        case 'bomb':
          this.clearAllAsteroids();
          this.showNotification('Bomb Cleared Field! 💣', 'warning');
          break;
          
        case 'freeze':
          this.activateFreeze();
          break;
          
        case 'magnet':
          this.activateMagnet();
          break;
          
        case 'mega':
          this.activateMegaPower();
          break;
      }
      
      powerup.remove();
      this.powerups = this.powerups.filter(p => p !== powerup);
      this.updateUI();
      
      // Enhanced achievement checks
      this.achievements.check('collector', this.state.powerupsCollected);
      this.achievements.check('hoarder', this.stats.powerupsUsed + this.state.powerupsCollected);
    }
    
    activateTimeSlow() {
      this.state.timeSlowActive = true;
      this.showNotification('Time Slowed! ⏱️', 'info');
      
      // Apply slow effect to all asteroids
      this.asteroids.forEach(asteroid => {
        asteroid.style.animationDuration = (parseInt(asteroid.style.animationDuration) * 2) + 'ms';
      });
      
      setTimeout(() => {
        this.state.timeSlowActive = false;
        this.asteroids.forEach(asteroid => {
          asteroid.style.animationDuration = (parseInt(asteroid.style.animationDuration) / 2) + 'ms';
        });
      }, 10000);
    }
    
    activateDoubleScore() {
      this.state.doubleScoreActive = true;
      this.showNotification('Double Score Active! 2x', 'premium');
      
      setTimeout(() => {
        this.state.doubleScoreActive = false;
        this.showNotification('Double score ended', 'info');
      }, 15000);
    }
    
    activateFreeze() {
      this.asteroids.forEach(asteroid => {
        asteroid.classList.add('frozen');
        asteroid.style.animationPlayState = 'paused';
      });
      
      this.showNotification('Asteroids Frozen! ❄️', 'info');
      
      setTimeout(() => {
        this.asteroids.forEach(asteroid => {
          asteroid.classList.remove('frozen');
          asteroid.style.animationPlayState = 'running';
        });
        this.showNotification('Freeze effect ended', 'info');
      }, 8000);
    }
    
    activateMagnet() {
      // Auto-collect nearby power-ups
      this.powerups.forEach(powerup => {
        const rect = powerup.getBoundingClientRect();
        const shipRect = this.els.ship.getBoundingClientRect();
        const distance = Math.sqrt(
          Math.pow(rect.left - shipRect.left, 2) + 
          Math.pow(rect.top - shipRect.top, 2)
        );
        
        if (distance < 200) {
          this.collectPowerup(powerup);
        }
      });
      
      this.showNotification('Magnet Effect! 🧲', 'info');
    }
    
    activateMegaPower() {
      this.state.shieldActive = true;
      this.state.doubleScoreActive = true;
      this.state.lives = Math.min(this.state.lives + 2, this.config.maxLives);
      this.state.invulnerableTime = Date.now() + 20000;
      
      this.els.ship.classList.add('shielded', 'boosted', 'invulnerable');
      this.showNotification('MEGA POWER ACTIVATED!!! ⭐', 'legendary');
      
      // Screen flash effect
      document.body.style.animation = 'megaFlash 0.5s ease-in-out 3';
      
      setTimeout(() => {
        this.state.doubleScoreActive = false;
        this.els.ship.classList.remove('boosted', 'invulnerable');
        document.body.style.animation = '';
      }, 20000);
    }
    
    // Enhanced boss system
    spawnBoss() {
      this.showNotification('⚠️ BOSS INCOMING! ⚠️', 'warning');
      document.body.insertAdjacentHTML('beforeend', '<div class="bossWarning"></div>');
      
      // Add boss health bar
      const healthBar = document.createElement('div');
      healthBar.className = 'bossHealthBar';
      healthBar.innerHTML = `
        <div class="bossHealthFill" id="bossHealth"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:0.7rem;z-index:1">
          BOSS ASTEROID
        </div>
      `;
      document.body.appendChild(healthBar);
      
      setTimeout(() => {
        document.querySelector('.bossWarning')?.remove();
        
        const boss = document.createElement('div');
        boss.className = 'asteroid type-boss';
        boss.style.left = '50%';
        boss.style.transform = 'translateX(-50%)';
        boss.style.animationDuration = '12000ms';
        
        const body = document.createElement('div');
        body.className = 'asteroid-body';
        body.textContent = '???';
        boss.appendChild(body);
        
        boss.dataset.isBoss = 'true';
        boss.dataset.health = '5';
        boss.dataset.maxHealth = '5';
        
        this.els.gameArea.appendChild(boss);
        this.asteroids.push(boss);
        
        // Enhanced boss problem generation
        const problem = this.generateBossProblem();
        this.els.question.textContent = problem.text;
        this.state.currentAnswer = problem.answer;
        
        this.soundManager.play('boss_music');
        
      }, 2000);
    }
    
    generateBossProblem() {
      const wave = this.state.wave;
      const complexProblems = [
        {
          text: `(${wave + 5} + ${wave + 3}) × ${wave + 2} = ?`,
          answer: (wave + 5 + wave + 3) * (wave + 2)
        },
        {
          text: `√(${Math.pow(wave + 4, 2)}) + ${wave * 2} = ?`,
          answer: (wave + 4) + (wave * 2)
        },
        {
          text: `${wave}² - ${wave - 1}² = ?`,
          answer: Math.pow(wave, 2) - Math.pow(wave - 1, 2)
        }
      ];
      
      return complexProblems[Math.floor(Math.random() * complexProblems.length)];
    }
    
    // Enhanced answer processing
    processAnswer(correct, asteroid) {
      this.state.questionsAnswered++;
      
      // Calculate answer time
      const answerTime = Date.now() - this.state.lastAnswerTime;
      this.state.totalAnswerTime += answerTime;
      this.state.averageAnswerTime = this.state.totalAnswerTime / this.state.questionsAnswered;
      
      const rect = asteroid.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      if (correct) {
        this.processCorrectAnswer(asteroid, answerTime, centerX, centerY);
      } else {
        this.processWrongAnswer(asteroid, centerX, centerY);
      }
      
      // Update analytics
      this.analytics.recordAnswer(this.currentQuestionType, correct, answerTime);
      
      // Clear field for next question
      this.clearField();
      this.updateUI();
      
      // Check game state
      if (this.state.lives <= 0) {
        this.gameOver();
      } else {
        this.proceedToNextQuestion();
      }
    }
    
    processCorrectAnswer(asteroid, answerTime, centerX, centerY) {
      this.state.correctAnswers++;
      this.state.asteroidsDestroyed++;
      this.state.streak++;
      
      if (this.state.streak > this.state.maxStreak) {
        this.state.maxStreak = this.state.streak;
      }
      
      // Update subject stats
      this.state.subjectStats[this.currentQuestionType].correct++;
      
      // Enhanced scoring system
      let baseScore = 10;
      
      // Speed bonus
      if (answerTime < 3000) baseScore += 5;
      if (answerTime < 2000) baseScore += 10;
      if (answerTime < 1000) baseScore += 20;
      
      // Difficulty bonus
      const difficultyMultiplier = {
        basic: 1, algebra: 1.2, geometry: 1.3, fraction: 1.1,
        trigonometry: 1.5, calculus: 1.8, statistics: 1.4, advanced: 2.0
      }[this.currentQuestionType] || 1;
      
      baseScore = Math.floor(baseScore * difficultyMultiplier);
      
      // Combo bonus
      const comboBonus = (this.state.combo - 1) * (this.shop.hasItem('comboBoost') ? 2 : 1);
      const totalScore = baseScore + comboBonus;
      
      // Apply score multipliers
      const finalScore = this.state.doubleScoreActive ? totalScore * 2 : totalScore;
      this.state.score += finalScore;
      
      // Update combo
      this.state.combo++;
      if (this.state.combo > this.state.maxCombo) {
        this.state.maxCombo = this.state.combo;
      }
      
      // Enhanced visual effects
      this.particleSystem.createExplosion(centerX, centerY, '#2ec4b6', 25);
      this.soundManager.play('correct');
      
      // Show score popup
      this.showScorePopup(centerX, centerY, finalScore);
      
      // Screen effects
      this.els.gameArea.classList.add('flash');
      setTimeout(() => this.els.gameArea.classList.remove('flash'), 400);
      
      // Enhanced achievement checks
      this.checkAnswerAchievements(answerTime);
      
      // Coins
      const coinEarned = Math.floor(finalScore * this.config.coinMultiplier);
      this.state.coins += coinEarned;
      
      // Boss damage
      if (asteroid.dataset.isBoss === 'true') {
        this.damageBoss(asteroid);
      } else {
        asteroid.dataset.destroyed = 'true';
      }
    }
    
    processWrongAnswer(asteroid, centerX, centerY) {
      this.state.combo = 1;
      this.state.streak = 0;
      
      if (!this.state.shieldActive && Date.now() > this.state.invulnerableTime) {
        this.state.lives--;
        this.particleSystem.createExplosion(centerX, centerY, '#e71d36', 30);
        this.soundManager.play('wrong');
        
        // Enhanced screen shake
        document.body.classList.add('screenShake');
        setTimeout(() => document.body.classList.remove('screenShake'), 500);
        
        // Show explanation if AI tutor is active
        if (this.shop.hasItem('mathTutor')) {
          this.aiTutor.showExplanation(this.currentQuestionType, this.state.currentAnswer);
        }
      } else if (this.state.shieldActive) {
        this.state.shieldActive = false;
        this.els.ship.classList.remove('shielded');
        this.showNotification('Shield absorbed damage! 🛡️', 'info');
        this.soundManager.play('shield_break');
      }
    }
    
    damageBoss(boss) {
      const currentHealth = parseInt(boss.dataset.health);
      const maxHealth = parseInt(boss.dataset.maxHealth);
      const newHealth = currentHealth - 1;
      
      boss.dataset.health = newHealth;
      
      // Update boss health bar
      const healthBar = document.getElementById('bossHealth');
      if (healthBar) {
        healthBar.style.width = (newHealth / maxHealth * 100) + '%';
      }
      
      if (newHealth <= 0) {
        // Boss defeated
        this.state.bossesDefeated++;
        boss.dataset.destroyed = 'true';
        
        // Remove health bar
        document.querySelector('.bossHealthBar')?.remove();
        
        // Special effects
        this.particleSystem.createExplosion(
          boss.offsetLeft + boss.offsetWidth / 2,
          boss.offsetTop + boss.offsetHeight / 2,
          '#ff6600',
          50
        );
        
        // Bonus rewards
        this.state.score += 500;
        this.state.coins += 50;
        
        this.showNotification('🎉 BOSS DEFEATED! +500 POINTS! 🎉', 'legendary');
        this.soundManager.play('boss_defeat');
        
        // Achievement
        this.achievements.check('bossSlayer', this.state.bossesDefeated);
        this.achievements.check('bossHunter', this.state.bossesDefeated);
      } else {
        // Boss takes damage
        boss.classList.add('critical');
        setTimeout(() => boss.classList.remove('critical'), 500);
        this.showNotification(`Boss Health: ${newHealth}/${maxHealth}`, 'warning');
      }
    }
    
    showScorePopup(x, y, score) {
      const popup = document.createElement('div');
      popup.style.position = 'absolute';
      popup.style.left = x + 'px';
      popup.style.top = y + 'px';
      popup.style.color = this.state.doubleScoreActive ? '#ffd700' : '#2ec4b6';
      popup.style.fontSize = '1.2rem';
      popup.style.fontWeight = 'bold';
      popup.style.pointerEvents = 'none';
      popup.style.zIndex = '25';
      popup.style.textShadow = '2px 2px 0 #000';
      popup.textContent = `+${score}`;
      popup.style.animation = 'scorePopup 2s ease-out forwards';
      
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 2000);
    }
    
    checkAnswerAchievements(answerTime) {
      // Speed achievements
      if (answerTime < 5000) {
        this.achievements.incrementProgress('speedster');
      }
      if (answerTime < 3000) {
        this.achievements.incrementProgress('lightning');
      }
      
      // Combo achievements
      if (this.state.combo === 5) {
        this.showNotification('5x Combo! 🔥', 'achievement');
        this.achievements.unlock('combo5');
      }
      if (this.state.combo === 10) {
        this.showNotification('10x COMBO!! 💥', 'achievement');
        this.achievements.unlock('combo10');
      }
      if (this.state.combo === 25) {
        this.showNotification('25x MEGA COMBO!!! ⚡', 'achievement');
        this.achievements.unlock('combo25');
      }
      
      // Subject mastery
      const subjectStats = this.state.subjectStats[this.currentQuestionType];
      if (subjectStats.correct >= 100) {
        this.achievements.unlock(this.currentQuestionType + 'Master');
      }
    }
    
    proceedToNextQuestion() {
      // Check for perfect round
      if (this.state.questionsAnswered % 10 === 0) {
        const roundAccuracy = this.state.correctAnswers / this.state.questionsAnswered;
        if (roundAccuracy === 1.0) {
          this.state.perfectRounds++;
          this.showNotification('🌟 PERFECT ROUND! 🌟', 'legendary');
          this.achievements.check('perfect', this.state.perfectRounds);
        }
      }
      
      // Wave progression
      if (this.state.questionsAnswered % 5 === 0) {
        this.nextWave();
      } else {
        setTimeout(() => this.spawnQuestion(), 1000);
      }
    }
    
    nextWave() {
      this.state.wave++;
      this.updateSpeed();
      this.showWaveTransition();
      
      // Achievement checks
      this.achievements.check('survivor', this.state.wave);
      this.achievements.check('veteran', this.state.wave);
      this.achievements.check('legend', this.state.wave);
      
      // Mode completion check
      const modeConfig = this.modes[this.state.mode];
      if (modeConfig.waves !== Infinity && this.state.wave > modeConfig.waves) {
        this.victory();
      } else {
        setTimeout(() => this.spawnQuestion(), 2000);
      }
    }
    
    // Enhanced UI update system
    updateUI() {
      // Main HUD
      this.els.score.textContent = `Score: ${this.state.score.toLocaleString()}`;
      this.els.lives.innerHTML = `Lives: ${'❤'.repeat(Math.max(0, this.state.lives))}`;
      this.els.combo.textContent = `Combo: x${this.state.combo}`;
      
      // Enhanced combo meter
      const comboPercent = Math.min(100, (this.state.combo - 1) * 4);
      this.els.comboFill.style.width = `${comboPercent}%`;
      
      // Timer display
      if (this.state.isPlaying) {
        const elapsed = Math.floor((Date.now() - this.state.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        this.els.timerDisplay.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Streak display
        this.els.streakDisplay.textContent = `Streak: ${this.state.streak}`;
      }
      
      // Side panel updates
      this.els.currentWave.textContent = this.state.wave;
      this.els.threatLevel.textContent = this.getThreatLevel();
      this.els.destroyedCount.textContent = this.state.asteroidsDestroyed;
      
      const accuracy = this.state.questionsAnswered > 0
        ? Math.round((this.state.correctAnswers / this.state.questionsAnswered) * 100)
        : 100;
      this.els.accuracyRate.textContent = accuracy + '%';
      
      // Session time
      if (this.state.sessionStartTime) {
        const sessionElapsed = Math.floor((Date.now() - this.state.sessionStartTime) / 1000);
        const sessionMinutes = Math.floor(sessionElapsed / 60);
        const sessionSeconds = sessionElapsed % 60;
        this.els.sessionTime.textContent = `${sessionMinutes}:${sessionSeconds.toString().padStart(2, '0')}`;
      }
      
      // Current coins
      this.els.currentCoins.textContent = this.state.coins;
      
      // Wave progress indicator
      const waveProgress = (this.state.questionsAnswered % 5) * 20;
      const progressFill = document.querySelector('.wave-progress-fill');
      if (progressFill) {
        progressFill.style.width = waveProgress + '%';
      }
      
      // Update analytics charts
      this.analytics.updateCharts();
    }
    
    getThreatLevel() {
      if (this.state.wave <= 3) return 'LOW';
      if (this.state.wave <= 8) return 'MEDIUM';
      if (this.state.wave <= 15) return 'HIGH';
      if (this.state.wave <= 25) return 'EXTREME';
      return 'NIGHTMARE';
    }
    
    updateMiniMap() {
      this.els.miniMap.querySelector('.radarSweep')?.remove();
      
      // Re-add radar sweep
      const radarSweep = document.createElement('div');
      radarSweep.className = 'radarSweep';
      this.els.miniMap.appendChild(radarSweep);
      
      // Clear existing dots
      this.els.miniMap.querySelectorAll('.miniMapDot').forEach(dot => dot.remove());
      
      // Add ship dot
      const shipDot = document.createElement('div');
      shipDot.className = 'miniMapDot ship';
      shipDot.style.left = `${33.333 * this.state.currentShipLane + 16.666}%`;
      shipDot.style.bottom = '10%';
      this.els.miniMap.appendChild(shipDot);
      
      // Add asteroid dots
      this.asteroids.forEach(asteroid => {
        const dot = document.createElement('div');
        dot.className = `miniMapDot asteroid ${asteroid.dataset.type}`;
        const lane = parseInt(asteroid.dataset.lane);
        dot.style.left = `${33.333 * lane + 16.666}%`;
        dot.style.top = '20%';
        
        if (asteroid.dataset.correct === 'true') {
          dot.style.background = '#0f0';
          dot.style.boxShadow = '0 0 10px #0f0';
        }
        
        this.els.miniMap.appendChild(dot);
      });
      
      // Add power-up dots
      this.powerups.forEach(powerup => {
        const dot = document.createElement('div');
        dot.className = 'miniMapDot powerup';
        dot.style.left = powerup.style.left;
        dot.style.top = '30%';
        this.els.miniMap.appendChild(dot);
      });
    }
    
    // Enhanced notification system
    showNotification(text, type = 'default', duration = 4000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = text;
      document.body.appendChild(notification);
      
      // Enhanced animations based on type
      if (type === 'legendary') {
        notification.style.animation = 'legendaryNotification 6s forwards';
      } else if (type === 'achievement') {
        notification.style.animation = 'achievementNotification 5s forwards';
      }
      
      setTimeout(() => notification.remove(), duration);
      
      // Add to notification history
      this.notifications.push({
        text,
        type,
        timestamp: Date.now()
      });
      
      // Keep only last 10 notifications
      if (this.notifications.length > 10) {
        this.notifications.shift();
      }
    }
    
    // Enhanced screen management
    hideAllScreens() {
      const screens = [
        'startScreen', 'tutorialScreen', 'shopScreen', 
        'achievementScreen', 'leaderboardScreen', 'settingsScreen',
        'analyticsScreen', 'helpScreen', 'customizeScreen', 'multiplayerScreen'
      ];
      screens.forEach(id => {
        const screen = document.getElementById(id);
        if (screen) {
          screen.hidden = true;
          screen.style.animation = 'screenFadeOut 0.3s ease-in';
        }
      });
    }
    
    showAnalytics() {
      this.hideAllScreens();
      this.els.analyticsScreen.hidden = false;
      this.analytics.updateDisplay();
    }
    
    showCustomization() {
      this.hideAllScreens();
      this.els.customizeScreen.hidden = false;
      this.customization.updateDisplay();
    }
    
    showHelp() {
      this.hideAllScreens();
      this.els.helpScreen.hidden = false;
    }
    
    showMultiplayer() {
      this.hideAllScreens();
      this.els.multiplayerScreen.hidden = false;
    }
    
    showQuickHelp() {
      this.showNotification(`
        <strong>Quick Help:</strong><br>
        ← → : Move ship<br>
        ↓ S : Fire/Select<br>
        ESC : Pause<br>
        Click asteroids directly
      `, 'info', 6000);
    }
    
    // Enhanced settings
    cycleTheme() {
      const themes = this.config.themes;
      const current = this.currentTheme || 0;
      const next = (current + 1) % themes.length;
      
      document.body.className = themes[next] === 'space' ? '' : `theme-${themes[next]}`;
      document.getElementById('themeBtn').textContent = `🌌 THEME: ${themes[next].toUpperCase()}`;
      
      this.currentTheme = next;
      this.settings.theme = themes[next];
      this.saveSettings();
      
      this.showNotification(`Theme changed to ${themes[next]}!`, 'info');
    }
    
    cycleDifficulty() {
      const difficulties = this.config.difficulties;
      const current = this.settings.difficulty || 'normal';
      const currentIndex = difficulties.indexOf(current);
      const next = difficulties[(currentIndex + 1) % difficulties.length];
      
      this.settings.difficulty = next;
      document.getElementById('difficultyBtn').textContent = `📈 DIFFICULTY: ${next.toUpperCase()}`;
      this.saveSettings();
      
      this.showNotification(`Difficulty set to ${next}!`, 'info');
    }
    
    cycleLanguage() {
      const languages = this.config.languages;
      const current = this.settings.language || 'en';
      const currentIndex = languages.indexOf(current);
      const next = languages[(currentIndex + 1) % languages.length];
      
      this.settings.language = next;
      document.getElementById('languageBtn').textContent = `🌐 LANGUAGE: ${next.toUpperCase()}`;
      this.saveSettings();
      
      this.showNotification(`Language changed to ${next}!`, 'info');
    }
    
    // Enhanced data management
    exportGameData() {
      const gameData = {
        stats: this.stats,
        settings: this.settings,
        achievements: this.achievements.getUnlockedData(),
        shop: this.shop.getPurchasedData(),
        version: '3.0',
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(gameData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `galactic-math-quest-save-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      this.showNotification('Game data exported successfully! 📤', 'achievement');
    }
    
    importGameData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const gameData = JSON.parse(e.target.result);
            
            if (gameData.version && gameData.stats) {
              this.stats = { ...this.stats, ...gameData.stats };
              this.settings = { ...this.settings, ...gameData.settings };
              
              this.saveStats();
              this.saveSettings();
              
              this.showNotification('Game data imported successfully! 📥', 'achievement');
              this.updateStatsDisplay();
            } else {
              throw new Error('Invalid file format');
            }
          } catch (error) {
            this.showNotification('Failed to import data. Invalid file format.', 'warning');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    backupToCloud() {
      // This would integrate with a cloud service in a real implementation
      this.showNotification('Cloud backup feature coming soon! ☁️', 'info');
    }
    
    shareScore() {
      if (navigator.share) {
        navigator.share({
          title: 'Galactic Math Quest',
          text: `I just scored ${this.state.score.toLocaleString()} points in Galactic Math Quest! 🚀`,
          url: window.location.href
        });
      } else {
        // Fallback for browsers without native sharing
        const shareText = `I just scored ${this.state.score.toLocaleString()} points in Galactic Math Quest! 🚀`;
        navigator.clipboard.writeText(shareText).then(() => {
          this.showNotification('Score copied to clipboard! 📋', 'info');
        });
      }
    }
    
    toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          this.showNotification('Entered fullscreen mode', 'info');
        });
      } else {
        document.exitFullscreen().then(() => {
          this.showNotification('Exited fullscreen mode', 'info');
        });
      }
    }
    
    startSessionTimer() {
      setInterval(() => {
        if (this.state.sessionStartTime) {
          this.updateUI();
        }
      }, 1000);
    }
    
    // Enhanced persistence
    loadSettings() {
      const saved = localStorage.getItem('GMQ_settings');
      return saved ? JSON.parse(saved) : {
        theme: 'space',
        quality: 'high',
        difficulty: 'normal',
        language: 'en',
        notifications: true,
        tutorials: true,
        autoSave: true,
        analyticsPermission: true
      };
    }
    
    saveSettings() {
      localStorage.setItem('GMQ_settings', JSON.stringify(this.settings));
    }
    
    // Enhanced stats loading with migration
    loadStats() {
      const saved = localStorage.getItem('GMQ_stats');
      const defaultStats = {
        gamesPlayed: 0,
        totalScore: 0,
        highScore: 0,
        totalCoins: 0,
        bestCombo: 0,
        questionsAnswered: 0,
        correctAnswers: 0,
        powerupsUsed: 0,
        playTime: 0,
        subjectMastery: {
          basic: 0, algebra: 0, geometry: 0, fraction: 0,
          trigonometry: 0, calculus: 0, statistics: 0, advanced: 0
        },
        achievements: [],
        dailyStreak: 0,
        lastPlayDate: null,
        version: '3.0'
      };
      
      if (!saved) return defaultStats;
      
      const loadedStats = JSON.parse(saved);
      
      // Migrate from older versions
      if (!loadedStats.version || loadedStats.version < '3.0') {
        return { ...defaultStats, ...loadedStats, version: '3.0' };
      }
      
      return loadedStats;
    }
    
    saveStats() {
      if (this.state.score > (this.stats.highScore || 0)) {
        this.stats.highScore = this.state.score;
      }
      
      // Update daily streak
      const today = new Date().toDateString();
      if (this.stats.lastPlayDate !== today) {
        if (this.stats.lastPlayDate === new Date(Date.now() - 86400000).toDateString()) {
          this.stats.dailyStreak++;
        } else {
          this.stats.dailyStreak = 1;
        }
        this.stats.lastPlayDate = today;
      }
      
      localStorage.setItem('GMQ_stats', JSON.stringify(this.stats));
    }
    
    updateStatsDisplay() {
      // This method updates the settings screen stats display
      const elements = {
        gamesPlayed: this.stats.gamesPlayed,
        totalScore: this.stats.totalScore.toLocaleString(),
        bestCombo: this.stats.bestCombo,
        accuracy: this.stats.questionsAnswered > 0
          ? Math.round((this.stats.correctAnswers / this.stats.questionsAnswered) * 100) + '%'
          : '0%',
        powerupsUsed: this.stats.powerupsUsed,
        totalCoins: this.stats.totalCoins.toLocaleString(),
        shipsUnlocked: `${this.shop.getUnlockedShips()}/6`,
        achievementsUnlocked: `${this.achievements.getUnlockedCount()}/36`,
        totalQuestions: this.stats.questionsAnswered,
        totalCorrect: this.stats.correctAnswers,
        skillRating: this.calculateSkillRating()
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
      });
      
      // Play time
      const hours = Math.floor(this.stats.playTime / 3600);
      const minutes = Math.floor((this.stats.playTime % 3600) / 60);
      const playTimeElement = document.getElementById('playTime');
      if (playTimeElement) {
        playTimeElement.textContent = `${hours}h ${minutes}m`;
      }
    }
    
    calculateSkillRating() {
      const accuracy = this.stats.questionsAnswered > 0 
        ? this.stats.correctAnswers / this.stats.questionsAnswered 
        : 0;
      const gamesPlayed = this.stats.gamesPlayed;
      const achievements = this.achievements.getUnlockedCount();
      
      const score = (accuracy * 40) + (Math.min(gamesPlayed, 50) * 0.8) + (achievements * 1.5);
      
      if (score < 20) return 'Novice';
      if (score < 40) return 'Apprentice';
      if (score < 60) return 'Skilled';
      if (score < 80) return 'Expert';
      if (score < 95) return 'Master';
      return 'Grandmaster';
    }
  }
  
  // === ENHANCED SUPPORTING SYSTEMS ===
  
  class EnhancedSoundManager {
    constructor() {
      this.enabled = true;
      this.volume = 0.7;
      this.sounds = {};
      this.currentMusic = null;
      
      this.initSounds();
    }
    
    initSounds() {
      // Using data URIs for basic sounds (in real implementation, use proper audio files)
      const soundConfigs = {
        correct: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=', volume: 0.6 },
        wrong: { src: 'data:audio/wav;base64,UklGRugAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQ=', volume: 0.5 },
        powerup_common: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLA=', volume: 0.5 },
        powerup_rare: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLA=', volume: 0.7 },
        powerup_legendary: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLA=', volume: 0.8 },
        start: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAACgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCg=', volume: 0.4 },
        gameOver: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.5 },
        click: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.3 },
        back: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.3 },
        locked: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.4 },
        shield_break: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.6 },
        boss_music: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.3 },
        boss_defeat: { src: 'data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YYQAAABgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGA=', volume: 0.7 }
      };
      
      // Initialize Howler sounds
      Object.entries(soundConfigs).forEach(([name, config]) => {
        this.sounds[name] = new Howl({
          src: [config.src],
          volume: config.volume * this.volume
        });
      });
    }
    
    play(sound, options = {}) {
      if (!this.enabled || !this.sounds[sound]) return;
      
      const howl = this.sounds[sound];
      
      if (options.loop) {
        howl.loop(true);
        this.currentMusic = howl;
      }
      
      howl.play();
    }
    
    stop(sound) {
      if (this.sounds[sound]) {
        this.sounds[sound].stop();
      }
    }
    
    stopMusic() {
      if (this.currentMusic) {
        this.currentMusic.stop();
        this.currentMusic = null;
      }
    }
    
    setVolume(volume) {
      this.volume = volume;
      Object.values(this.sounds).forEach(sound => {
        sound.volume(sound.volume() * volume);
      });
    }
    
    toggle() {
      this.enabled = !this.enabled;
      const btn = document.getElementById('soundMainBtn');
      if (btn) btn.textContent = this.enabled ? '🔊' : '🔇';
      
      if (!this.enabled) {
        this.stopMusic();
      }
    }
  }
  
  class EnhancedParticleSystem {
    constructor() {
      this.particles = [];
      this.maxParticles = 200;
    }
    
    createExplosion(x, y, color = '#ffca3a', count = 20) {
      for (let i = 0; i < count; i++) {
        this.createParticle(x, y, color, 'explosion');
      }
    }
    
    createTrail(x, y, color = '#ffca3a') {
      this.createParticle(x, y, color, 'trail');
    }
    
    createSpark(x, y, color = '#ffffff') {
      this.createParticle(x, y, color, 'spark');
    }
    
    createParticle(x, y, color, type = 'explosion') {
      if (this.particles.length >= this.maxParticles) {
        // Remove oldest particle
        const oldest = this.particles.shift();
        oldest.element.remove();
      }
      
      const particle = document.createElement('div');
      particle.className = `particle ${type}`;
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      particle.style.background = color;
      
      let tx, ty;
      
      switch (type) {
        case 'explosion':
          const angle = (Math.random() * Math.PI * 2);
          const velocity = 50 + Math.random() * 150;
          tx = Math.cos(angle) * velocity;
          ty = Math.sin(angle) * velocity;
          break;
          
        case 'trail':
          tx = Math.random() * 20 - 10;
          ty = -50 - Math.random() * 50;
          break;
          
        case 'spark':
          tx = Math.random() * 40 - 20;
          ty = Math.random() * 40 - 20;
          break;
      }
      
      particle.style.setProperty('--tx', tx + 'px');
      particle.style.setProperty('--ty', ty + 'px');
      
      document.body.appendChild(particle);
      
      const particleData = {
        element: particle,
        createdAt: Date.now(),
        duration: type === 'spark' ? 1500 : 2000
      };
      
      this.particles.push(particleData);
      
      setTimeout(() => {
        particle.remove();
        const index = this.particles.indexOf(particleData);
        if (index > -1) {
          this.particles.splice(index, 1);
        }
      }, particleData.duration);
    }
    
    clear() {
      this.particles.forEach(particle => particle.element.remove());
      this.particles = [];
    }
  }
  
  class EnhancedAchievementSystem {
    constructor() {
      this.achievements = {
        // Basic achievements
        firstWin: { name: 'First Contact', icon: '🎯', requirement: 1, type: 'games', description: 'Complete your first mission' },
        combo5: { name: 'Heating Up', icon: '🔥', requirement: 5, type: 'combo', description: 'Achieve a 5x combo' },
        combo10: { name: 'On Fire', icon: '💥', requirement: 10, type: 'combo', description: 'Achieve a 10x combo' },
        combo25: { name: 'Lightning Strike', icon: '⚡', requirement: 25, type: 'combo', description: 'Achieve a 25x combo' },
        
        // Survival achievements
        survivor: { name: 'Space Survivor', icon: '💪', requirement: 10, type: 'waves', description: 'Survive 10 waves' },
        veteran: { name: 'Veteran Pilot', icon: '🎖️', requirement: 25, type: 'waves', description: 'Survive 25 waves' },
        legend: { name: 'Living Legend', icon: '👑', requirement: 50, type: 'waves', description: 'Survive 50 waves' },
        
        // Accuracy achievements
        accurate: { name: 'Sharpshooter', icon: '🎯', requirement: 95, type: 'accuracy', description: '95% accuracy in a game' },
        perfect: { name: 'Perfect Precision', icon: '⭐', requirement: 1, type: 'perfect_rounds', description: '100% accuracy for 10 questions' },
        
        // Subject mastery
        algebraMaster: { name: 'Algebra Ace', icon: '📐', requirement: 100, type: 'algebra_correct', description: 'Answer 100 algebra questions correctly' },
        geometryGuru: { name: 'Geometry Genius', icon: '📏', requirement: 100, type: 'geometry_correct', description: 'Answer 100 geometry questions correctly' },
        calculusKing: { name: 'Calculus Champion', icon: '∫', requirement: 100, type: 'calculus_correct', description: 'Answer 100 calculus questions correctly' },
        
        // Speed achievements
        speedster: { name: 'Speed Demon', icon: '⚡', requirement: 10, type: 'speed_answers', description: 'Answer 10 questions in under 5 seconds each' },
        lightning: { name: 'Lightning Calculator', icon: '🌩️', requirement: 25, type: 'lightning_answers', description: 'Answer 25 questions in under 3 seconds each' },
        
        // Collection achievements
        collector: { name: 'Power Collector', icon: '💎', requirement: 50, type: 'powerups', description: 'Collect 50 power-ups' },
        hoarder: { name: 'Power Hoarder', icon: '🗃️', requirement: 200, type: 'powerups', description: 'Collect 200 power-ups' },
        
        // Score achievements
        highScore: { name: 'High Scorer', icon: '🏆', requirement: 10000, type: 'single_score', description: 'Score 10,000 points in one game' },
        megaScore: { name: 'Mega Scorer', icon: '💫', requirement: 50000, type: 'single_score', description: 'Score 50,000 points in one game' },
        
        // Boss achievements
        bossSlayer: { name: 'Boss Slayer', icon: '👹', requirement: 1, type: 'boss', description: 'Defeat your first boss asteroid' },
        bossHunter: { name: 'Boss Hunter', icon: '🗡️', requirement: 10, type: 'boss', description: 'Defeat 10 boss asteroids' },
        
        // Special achievements
        mathematician: { name: 'Master Mathematician', icon: '🧮', requirement: 1000, type: 'correct', description: 'Answer 1000 questions correctly' },
        scholar: { name: 'Galactic Scholar', icon: '🎓', requirement: 1, type: 'tutorial_complete', description: 'Complete tutorial and practice mode' },
        explorer: { name: 'Space Explorer', icon: '🚀', requirement: 4, type: 'modes_tried', description: 'Try all game modes' },
        shopper: { name: 'Cosmic Shopper', icon: '🛒', requirement: 5, type: 'shop_items', description: 'Purchase 5 shop items' },
        wealthy: { name: 'Space Millionaire', icon: '💰', requirement: 10000, type: 'total_coins', description: 'Earn 10,000 total coins' },
        
        // Time-based achievements
        marathon: { name: 'Math Marathon', icon: '⏰', requirement: 3600, type: 'play_time', description: 'Play for 60 minutes total' },
        dedication: { name: 'Dedicated Student', icon: '📅', requirement: 10, type: 'daily_streak', description: 'Play 10 different days' },
        
        // Secret achievements
        konami: { name: 'Code Breaker', icon: '🎮', requirement: 1, type: 'secret', description: 'Find the secret code' },
        easter: { name: 'Easter Hunter', icon: '🥚', requirement: 1, type: 'easter_egg', description: 'Discover a hidden easter egg' },
        
        // Ultimate achievement
        ultimate: { name: 'Ultimate Champion', icon: '🌟', requirement: 1, type: 'all_achievements', description: 'Unlock all other achievements' }
      };
      
      this.unlocked = this.load();
      this.progress = this.loadProgress();
    }
    
    init() {
      this.updateUI();
    }
    
    check(id, value) {
      if (this.unlocked[id]) return false;
      
      const achievement = this.achievements[id];
      if (!achievement) return false;
      
      if (value >= achievement.requirement) {
        this.unlock(id);
        return true;
      }
      
      // Update progress
      this.progress[id] = Math.min(value, achievement.requirement);
      this.saveProgress();
      
      return false;
    }
    
    incrementProgress(id, amount = 1) {
      if (this.unlocked[id]) return;
      
      this.progress[id] = (this.progress[id] || 0) + amount;
      this.check(id, this.progress[id]);
    }
    
    unlock(id) {
      if (this.unlocked[id]) return;
      
      this.unlocked[id] = true;
      this.save();
      
      const achievement = this.achievements[id];
      
      // Create enhanced notification
      const notification = document.createElement('div');
      notification.className = 'notification achievement';
      notification.innerHTML = `
        <div style="font-size:1.5rem;margin-bottom:5px">${achievement.icon}</div>
        <strong>Achievement Unlocked!</strong><br>
        <strong>${achievement.name}</strong><br>
        <span style="font-size:0.6rem;opacity:0.9">${achievement.description}</span>
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 6000);
      
      // Check for ultimate achievement
      this.checkUltimate();
    }
    
    checkUltimate() {
      const totalAchievements = Object.keys(this.achievements).length - 1; // Exclude ultimate itself
      const unlockedCount = this.getUnlockedCount();
      
      if (unlockedCount >= totalAchievements && !this.unlocked.ultimate) {
        this.unlock('ultimate');
      }
    }
    
    updateUI() {
      const count = this.getUnlockedCount();
      const total = Object.keys(this.achievements).length;
      const percent = Math.round((count / total) * 100);
      
      document.getElementById('achievementCount').textContent = `${count}/${total}`;
      document.getElementById('achievementPercent').textContent = `${percent}%`;
      
      // Update individual achievement cards
      Object.keys(this.achievements).forEach(id => {
        const card = document.querySelector(`[data-achievement="${id}"]`);
        if (!card) return;
        
        const achievement = this.achievements[id];
        const isUnlocked = this.unlocked[id];
        const progress = this.progress[id] || 0;
        const progressPercent = Math.min(100, (progress / achievement.requirement) * 100);
        
        if (isUnlocked) {
          card.classList.add('unlocked');
        }
        
        const progressFill = card.querySelector('.progressFill');
        if (progressFill) {
          progressFill.style.width = isUnlocked ? '100%' : progressPercent + '%';
        }
        
        // Update description with progress
        const description = card.querySelector('.description');
        if (description && !isUnlocked && progress > 0) {
          description.textContent = `${achievement.description} (${progress}/${achievement.requirement})`;
        }
      });
    }
    
    getUnlockedCount() {
      return Object.values(this.unlocked).filter(v => v).length;
    }
    
    getUnlockedData() {
      return this.unlocked;
    }
    
    load() {
      const saved = localStorage.getItem('GMQ_achievements');
      return saved ? JSON.parse(saved) : {};
    }
    
    save() {
      localStorage.setItem('GMQ_achievements', JSON.stringify(this.unlocked));
    }
    
    loadProgress() {
      const saved = localStorage.getItem('GMQ_achievement_progress');
      return saved ? JSON.parse(saved) : {};
    }
    
    saveProgress() {
      localStorage.setItem('GMQ_achievement_progress', JSON.stringify(this.progress));
    }
    
    reset() {
      this.unlocked = {};
      this.progress = {};
      this.save();
      this.saveProgress();
    }
  }
  
  // Enhanced Shop System Class
  class EnhancedShopSystem {
    constructor() {
      this.items = {
        // Ships
        shipBlue: { 
          price: 50, 
          type: 'ship', 
          color: 'blue', 
          name: 'Azure Interceptor', 
          description: 'Fast and agile fighter craft'
        },
        shipRed: {
          price: 75,
          type: 'ship',
          color: 'red',
          name: 'Crimson Destroyer',
          description: 'Heavy assault vessel'
        },
        shipGreen: {
          price: 100,
          type: 'ship',
          color: 'green',
          name: 'Emerald Guardian',
          description: 'Balanced defense craft'
        },
        
        // Power-ups
        shieldGen: {
          price: 150,
          type: 'upgrade',
          name: 'Shield Generator',
          description: 'Start each game with a shield'
        },
        extraLife: {
          price: 200,
          type: 'upgrade',
          name: 'Extra Life',
          description: 'Start with +1 life'
        },
        magnetPower: {
          price: 300,
          type: 'upgrade',
          name: 'Magnet Power',
          description: 'Attract nearby power-ups'
        },
        timeExtend: {
          price: 250,
          type: 'upgrade',
          name: 'Time Extender',
          description: 'Power-ups last 50% longer'
        }
      };
    }
    
    purchaseItem(itemId) {
      const item = this.items[itemId];
      if (!item) return false;
      
      if (gameState.coins >= item.price && !gameState.unlocked[itemId]) {
        gameState.coins -= item.price;
        gameState.unlocked[itemId] = true;
        saveGameData();
        return true;
      }
      return false;
    }
    
    getAvailableItems() {
      return Object.entries(this.items).filter(([id, item]) => !gameState.unlocked[id]);
    }
  }

  /* =========[ ENHANCED GALACTIC MATH QUEST v3.0 ]========= */

  // Enhanced game state management
  const gameState = {
    playing: false,
    paused: false,
    mode: 'classic',
    score: 0,
    lives: 3,
    wave: 1,
    combo: 1,
    maxCombo: 1,
    questionsAnswered: 0,
    correctAnswers: 0,
    asteroidsDestroyed: 0,
    powerupsCollected: 0,
    sessionStartTime: Date.now(),
    totalPlayTime: 0,
    coins: parseInt(localStorage.getItem('gmq_coins') || '0'),
    shipPosition: 1,
    currentQuestion: null,
    correctAnswer: null,
    shipSpeed: 350,
    asteroidSpeed: 100,
    powerupSpeed: 120,
    speedMultiplier: 1,
    shielded: false,
    doubleScore: false,
    timeSlow: false,
    invulnerable: false,
    settings: {
      sound: true,
      particles: true,
      shake: true,
      quality: 'high',
      theme: 'space',
      difficulty: 'auto',
      language: 'en'
    },
    subjects: {
      basic: { correct: 0, total: 0 },
      algebra: { correct: 0, total: 0 },
      geometry: { correct: 0, total: 0 },
      fraction: { correct: 0, total: 0 },
      trigonometry: { correct: 0, total: 0 },
      calculus: { correct: 0, total: 0 },
      statistics: { correct: 0, total: 0 },
      advanced: { correct: 0, total: 0 }
    },
    achievements: JSON.parse(localStorage.getItem('gmq_achievements') || '{}'),
    unlocked: JSON.parse(localStorage.getItem('gmq_unlocked') || '{}'),
    stats: JSON.parse(localStorage.getItem('gmq_stats') || '{}')
  };

  // Enhanced DOM element cache
  const elements = {
    // Screens
    startScreen: document.getElementById('startScreen'),
    tutorialScreen: document.getElementById('tutorialScreen'),
    shopScreen: document.getElementById('shopScreen'),
    achievementScreen: document.getElementById('achievementScreen'),
    analyticsScreen: document.getElementById('analyticsScreen'),
    customizeScreen: document.getElementById('customizeScreen'),
    helpScreen: document.getElementById('helpScreen'),
    multiplayerScreen: document.getElementById('multiplayerScreen'),
    leaderboardScreen: document.getElementById('leaderboardScreen'),
    settingsScreen: document.getElementById('settingsScreen'),
    pauseScreen: document.getElementById('pauseScreen'),
    gameOver: document.getElementById('gameOver'),
    loadingScreen: document.getElementById('loadingScreen'),
    
    // Game elements
    ship: document.getElementById('ship'),
    gameArea: document.getElementById('gameArea'),
    question: document.getElementById('question'),
    score: document.getElementById('score'),
    lives: document.getElementById('lives'),
    combo: document.getElementById('combo'),
    comboFill: document.getElementById('comboFill'),
    hud: document.getElementById('hud'),
    sidePanel: document.getElementById('sidePanel'),
    miniMap: document.getElementById('miniMap'),
    
    // HUD elements
    timerDisplay: document.getElementById('timerDisplay'),
    streakDisplay: document.getElementById('streakDisplay'),
    waveIndicator: document.getElementById('waveIndicator'),
    speedSlider: document.getElementById('speedSlider'),
    speedValue: document.getElementById('speedValue'),
    pauseBtn: document.getElementById('pauseBtn'),
    helpGameBtn: document.getElementById('helpGameBtn'),
    
    // Mission briefing
    currentWave: document.getElementById('currentWave'),
    threatLevel: document.getElementById('threatLevel'),
    destroyedCount: document.getElementById('destroyedCount'),
    accuracyRate: document.getElementById('accuracyRate'),
    sessionTime: document.getElementById('sessionTime'),
    
    // Power-up inventory
    shieldCount: document.getElementById('shieldCount'),
    slowCount: document.getElementById('slowCount'),
    doubleCount: document.getElementById('doubleCount'),
    currentCoins: document.getElementById('currentCoins'),
    
    // Mobile menu toggle
    menuToggle: document.getElementById('menuToggle')
  };

  // Enhanced math question generator
  class MathEngine {
    constructor() {
      this.difficulty = 1;
      this.subjects = ['basic', 'algebra', 'geometry', 'fraction', 'trigonometry', 'calculus', 'statistics', 'advanced'];
    }

    generateQuestion(wave) {
      this.difficulty = Math.min(Math.floor(wave / 3) + 1, 10);
      const subjectIndex = Math.min(Math.floor((wave - 1) / 5), this.subjects.length - 1);
      const subject = this.subjects[subjectIndex];
      
      switch(subject) {
        case 'basic':
          return this.generateBasicMath();
        case 'algebra':
          return this.generateAlgebra();
        case 'geometry':
          return this.generateGeometry();
        case 'fraction':
          return this.generateFraction();
        case 'trigonometry':
          return this.generateTrigonometry();
        case 'calculus':
          return this.generateCalculus();
        case 'statistics':
          return this.generateStatistics();
        case 'advanced':
          return this.generateAdvanced();
        default:
          return this.generateBasicMath();
      }
    }

    generateBasicMath() {
      const ops = ['+', '-', '×', '÷'];
      const op = ops[Math.floor(Math.random() * ops.length)];
      let a, b, answer;
      
      switch(op) {
        case '+':
          a = Math.floor(Math.random() * (10 * this.difficulty)) + 1;
          b = Math.floor(Math.random() * (10 * this.difficulty)) + 1;
          answer = a + b;
          break;
        case '-':
          a = Math.floor(Math.random() * (10 * this.difficulty)) + 10;
          b = Math.floor(Math.random() * (10 * this.difficulty)) + 1;
          answer = a - b;
          break;
        case '×':
          a = Math.floor(Math.random() * (5 * this.difficulty)) + 1;
          b = Math.floor(Math.random() * 10) + 1;
          answer = a * b;
          break;
        case '÷':
          answer = Math.floor(Math.random() * 10) + 1;
          b = Math.floor(Math.random() * 10) + 1;
          a = answer * b;
          break;
      }
      
      return {
        question: `${a} ${op} ${b} = ?`,
        answer: answer,
        subject: 'basic',
        difficulty: this.difficulty
      };
    }

    generateAlgebra() {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 20) + 1;
      const answer = Math.floor(Math.random() * 15) + 1;
      const c = a * answer + b;
      
      const templates = [
        { q: `${a}x + ${b} = ${c}`, a: answer },
        { q: `x - ${b} = ${answer}`, a: answer + b },
        { q: `${a}x = ${a * answer}`, a: answer },
        { q: `x/2 + ${b} = ${answer + b}`, a: answer * 2 }
      ];
      
      const template = templates[Math.floor(Math.random() * templates.length)];
      
      return {
        question: template.q,
        answer: template.a,
        subject: 'algebra',
        difficulty: this.difficulty
      };
    }

    generateGeometry() {
      const shapes = ['square', 'rectangle', 'circle', 'triangle', 'cube'];
      const shape = shapes[Math.floor(Math.random() * shapes.length)];
      let question, answer;
      
      switch(shape) {
        case 'square':
          const side = Math.floor(Math.random() * 10) + 3;
          const calc = Math.random() > 0.5 ? 'area' : 'perimeter';
          if(calc === 'area') {
            question = `Area of square (side=${side})`;
            answer = side * side;
          } else {
            question = `Perimeter of square (side=${side})`;
            answer = 4 * side;
          }
          break;
        case 'rectangle':
          const length = Math.floor(Math.random() * 8) + 3;
          const width = Math.floor(Math.random() * 8) + 2;
          question = `Area of rectangle (${length}×${width})`;
          answer = length * width;
          break;
        case 'circle':
          const radius = Math.floor(Math.random() * 5) + 2;
          question = `Area of circle (r=${radius}, π≈3)`;
          answer = 3 * radius * radius;
          break;
        case 'triangle':
          const base = Math.floor(Math.random() * 8) + 4;
          const height = Math.floor(Math.random() * 6) + 3;
          question = `Area of triangle (b=${base}, h=${height})`;
          answer = Math.floor((base * height) / 2);
          break;
        case 'cube':
          const edge = Math.floor(Math.random() * 5) + 2;
          question = `Volume of cube (edge=${edge})`;
          answer = edge * edge * edge;
          break;
      }
      
      return {
        question: question,
        answer: answer,
        subject: 'geometry',
        difficulty: this.difficulty
      };
    }

    generateFraction() {
      const operations = ['add', 'subtract', 'multiply', 'simplify'];
      const op = operations[Math.floor(Math.random() * operations.length)];
      let question, answer;
      
      switch(op) {
        case 'add':
          const a1 = Math.floor(Math.random() * 5) + 1;
          const a2 = Math.floor(Math.random() * 5) + 2;
          question = `${a1}/${a2} + ${a1}/${a2} = ?/${a2}`;
          answer = 2 * a1;
          break;
        case 'subtract':
          const b1 = Math.floor(Math.random() * 8) + 3;
          const b2 = Math.floor(Math.random() * 3) + 1;
          question = `${b1}/10 - ${b2}/10 = ?/10`;
          answer = b1 - b2;
          break;
        case 'multiply':
          const c1 = Math.floor(Math.random() * 5) + 1;
          const c2 = Math.floor(Math.random() * 5) + 1;
          question = `${c1} × 1/${c2} = ?/${c2}`;
          answer = c1;
          break;
        case 'simplify':
          const factor = Math.floor(Math.random() * 4) + 2;
          const num = factor * (Math.floor(Math.random() * 5) + 1);
          question = `Simplify: ${num}/${factor} = ?`;
          answer = num / factor;
          break;
      }
      
      return {
        question: question,
        answer: answer,
        subject: 'fraction',
        difficulty: this.difficulty
      };
    }

    generateTrigonometry() {
      const angles = [0, 30, 45, 60, 90];
      const angle = angles[Math.floor(Math.random() * angles.length)];
      const funcs = ['sin', 'cos', 'tan'];
      const func = funcs[Math.floor(Math.random() * funcs.length)];
      let answer;
      
      const values = {
        'sin': { 0: 0, 30: 0.5, 45: 0.7, 60: 0.9, 90: 1 },
        'cos': { 0: 1, 30: 0.9, 45: 0.7, 60: 0.5, 90: 0 },
        'tan': { 0: 0, 30: 0.6, 45: 1, 60: 1.7, 90: 'undefined' }
      };
      
      answer = values[func][angle];
      if(answer === 'undefined') {
        return this.generateTrigonometry();
      }
      
      // Convert to simpler format for game
      answer = Math.round(answer * 10);
      
      return {
        question: `${func}(${angle}°) × 10 ≈ ?`,
        answer: answer,
        subject: 'trigonometry',
        difficulty: this.difficulty
      };
    }

    generateCalculus() {
      const types = ['derivative', 'integral', 'limit'];
      const type = types[Math.floor(Math.random() * types.length)];
      let question, answer;
      
      switch(type) {
        case 'derivative':
          const power = Math.floor(Math.random() * 4) + 1;
          const coef = Math.floor(Math.random() * 5) + 1;
          question = `d/dx(${coef}x^${power}) at x=1`;
          answer = coef * power;
          break;
        case 'integral':
          const n = Math.floor(Math.random() * 3) + 1;
          question = `∫${n}dx from 0 to 2`;
          answer = n * 2;
          break;
        case 'limit':
          const a = Math.floor(Math.random() * 5) + 1;
          const b = Math.floor(Math.random() * 5) + 1;
          question = `lim(x→${a}) of ${b}`;
          answer = b;
          break;
      }
      
      return {
        question: question,
        answer: answer,
        subject: 'calculus',
        difficulty: this.difficulty
      };
    }

    generateStatistics() {
      const types = ['mean', 'median', 'mode', 'range'];
      const type = types[Math.floor(Math.random() * types.length)];
      let question, answer;
      
      switch(type) {
        case 'mean':
          const nums = Array.from({length: 3}, () => Math.floor(Math.random() * 10) + 1);
          question = `Mean of ${nums.join(', ')}`;
          answer = Math.round(nums.reduce((a, b) => a + b) / nums.length);
          break;
        case 'median':
          const vals = [3, 5, 7, 9, 11];
          question = `Median of 3, 5, 7, 9, 11`;
          answer = 7;
          break;
        case 'mode':
          question = `Mode of 2, 3, 3, 5, 3, 7`;
          answer = 3;
          break;
        case 'range':
          const min = Math.floor(Math.random() * 5) + 1;
          const max = min + Math.floor(Math.random() * 10) + 5;
          question = `Range of data: ${min} to ${max}`;
          answer = max - min;
          break;
      }
      
      return {
        question: question,
        answer: answer,
        subject: 'statistics',
        difficulty: this.difficulty
      };
    }

    generateAdvanced() {
      const types = ['complex', 'matrix', 'logarithm', 'factorial'];
      const type = types[Math.floor(Math.random() * types.length)];
      let question, answer;
      
      switch(type) {
        case 'complex':
          const real = Math.floor(Math.random() * 5) + 1;
          const imag = Math.floor(Math.random() * 5) + 1;
          question = `|${real} + ${imag}i| (round down)`;
          answer = Math.floor(Math.sqrt(real*real + imag*imag));
          break;
        case 'matrix':
          const a = Math.floor(Math.random() * 5) + 1;
          const b = Math.floor(Math.random() * 5) + 1;
          question = `Det[[${a}, 0], [0, ${b}]]`;
          answer = a * b;
          break;
        case 'logarithm':
          const bases = [2, 10];
          const base = bases[Math.floor(Math.random() * bases.length)];
          const result = Math.floor(Math.random() * 3) + 1;
          const value = Math.pow(base, result);
          question = `log${base}(${value})`;
          answer = result;
          break;
        case 'factorial':
          const n = Math.floor(Math.random() * 4) + 3;
          question = `${n}! ÷ ${n-1}!`;
          answer = n;
          break;
      }
      
      return {
        question: question,
        answer: answer,
        subject: 'advanced',
        difficulty: this.difficulty
      };
    }

    generateWrongAnswers(correctAnswer, count = 3) {
      const answers = new Set([correctAnswer]);
      const variance = Math.max(10, Math.abs(correctAnswer) * 0.5);
      
      while(answers.size < count + 1) {
        const offset = Math.floor(Math.random() * variance * 2) - variance;
        const wrongAnswer = correctAnswer + offset;
        if(wrongAnswer !== correctAnswer && wrongAnswer > 0) {
          answers.add(Math.round(wrongAnswer));
        }
      }
      
      return Array.from(answers);
    }
  }

  // Enhanced Asteroid class
  class Asteroid {
    constructor(x, answer, isCorrect, subject) {
      this.element = document.createElement('div');
      this.element.className = 'asteroid touchable';
      this.element.style.left = x + 'px';
      this.answer = answer;
      this.isCorrect = isCorrect;
      this.subject = subject;
      this.speed = gameState.asteroidSpeed * gameState.speedMultiplier;
      
      // Set asteroid type based on subject
      this.element.classList.add(`type-${subject}`);
      
      // Create asteroid body
      const body = document.createElement('div');
      body.className = 'asteroid-body';
      body.textContent = answer;
      
      // Add craters for visual detail
      const crater1 = document.createElement('div');
      crater1.className = 'asteroid-crater';
      const crater2 = document.createElement('div');
      crater2.className = 'asteroid-crater';
      
      body.appendChild(crater1);
      body.appendChild(crater2);
      this.element.appendChild(body);
      
      // Set random fall duration
      const duration = (8000 + Math.random() * 4000) / this.speed * 100;
      this.element.style.animationDuration = duration + 'ms';
      
      if(gameState.timeSlow) {
        this.element.style.animationDuration = (duration * 2) + 'ms';
      }
      
      // Click handler
      this.element.addEventListener('click', () => this.destroy());
      
      // Boss asteroid
      if(gameState.wave % 5 === 0 && isCorrect) {
        this.element.classList.add('type-boss');
        this.isBoss = true;
        this.health = 3;
      }
      
      elements.gameArea.appendChild(this.element);
      
      // Add to mini map
      this.addToMiniMap();
      
      // Check for collision periodically
      this.collisionInterval = setInterval(() => this.checkCollision(), 100);
      
      // Remove when animation ends
      this.element.addEventListener('animationend', () => this.miss());
    }

    destroy() {
      if(!gameState.playing) return;
      
      clearInterval(this.collisionInterval);
      
      if(this.isBoss && this.health > 1) {
        this.health--;
        this.element.classList.add('flash');
        showNotification('Boss Hit! ' + this.health + ' hits remaining', 'warning');
        setTimeout(() => this.element.classList.remove('flash'), 500);
        return;
      }
      
      if(this.isCorrect) {
        // Correct answer
        this.handleCorrectAnswer();
      } else {
        // Wrong answer
        this.handleWrongAnswer();
      }
      
      // Create explosion effect
      createExplosion(this.element.offsetLeft + 50, this.element.offsetTop + 50);
      
      // Remove from mini map
      this.removeFromMiniMap();
      
      // Remove asteroid
      this.element.remove();
    }

    handleCorrectAnswer() {
      gameState.correctAnswers++;
      gameState.asteroidsDestroyed++;
      
      // Calculate score with bonuses
      let points = 10 * gameState.wave;
      points += gameState.combo;
      
      if(gameState.doubleScore) {
        points *= 2;
      }
      
      if(this.isBoss) {
        points *= 5;
        showNotification('Boss Destroyed! +' + points + ' points!', 'achievement');
        checkAchievement('bossSlayer');
      }
      
      gameState.score += points;
      
      // Update combo
      gameState.combo++;
      if(gameState.combo > gameState.maxCombo) {
        gameState.maxCombo = gameState.combo;
      }
      
      // Update subject stats
      gameState.subjects[this.subject].correct++;
      
      // Effects
      elements.ship.classList.add('flash');
      setTimeout(() => elements.ship.classList.remove('flash'), 300);
      
      updateDisplay();
      
      // Check for achievements
      if(gameState.combo === 5) checkAchievement('combo5');
      if(gameState.combo === 10) checkAchievement('combo10');
      if(gameState.combo === 25) checkAchievement('combo25');
      
      // Generate new question
      nextQuestion();
    }

    handleWrongAnswer() {
      gameState.combo = 1;
      
      if(gameState.shielded) {
        gameState.shielded = false;
        elements.ship.classList.remove('shielded');
        showNotification('Shield absorbed the damage!', 'info');
        elements.gameArea.classList.add('flash');
        setTimeout(() => elements.gameArea.classList.remove('flash'), 500);
      } else {
        gameState.lives--;
        elements.gameArea.classList.add('shake');
        setTimeout(() => elements.gameArea.classList.remove('shake'), 600);
        
        if(gameState.lives <= 0) {
          endGame();
        } else {
          // Invulnerability period
          gameState.invulnerable = true;
          elements.ship.classList.add('invulnerable');
          setTimeout(() => {
            gameState.invulnerable = false;
            elements.ship.classList.remove('invulnerable');
          }, 2000);
        }
      }
      
      updateDisplay();
    }

    miss() {
      clearInterval(this.collisionInterval);
      this.removeFromMiniMap();
      
      if(this.isCorrect && gameState.playing) {
        // Missed the correct answer
        this.handleWrongAnswer();
      }
      
      this.element.remove();
    }

    checkCollision() {
      const asteroidRect = this.element.getBoundingClientRect();
      const shipRect = elements.ship.getBoundingClientRect();
      
      if(asteroidRect.bottom > shipRect.top &&
        asteroidRect.top < shipRect.bottom &&
        asteroidRect.right > shipRect.left &&
        asteroidRect.left < shipRect.right) {
        this.destroy();
      }
    }

    addToMiniMap() {
      this.miniMapDot = document.createElement('div');
      this.miniMapDot.className = 'miniMapDot asteroid';
      this.miniMapDot.style.left = (this.element.offsetLeft / elements.gameArea.offsetWidth * 100) + '%';
      this.miniMapDot.style.top = '10%';
      elements.miniMap.appendChild(this.miniMapDot);
      
      this.miniMapInterval = setInterval(() => {
        const progress = parseFloat(this.element.style.top) / window.innerHeight;
        this.miniMapDot.style.top = (10 + progress * 80) + '%';
      }, 100);
    }

    removeFromMiniMap() {
      clearInterval(this.miniMapInterval);
      if(this.miniMapDot) {
        this.miniMapDot.remove();
      }
    }
  }

  // Enhanced PowerUp class
  class PowerUp {
    constructor(x, type) {
      this.element = document.createElement('div');
      this.element.className = 'powerup touchable';
      this.element.style.left = x + 'px';
      this.type = type;
      this.speed = gameState.powerupSpeed * gameState.speedMultiplier;
      
      const types = {
        shield: { icon: '🛡️', color: '#00bcd4' },
        life: { icon: '❤️', color: '#f44336' },
        slow: { icon: '⏱️', color: '#9c27b0' },
        double: { icon: '2x', color: '#ff9800' },
        bomb: { icon: '💣', color: '#607d8b' },
        coin: { icon: '💰', color: '#ffd700' },
        mega: { icon: '⭐', color: '#e91e63' }
      };
      
      const powerupInfo = types[type] || types.shield;
      
      // Special visual effects for rare powerups
      if(type === 'mega') {
        this.element.classList.add('type-mega');
      } else if(type === 'life' && Math.random() < 0.1) {
        this.element.classList.add('type-legendary');
      }
      
      // Create powerup body
      const body = document.createElement('div');
      body.className = 'powerup-body';
      body.textContent = powerupInfo.icon;
      body.style.background = powerupInfo.color;
      
      // Add rings
      for(let i = 0; i < 3; i++) {
        const ring = document.createElement('div');
        ring.className = 'powerup-ring';
        this.element.appendChild(ring);
      }
      
      this.element.appendChild(body);
      
      // Set fall duration
      const duration = (10000 + Math.random() * 5000) / this.speed * 100;
      this.element.style.animationDuration = duration + 'ms';
      
      if(gameState.timeSlow) {
        this.element.style.animationDuration = (duration * 2) + 'ms';
      }
      
      // Click handler
      this.element.addEventListener('click', () => this.collect());
      
      elements.gameArea.appendChild(this.element);
      
      // Add to mini map
      this.addToMiniMap();
      
      // Check for auto-collection if magnet upgrade is active
      if(gameState.unlocked.magnetPower) {
        this.magnetInterval = setInterval(() => this.checkMagnet(), 100);
      }
      
      // Remove when animation ends
      this.element.addEventListener('animationend', () => this.remove());
    }

    collect() {
      if(!gameState.playing) return;
      
      gameState.powerupsCollected++;
      
      switch(this.type) {
        case 'shield':
          gameState.shielded = true;
          elements.ship.classList.add('shielded');
          showNotification('Shield Activated! 🛡️', 'info');
          break;
          
        case 'life':
          if(gameState.lives < 5) {
            gameState.lives++;
            showNotification('Extra Life! ❤️', 'achievement');
          } else {
            gameState.score += 100;
            showNotification('Max Lives! +100 points', 'info');
          }
          break;
          
        case 'slow':
          activateTimeSlow();
          break;
          
        case 'double':
          activateDoubleScore();
          break;
          
        case 'bomb':
          clearAllAsteroids();
          break;
          
        case 'coin':
          const coinValue = 10 + (gameState.wave * 2);
          gameState.coins += coinValue;
          showNotification(`+${coinValue} coins! 💰`, 'info');
          break;
          
        case 'mega':
          activateMegaPower();
          break;
      }
      
      // Effects
      createCollectEffect(this.element.offsetLeft + 35, this.element.offsetTop + 35);
      
      updateDisplay();
      this.remove();
      
      // Check achievements
      if(gameState.powerupsCollected === 50) checkAchievement('collector');
      if(gameState.powerupsCollected === 200) checkAchievement('hoarder');
    }

    checkMagnet() {
      const powerupRect = this.element.getBoundingClientRect();
      const shipRect = elements.ship.getBoundingClientRect();
      
      const distance = Math.sqrt(
        Math.pow(powerupRect.left - shipRect.left, 2) +
        Math.pow(powerupRect.top - shipRect.top, 2)
      );
      
      if(distance < 150) {
        // Attract to ship
        const angle = Math.atan2(
          shipRect.top - powerupRect.top,
          shipRect.left - powerupRect.left
        );
        
        this.element.style.left = (this.element.offsetLeft + Math.cos(angle) * 5) + 'px';
        this.element.style.top = (this.element.offsetTop + Math.sin(angle) * 5) + 'px';
        
        if(distance < 50) {
          this.collect();
        }
      }
    }

    addToMiniMap() {
      this.miniMapDot = document.createElement('div');
      this.miniMapDot.className = 'miniMapDot powerup';
      this.miniMapDot.style.left = (this.element.offsetLeft / elements.gameArea.offsetWidth * 100) + '%';
      this.miniMapDot.style.top = '10%';
      elements.miniMap.appendChild(this.miniMapDot);
      
      this.miniMapInterval = setInterval(() => {
        const progress = parseFloat(this.element.style.top) / window.innerHeight;
        this.miniMapDot.style.top = (10 + progress * 80) + '%';
      }, 100);
    }

    remove() {
      if(this.magnetInterval) clearInterval(this.magnetInterval);
      if(this.miniMapInterval) clearInterval(this.miniMapInterval);
      if(this.miniMapDot) this.miniMapDot.remove();
      this.element.remove();
    }
  }

  // Initialize math engine
  const mathEngine = new MathEngine();
  const shopSystem = new EnhancedShopSystem();

  // Game functions
  function startGame(mode = 'classic') {
    gameState.mode = mode;
    gameState.playing = true;
    gameState.paused = false;
    gameState.score = 0;
    gameState.lives = 3 + (gameState.unlocked.extraLife ? 1 : 0);
    gameState.wave = 1;
    gameState.combo = 1;
    gameState.maxCombo = 1;
    gameState.questionsAnswered = 0;
    gameState.correctAnswers = 0;
    gameState.asteroidsDestroyed = 0;
    gameState.powerupsCollected = 0;
    gameState.sessionStartTime = Date.now();
    
    // Reset power-up states
    gameState.shielded = false;
    gameState.doubleScore = false;
    gameState.timeSlow = false;
    gameState.invulnerable = false;
    
    // Apply shop upgrades
    if(gameState.unlocked.shieldGen) {
      gameState.shielded = true;
      elements.ship.classList.add('shielded');
    }
    
    // Hide screens
    hideAllScreens();
    
    // Show game HUD
    elements.hud.style.display = 'flex';
    elements.timerDisplay.hidden = false;
    elements.streakDisplay.hidden = false;
    elements.waveIndicator.hidden = false;
    elements.pauseBtn.hidden = false;
    elements.helpGameBtn.hidden = false;
    
    // Start first wave
    showWaveTransition();
    setTimeout(() => {
      nextQuestion();
      startWaveTimer();
    }, 3000);
    
    // Update displays
    updateDisplay();
    updateMissionBrief();
    
    // Game loop
    gameLoop();
  }

  function nextQuestion() {
    if(!gameState.playing) return;
    
    // Clear existing asteroids for new question
    document.querySelectorAll('.asteroid').forEach(a => a.remove());
    
    // Generate new question
    const questionData = mathEngine.generateQuestion(gameState.wave);
    gameState.currentQuestion = questionData.question;
    gameState.correctAnswer = questionData.answer;
    
    // Update question display
    elements.question.textContent = questionData.question;
    
    // Track subject
    gameState.subjects[questionData.subject].total++;
    
    // Generate answers
    const answers = mathEngine.generateWrongAnswers(questionData.answer);
    
    // Spawn asteroids
    const positions = generateAsteroidPositions(answers.length);
    answers.forEach((answer, index) => {
      setTimeout(() => {
        if(gameState.playing && !gameState.paused) {
          new Asteroid(
            positions[index],
            answer,
            answer === questionData.answer,
            questionData.subject
          );
        }
      }, index * 200);
    });
    
    // Chance to spawn power-up
    if(Math.random() < 0.15 + (gameState.wave * 0.01)) {
      setTimeout(() => {
        if(gameState.playing && !gameState.paused) {
          spawnPowerUp();
        }
      }, 1000);
    }
    
    gameState.questionsAnswered++;
  }

  function generateAsteroidPositions(count) {
    const width = elements.gameArea.offsetWidth - 100;
    const positions = [];
    const spacing = width / (count + 1);
    
    for(let i = 0; i < count; i++) {
      positions.push(spacing * (i + 1));
    }
    
    // Shuffle positions
    return positions.sort(() => Math.random() - 0.5);
  }

  function spawnPowerUp() {
    const types = ['shield', 'life', 'slow', 'double', 'bomb', 'coin'];
    
    // Rare power-ups
    if(Math.random() < 0.05) {
      types.push('mega');
    }
    
    const type = types[Math.floor(Math.random() * types.length)];
    const x = Math.random() * (elements.gameArea.offsetWidth - 70);
    
    new PowerUp(x, type);
  }

  function activateTimeSlow() {
    gameState.timeSlow = true;
    showNotification('Time Slow Activated! ⏱️', 'info');
    
    // Slow all existing asteroids and powerups
    document.querySelectorAll('.asteroid, .powerup').forEach(elem => {
      const currentDuration = parseFloat(elem.style.animationDuration);
      elem.style.animationDuration = (currentDuration * 2) + 'ms';
    });
    
    // Visual effect
    elements.gameArea.style.filter = 'hue-rotate(180deg)';
    
    setTimeout(() => {
      gameState.timeSlow = false;
      elements.gameArea.style.filter = '';
      showNotification('Time Slow Ended', 'warning');
    }, 10000 + (gameState.unlocked.timeExtend ? 5000 : 0));
  }

  function activateDoubleScore() {
    gameState.doubleScore = true;
    showNotification('Double Score Activated! 2x', 'achievement');
    
    elements.score.style.color = 'var(--premium)';
    elements.score.classList.add('flash');
    
    setTimeout(() => {
      gameState.doubleScore = false;
      elements.score.style.color = '';
      elements.score.classList.remove('flash');
      showNotification('Double Score Ended', 'warning');
    }, 15000 + (gameState.unlocked.timeExtend ? 7500 : 0));
  }

  function clearAllAsteroids() {
    showNotification('BOMB! All asteroids destroyed! 💣', 'achievement');
    
    // Screen flash effect
    elements.gameArea.style.background = 'rgba(255,255,255,0.5)';
    setTimeout(() => {
      elements.gameArea.style.background = '';
    }, 200);
    
    // Destroy all asteroids with explosion effects
    document.querySelectorAll('.asteroid').forEach((asteroid, index) => {
      setTimeout(() => {
        createExplosion(
          asteroid.offsetLeft + 50,
          asteroid.offsetTop + 50
        );
        asteroid.remove();
      }, index * 50);
    });
    
    // Generate new question after delay
    setTimeout(() => {
      if(gameState.playing) {
        nextQuestion();
      }
    }, 1000);
  }

  function activateMegaPower() {
    showNotification('MEGA POWER! All abilities activated! ⭐', 'premium');
    
    // Activate all power-ups
    gameState.shielded = true;
    elements.ship.classList.add('shielded');
    activateTimeSlow();
    activateDoubleScore();
    
    // Visual effects
    elements.ship.classList.add('boosted');
    createMegaEffect();
    
    setTimeout(() => {
      elements.ship.classList.remove('boosted');
    }, 20000);
  }

  function moveShip(direction) {
    if(!gameState.playing || gameState.paused) return;
    
    const lanes = [0.2, 0.5, 0.8];
    
    if(direction === 'left' && gameState.shipPosition > 0) {
      gameState.shipPosition--;
    } else if(direction === 'right' && gameState.shipPosition < 2) {
      gameState.shipPosition++;
    }
    
    const newX = elements.gameArea.offsetWidth * lanes[gameState.shipPosition];
    elements.ship.style.left = newX + 'px';
    
    // Update mini map
    updateShipOnMiniMap();
  }

  function updateShipOnMiniMap() {
    let shipDot = elements.miniMap.querySelector('.miniMapDot.ship');
    if(!shipDot) {
      shipDot = document.createElement('div');
      shipDot.className = 'miniMapDot ship';
      elements.miniMap.appendChild(shipDot);
    }
    
    const lanes = [20, 50, 80];
    shipDot.style.left = lanes[gameState.shipPosition] + '%';
    shipDot.style.top = '85%';
  }

  function fireWeapon() {
    if(!gameState.playing || gameState.paused) return;
    
    // Create laser effect
    const laser = document.createElement('div');
    laser.className = 'particle trail';
    laser.style.left = (elements.ship.offsetLeft + 30) + 'px';
    laser.style.bottom = '60px';
    laser.style.setProperty('--ty', '-' + window.innerHeight + 'px');
    elements.gameArea.appendChild(laser);
    
    setTimeout(() => laser.remove(), 1000);
    
    // Check for hit
    const shipX = elements.ship.offsetLeft + 30;
    let closestAsteroid = null;
    let closestDistance = Infinity;
    
    document.querySelectorAll('.asteroid').forEach(asteroid => {
      const asteroidX = asteroid.offsetLeft + 50;
      const asteroidY = asteroid.offsetTop + 50;
      const distance = Math.abs(shipX - asteroidX);
      
      if(distance < 60 && asteroidY < window.innerHeight - 100 && distance < closestDistance) {
        closestAsteroid = asteroid;
        closestDistance = distance;
      }
    });
    
    if(closestAsteroid) {
      closestAsteroid.click();
    }
  }

  function pauseGame() {
    if(!gameState.playing) return;
    
    gameState.paused = true;
    
    // Pause all animations
    document.querySelectorAll('.asteroid, .powerup').forEach(elem => {
      elem.style.animationPlayState = 'paused';
    });
    
    // Update pause screen stats
    document.getElementById('pauseScore').textContent = gameState.score;
    document.getElementById('pauseWave').textContent = gameState.wave;
    document.getElementById('pauseCombo').textContent = 'x' + gameState.combo;
    document.getElementById('pauseTime').textContent = formatTime(Date.now() - gameState.sessionStartTime);
    
    // Show pause screen
    elements.pauseScreen.hidden = false;
  }

  function resumeGame() {
    if(!gameState.playing) return;
    
    gameState.paused = false;
    
    // Resume all animations
    document.querySelectorAll('.asteroid, .powerup').forEach(elem => {
      elem.style.animationPlayState = 'running';
    });
    
    elements.pauseScreen.hidden = true;
  }

  function endGame() {
    gameState.playing = false;
    
    // Clear all game objects
    document.querySelectorAll('.asteroid, .powerup').forEach(elem => elem.remove());
    
    // Calculate final stats
    const accuracy = gameState.questionsAnswered > 0 
      ? Math.round((gameState.correctAnswers / gameState.questionsAnswered) * 100) 
      : 0;
    
    const timePlayed = Date.now() - gameState.sessionStartTime;
    const coinsEarned = Math.floor(gameState.score / 100) + (gameState.wave * 5);
    
    gameState.coins += coinsEarned;
    saveGameData();
    
    // Update final stats
    document.getElementById('finalScore').textContent = gameState.score;
    document.getElementById('finalAccuracy').textContent = accuracy + '%';
    document.getElementById('finalCombo').textContent = 'x' + gameState.maxCombo;
    document.getElementById('coinsEarned').textContent = coinsEarned;
    document.getElementById('wavesSurvived').textContent = gameState.wave;
    document.getElementById('timePlayed').textContent = formatTime(timePlayed);
    
    // Performance rating
    const rating = calculatePerformanceRating(gameState.score, accuracy, gameState.wave);
    document.getElementById('ratingStars').textContent = '⭐'.repeat(rating.stars);
    document.getElementById('ratingText').textContent = rating.text;
    
    // Check for new achievements
    checkEndGameAchievements();
    
    // Update stats
    updateLifetimeStats();
    
    // Hide game HUD
    elements.hud.style.display = 'none';
    elements.timerDisplay.hidden = true;
    elements.streakDisplay.hidden = true;
    elements.waveIndicator.hidden = true;
    elements.pauseBtn.hidden = true;
    elements.helpGameBtn.hidden = true;
    
    // Show game over screen
    elements.gameOver.hidden = false;
  }

  function calculatePerformanceRating(score, accuracy, waves) {
    let stars = 1;
    let text = 'Keep Practicing!';
    
    if(score >= 10000) stars++;
    if(accuracy >= 80) stars++;
    if(waves >= 10) stars++;
    if(gameState.maxCombo >= 10) stars++;
    
    const texts = [
      'Keep Practicing!',
      'Good Effort!',
      'Well Done!',
      'Excellent Performance!',
      'Mathematical Master!'
    ];
    
    text = texts[stars - 1];
    
    return { stars, text };
  }

  function updateDisplay() {
    elements.score.textContent = `Score: ${gameState.score}`;
    elements.lives.textContent = `Lives: ${'❤'.repeat(gameState.lives)}${'💔'.repeat(Math.max(0, 3 - gameState.lives))}`;
    elements.combo.textContent = `Combo: x${gameState.combo}`;
    elements.comboFill.style.width = Math.min(100, gameState.combo * 4) + '%';
    elements.currentCoins.textContent = gameState.coins;
    
    // Update inventory
    elements.shieldCount.textContent = gameState.shielded ? '1' : '0';
    elements.slowCount.textContent = gameState.timeSlow ? '1' : '0';
    elements.doubleCount.textContent = gameState.doubleScore ? '1' : '0';
  }

  function updateMissionBrief() {
    elements.currentWave.textContent = gameState.wave;
    elements.destroyedCount.textContent = gameState.asteroidsDestroyed;
    
    const accuracy = gameState.questionsAnswered > 0 
      ? Math.round((gameState.correctAnswers / gameState.questionsAnswered) * 100) 
      : 100;
    elements.accuracyRate.textContent = accuracy + '%';
    
    const elapsed = Date.now() - gameState.sessionStartTime;
    elements.sessionTime.textContent = formatTime(elapsed);
    
    // Update threat level
    let threatLevel = 'LOW';
    if(gameState.wave > 5) threatLevel = 'MEDIUM';
    if(gameState.wave > 10) threatLevel = 'HIGH';
    if(gameState.wave > 15) threatLevel = 'EXTREME';
    if(gameState.wave > 20) threatLevel = 'CRITICAL';
    
    elements.threatLevel.textContent = threatLevel;
    elements.threatLevel.style.color = {
      'LOW': 'var(--good)',
      'MEDIUM': 'var(--accent)',
      'HIGH': 'var(--warning)',
      'EXTREME': 'var(--bad)',
      'CRITICAL': 'var(--danger)'
    }[threatLevel];
  }

  function startWaveTimer() {
    const waveTime = 30000 + (gameState.wave * 2000);
    let elapsed = 0;
    
    const waveInterval = setInterval(() => {
      if(!gameState.playing || gameState.paused) {
        clearInterval(waveInterval);
        return;
      }
      
      elapsed += 100;
      const progress = (elapsed / waveTime) * 100;
      
      // Update wave progress
      const progressBar = elements.waveIndicator.querySelector('.wave-progress-fill');
      if(progressBar) {
        progressBar.style.width = progress + '%';
      }
      
      if(elapsed >= waveTime) {
        clearInterval(waveInterval);
        nextWave();
      }
    }, 100);
  }

  function nextWave() {
    gameState.wave++;
    
    // Clear remaining asteroids
    document.querySelectorAll('.asteroid').forEach(a => a.remove());
    
    // Bonus for completing wave
    const waveBonus = gameState.wave * 50;
    gameState.score += waveBonus;
    showNotification(`Wave ${gameState.wave - 1} Complete! +${waveBonus} points`, 'achievement');
    
    // Show wave transition
    showWaveTransition();
    
    // Start new wave after delay
    setTimeout(() => {
      if(gameState.playing) {
        nextQuestion();
        startWaveTimer();
        
        // Increase difficulty
        gameState.asteroidSpeed = Math.min(200, 100 + (gameState.wave * 5));
        
        // Boss warning
        if(gameState.wave % 5 === 0) {
          showBossWarning();
        }
      }
    }, 3000);
    
    updateDisplay();
    updateMissionBrief();
    
    // Check achievements
    if(gameState.wave === 10) checkAchievement('survivor');
    if(gameState.wave === 25) checkAchievement('veteran');
    if(gameState.wave === 50) checkAchievement('legend');
  }

  function showWaveTransition() {
    const transition = document.createElement('div');
    transition.className = 'waveTransition';
    
    let waveTitle = `WAVE ${gameState.wave}`;
    let waveSubtitle = '';
    
    // Special wave names
    if(gameState.wave % 5 === 0) {
      waveTitle = `BOSS WAVE ${gameState.wave}`;
      waveSubtitle = '<div class="subtitle">Prepare for Battle!</div>';
    } else if(gameState.wave === 1) {
      waveSubtitle = '<div class="subtitle">Good Luck, Space Cadet!</div>';
    } else if(gameState.wave === 10) {
      waveSubtitle = '<div class="subtitle">Entering Deep Space!</div>';
    } else if(gameState.wave === 25) {
      waveSubtitle = '<div class="subtitle">Final Frontier!</div>';
    }
    
    transition.innerHTML = waveTitle + waveSubtitle;
    
    // Update wave indicator
    const subjects = ['Basic Math', 'Algebra', 'Geometry', 'Fractions', 'Trigonometry', 'Calculus', 'Statistics', 'Advanced Math'];
    const subjectIndex = Math.min(Math.floor((gameState.wave - 1) / 5), subjects.length - 1);
    elements.waveIndicator.querySelector('span').textContent = `Wave ${gameState.wave} - ${subjects[subjectIndex]}`;
    
    document.body.appendChild(transition);
    
    setTimeout(() => transition.remove(), 4000);
  }

  function showBossWarning() {
    const warning = document.createElement('div');
    warning.className = 'bossWarning';
    document.body.appendChild(warning);
    
    showNotification('⚠️ BOSS APPROACHING! ⚠️', 'danger');
    
    setTimeout(() => warning.remove(), 3000);
  }

  function gameLoop() {
    if(!gameState.playing) return;
    
    // Update timer
    const elapsed = Date.now() - gameState.sessionStartTime;
    elements.timerDisplay.textContent = 'Time: ' + formatTime(elapsed);
    
    // Update streak
    elements.streakDisplay.textContent = 'Streak: ' + (gameState.combo - 1);
    
    // Update mission brief
    updateMissionBrief();
    
    // Update analytics
    updateLearningAnalytics();
    
    requestAnimationFrame(gameLoop);
  }

  // Effects functions
  function createExplosion(x, y) {
    if(!gameState.settings.particles) return;
    
    for(let i = 0; i < 12; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      
      const angle = (Math.PI * 2 / 12) * i;
      const distance = 50 + Math.random() * 100;
      
      particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
      particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
      particle.style.background = ['var(--accent)', 'var(--good)', 'var(--bad)', '#fff'][Math.floor(Math.random() * 4)];
      
      elements.gameArea.appendChild(particle);
      setTimeout(() => particle.remove(), 2000);
    }
  }

  function createCollectEffect(x, y) {
    if(!gameState.settings.particles) return;
    
    for(let i = 0; i < 8; i++) {
      const spark = document.createElement('div');
      spark.className = 'particle spark';
      spark.style.left = x + 'px';
      spark.style.top = y + 'px';
      
      elements.gameArea.appendChild(spark);
      setTimeout(() => spark.remove(), 1500);
    }
  }

  function createMegaEffect() {
    if(!gameState.settings.particles) return;
    
    const colors = ['#ff006e', '#8338ec', '#3a0ca3', '#fb5607', '#ffbe0b'];
    
    for(let i = 0; i < 20; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = (elements.ship.offsetLeft + 30) + 'px';
        particle.style.bottom = '60px';
        particle.style.width = '15px';
        particle.style.height = '15px';
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.boxShadow = `0 0 20px ${particle.style.background}`;
        
        const angle = (Math.PI * 2 / 20) * i;
        const distance = 100 + Math.random() * 50;
        
        particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
        
        elements.gameArea.appendChild(particle);
        setTimeout(() => particle.remove(), 2000);
      }, i * 50);
    }
  }

  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 5000);
  }

  // Achievement system
  function checkAchievement(id) {
    if(gameState.achievements[id]) return;
    
    gameState.achievements[id] = true;
    
    const achievementData = {
      firstWin: { name: 'First Contact', icon: '🎯' },
      combo5: { name: 'Heating Up', icon: '🔥' },
      combo10: { name: 'On Fire', icon: '💥' },
      combo25: { name: 'Lightning Strike', icon: '⚡' },
      survivor: { name: 'Space Survivor', icon: '💪' },
      veteran: { name: 'Veteran Pilot', icon: '🎖️' },
      legend: { name: 'Living Legend', icon: '👑' },
      accurate: { name: 'Sharpshooter', icon: '🎯' },
      perfect: { name: 'Perfect Precision', icon: '⭐' },
      algebraMaster: { name: 'Algebra Ace', icon: '📐' },
      geometryGuru: { name: 'Geometry Genius', icon: '📏' },
      calculusKing: { name: 'Calculus Champion', icon: '∫' },
      speedster: { name: 'Speed Demon', icon: '⚡' },
      lightning: { name: 'Lightning Calculator', icon: '🌩️' },
      collector: { name: 'Power Collector', icon: '💎' },
      hoarder: { name: 'Power Hoarder', icon: '🗃️' },
      highScore: { name: 'High Scorer', icon: '🏆' },
      megaScore: { name: 'Mega Scorer', icon: '💫' },
      bossSlayer: { name: 'Boss Slayer', icon: '👹' },
      bossHunter: { name: 'Boss Hunter', icon: '🗡️' },
      mathematician: { name: 'Master Mathematician', icon: '🧮' },
      scholar: { name: 'Galactic Scholar', icon: '🎓' },
      explorer: { name: 'Space Explorer', icon: '🚀' },
      shopper: { name: 'Cosmic Shopper', icon: '🛒' },
      wealthy: { name: 'Space Millionaire', icon: '💰' },
      marathon: { name: 'Math Marathon', icon: '⏰' },
      dedication: { name: 'Dedicated Student', icon: '📅' },
      konami: { name: 'Code Breaker', icon: '🎮' },
      easter: { name: 'Easter Hunter', icon: '🥚' },
      ultimate: { name: 'Ultimate Champion', icon: '🌟' }
    };
    
    const achievement = achievementData[id];
    if(achievement) {
      showNotification(`${achievement.icon} Achievement Unlocked: ${achievement.name}!`, 'achievement');
      
      // Add to game over screen if in game
      if(gameState.playing) {
        const newAchievements = document.getElementById('newAchievements');
        if(newAchievements && !newAchievements.querySelector(`[data-achievement="${id}"]`)) {
          const achDiv = document.createElement('div');
          achDiv.setAttribute('data-achievement', id);
          achDiv.style.cssText = 'background:rgba(0,255,136,0.2);padding:10px;margin:5px;border-radius:5px';
          achDiv.textContent = `${achievement.icon} ${achievement.name}`;
          newAchievements.appendChild(achDiv);
        }
      }
    }
    
    saveGameData();
    updateAchievementDisplay();
  }

  function checkEndGameAchievements() {
    const accuracy = gameState.questionsAnswered > 0 
      ? (gameState.correctAnswers / gameState.questionsAnswered) 
      : 0;
    
    if(gameState.score >= 10000) checkAchievement('highScore');
    if(gameState.score >= 50000) checkAchievement('megaScore');
    if(accuracy >= 0.95 && gameState.questionsAnswered >= 20) checkAchievement('accurate');
    if(gameState.correctAnswers >= 10 && accuracy === 1) checkAchievement('perfect');
    
    // Subject achievements
    Object.entries(gameState.subjects).forEach(([subject, stats]) => {
      if(stats.correct >= 100) {
        const achievementMap = {
          algebra: 'algebraMaster',
          geometry: 'geometryGuru',
          calculus: 'calculusKing'
        };
        if(achievementMap[subject]) {
          checkAchievement(achievementMap[subject]);
        }
      }
    });

      // Total stats
      const totalCorrect = parseInt(localStorage.getItem('gmq_totalCorrect') || '0') + gameState.correctAnswers;
      if(totalCorrect >= 1000) checkAchievement('mathematician');
      
      const totalCoins = parseInt(localStorage.getItem('gmq_totalCoins') || '0') + gameState.coins;
      if(totalCoins >= 10000) checkAchievement('wealthy');
      
      // Check ultimate achievement
      const totalAchievements = Object.keys(gameState.achievements).length;
      if(totalAchievements >= 35) checkAchievement('ultimate');
    }

    function updateAchievementDisplay() {
      const totalAchievements = Object.keys(gameState.achievements).length;
      document.getElementById('achievementCount').textContent = `${totalAchievements}/36`;
      document.getElementById('achievementPercent').textContent = Math.round((totalAchievements / 36) * 100) + '%';
      
      // Update achievement cards
      document.querySelectorAll('.achievementCard').forEach(card => {
        const id = card.getAttribute('data-achievement');
        if(gameState.achievements[id]) {
          card.classList.add('unlocked');
          card.querySelector('.progressFill').style.width = '100%';
        }
      });
    }

    // Analytics functions
    function updateLearningAnalytics() {
      // Calculate subject mastery
      const masteryData = Object.entries(gameState.subjects).map(([subject, stats]) => {
        const mastery = stats.total > 0 ? (stats.correct / stats.total) * 100 : 0;
        return { subject, mastery };
      });
      
      // Update mastery chart
      const chart = document.getElementById('masteryChart');
      if(chart && !chart.hasChildNodes()) {
        masteryData.forEach((data, index) => {
          const bar = document.createElement('div');
          bar.className = 'chart-bar';
          bar.style.left = (index * 12.5) + '%';
          bar.style.height = '0%';
          bar.style.background = `var(--${data.subject})`;
          chart.appendChild(bar);
        });
      }
      
      // Animate bars
      if(chart) {
        const bars = chart.querySelectorAll('.chart-bar');
        masteryData.forEach((data, index) => {
          if(bars[index]) {
            bars[index].style.height = data.mastery + '%';
          }
        });
      }
    }

    function updateAnalyticsScreen() {
      // Calculate overall stats
      const stats = calculateLifetimeStats();
      
      document.getElementById('overallProgress').textContent = Math.round(stats.progress) + '%';
      document.getElementById('avgAccuracy').textContent = Math.round(stats.accuracy) + '%';
      document.getElementById('avgSpeed').textContent = stats.avgSpeed + 's';
      document.getElementById('longestStreak').textContent = stats.longestStreak;
      document.getElementById('subjectsMastered').textContent = stats.subjectsMastered + '/8';
      document.getElementById('skillLevel').textContent = stats.skillLevel;
      
      // Recommendations
      const weakestSubject = stats.weakestSubject || 'basic';
      document.getElementById('focusArea').textContent = weakestSubject.charAt(0).toUpperCase() + weakestSubject.slice(1);
      document.getElementById('nextGoal').textContent = stats.nextGoal;
      document.getElementById('suggestedPractice').textContent = stats.suggestedPractice;
    }

    function calculateLifetimeStats() {
      const savedStats = JSON.parse(localStorage.getItem('gmq_stats') || '{}');
      
      const totalGames = parseInt(savedStats.gamesPlayed || '0');
      const totalScore = parseInt(savedStats.totalScore || '0');
      const totalQuestions = parseInt(savedStats.totalQuestions || '0');
      const totalCorrect = parseInt(savedStats.totalCorrect || '0');
      const totalTime = parseInt(savedStats.totalTime || '0');
      
      const accuracy = totalQuestions > 0 ? (totalCorrect / totalQuestions) * 100 : 0;
      const avgSpeed = totalCorrect > 0 ? Math.round(totalTime / totalCorrect / 1000) : 0;
      
      // Calculate subject mastery
      let subjectsMastered = 0;
      let weakestSubject = null;
      let lowestMastery = 100;
      
      Object.entries(gameState.subjects).forEach(([subject, stats]) => {
        const mastery = stats.total > 0 ? (stats.correct / stats.total) * 100 : 0;
        if(mastery >= 80 && stats.total >= 50) {
          subjectsMastered++;
        }
        if(mastery < lowestMastery && stats.total > 10) {
          lowestMastery = mastery;
          weakestSubject = subject;
        }
      });
      
      // Determine skill level
      let skillLevel = 'Novice';
      if(totalGames >= 10 && accuracy >= 60) skillLevel = 'Apprentice';
      if(totalGames >= 25 && accuracy >= 70) skillLevel = 'Competent';
      if(totalGames >= 50 && accuracy >= 80) skillLevel = 'Proficient';
      if(totalGames >= 100 && accuracy >= 90) skillLevel = 'Expert';
      if(totalGames >= 200 && accuracy >= 95) skillLevel = 'Master';
      
      // Calculate progress
      const progress = (
        (totalGames / 100) * 20 +
        (accuracy / 100) * 30 +
        (subjectsMastered / 8) * 30 +
        (Math.min(totalScore, 100000) / 100000) * 20
      );
      
      // Generate recommendations
      let nextGoal = 'Complete 10 games';
      if(totalGames >= 10) nextGoal = 'Achieve 80% accuracy';
      if(accuracy >= 80) nextGoal = 'Master all subjects';
      if(subjectsMastered >= 8) nextGoal = 'Reach Expert level';
      
      let suggestedPractice = 'Basic Math Practice';
      if(weakestSubject) {
        suggestedPractice = `${weakestSubject.charAt(0).toUpperCase() + weakestSubject.slice(1)} Practice Mode`;
      }
      
      return {
        progress,
        accuracy,
        avgSpeed,
        longestStreak: parseInt(savedStats.longestStreak || '0'),
        subjectsMastered,
        skillLevel,
        weakestSubject,
        nextGoal,
        suggestedPractice
      };
    }

    function updateLifetimeStats() {
      const savedStats = JSON.parse(localStorage.getItem('gmq_stats') || '{}');
      
      savedStats.gamesPlayed = (parseInt(savedStats.gamesPlayed || '0') + 1);
      savedStats.totalScore = (parseInt(savedStats.totalScore || '0') + gameState.score);
      savedStats.totalQuestions = (parseInt(savedStats.totalQuestions || '0') + gameState.questionsAnswered);
      savedStats.totalCorrect = (parseInt(savedStats.totalCorrect || '0') + gameState.correctAnswers);
      savedStats.totalTime = (parseInt(savedStats.totalTime || '0') + (Date.now() - gameState.sessionStartTime));
      savedStats.totalPowerups = (parseInt(savedStats.totalPowerups || '0') + gameState.powerupsCollected);
      savedStats.totalCoins = (parseInt(savedStats.totalCoins || '0') + gameState.coins);
      
      if(gameState.maxCombo > parseInt(savedStats.longestStreak || '0')) {
        savedStats.longestStreak = gameState.maxCombo;
      }
      
      if(gameState.score > parseInt(savedStats.highScore || '0')) {
        savedStats.highScore = gameState.score;
        document.getElementById('yourHighScore').textContent = gameState.score;
      }
      
      localStorage.setItem('gmq_stats', JSON.stringify(savedStats));
      
      // Update settings screen
      updateSettingsStats();
    }

    function updateSettingsStats() {
      const stats = JSON.parse(localStorage.getItem('gmq_stats') || '{}');
      
      document.getElementById('gamesPlayed').textContent = stats.gamesPlayed || '0';
      document.getElementById('totalScore').textContent = stats.totalScore || '0';
      document.getElementById('bestCombo').textContent = stats.longestStreak || '0';
      document.getElementById('accuracy').textContent = 
        stats.totalQuestions > 0 
          ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100) + '%'
          : '0%';
      document.getElementById('powerupsUsed').textContent = stats.totalPowerups || '0';
      document.getElementById('totalCoins').textContent = gameState.coins;
      document.getElementById('achievementsUnlocked').textContent = Object.keys(gameState.achievements).length + '/36';
      document.getElementById('playTime').textContent = formatPlayTime(stats.totalTime || 0);
      document.getElementById('totalQuestions').textContent = stats.totalQuestions || '0';
      document.getElementById('totalCorrect').textContent = stats.totalCorrect || '0';
      
      // Calculate skill rating
      const lifetimeStats = calculateLifetimeStats();
      document.getElementById('skillRating').textContent = lifetimeStats.skillLevel;
    }

    // Utility functions
    function formatTime(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function formatPlayTime(ms) {
      const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
      return `${hours}h ${minutes}m`;
    }

    function hideAllScreens() {
      const screens = [
        'startScreen', 'tutorialScreen', 'shopScreen', 'achievementScreen',
        'analyticsScreen', 'customizeScreen', 'helpScreen', 'multiplayerScreen',
        'leaderboardScreen', 'settingsScreen', 'pauseScreen', 'gameOver'
      ];
      
      screens.forEach(screenId => {
        elements[screenId].hidden = true;
      });
    }

    function saveGameData() {
      localStorage.setItem('gmq_coins', gameState.coins.toString());
      localStorage.setItem('gmq_achievements', JSON.stringify(gameState.achievements));
      localStorage.setItem('gmq_unlocked', JSON.stringify(gameState.unlocked));
      localStorage.setItem('gmq_settings', JSON.stringify(gameState.settings));
    }

    function loadGameData() {
      gameState.coins = parseInt(localStorage.getItem('gmq_coins') || '0');
      gameState.achievements = JSON.parse(localStorage.getItem('gmq_achievements') || '{}');
      gameState.unlocked = JSON.parse(localStorage.getItem('gmq_unlocked') || '{}');
      
      const savedSettings = JSON.parse(localStorage.getItem('gmq_settings') || '{}');
      gameState.settings = { ...gameState.settings, ...savedSettings };
      
      // Update displays
      updateAchievementDisplay();
      updateSettingsStats();
      document.getElementById('currentCoins').textContent = gameState.coins;
      document.getElementById('shopCoins').textContent = gameState.coins;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadGameData();
      
      // Start button
      document.getElementById('startBtn').addEventListener('click', () => {
        const selectedMode = document.querySelector('.modeCard.selected');
        const mode = selectedMode ? selectedMode.dataset.mode : 'classic';
        startGame(mode);
      });
      
      // Mode selection
      document.querySelectorAll('.modeCard').forEach(card => {
        card.addEventListener('click', () => {
          if(card.classList.contains('locked')) {
            showNotification('This mode is locked! Complete more challenges to unlock.', 'warning');
            return;
          }
          document.querySelectorAll('.modeCard').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
        });
      });
      
      // Navigation buttons
      document.getElementById('tutorialBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.tutorialScreen.hidden = false;
      });
      
      document.getElementById('shopBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.shopScreen.hidden = false;
        document.getElementById('shopCoins').textContent = gameState.coins;
      });
      
      document.getElementById('achievementsBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.achievementScreen.hidden = false;
      });
      
      document.getElementById('analyticsBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.analyticsScreen.hidden = false;
        updateAnalyticsScreen();
      });
      
      document.getElementById('customizeBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.customizeScreen.hidden = false;
      });
      
      document.getElementById('helpBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.helpScreen.hidden = false;
      });
      
      document.getElementById('multiplayerBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.multiplayerScreen.hidden = false;
      });
      
      document.getElementById('leaderboardBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.leaderboardScreen.hidden = false;
      });
      
      document.getElementById('settingsMainBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.settingsScreen.hidden = false;
      });
      
      // Tutorial navigation
      let currentSlide = 1;
      const totalSlides = 5;
      
      document.querySelectorAll('.tutNextBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById(`tutorialSlide${currentSlide}`).hidden = true;
          currentSlide++;
          if(currentSlide <= totalSlides) {
            document.getElementById(`tutorialSlide${currentSlide}`).hidden = false;
          }
        });
      });
      
      document.querySelectorAll('.tutPrevBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById(`tutorialSlide${currentSlide}`).hidden = true;
          currentSlide--;
          document.getElementById(`tutorialSlide${currentSlide}`).hidden = false;
        });
      });
      
      document.querySelector('.tutEndBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.startScreen.hidden = false;
        checkAchievement('scholar');
      });
      
      // Shop functionality
      document.querySelectorAll('.shopItem').forEach(item => {
        item.addEventListener('click', () => {
          const itemId = item.dataset.item;
          const price = parseInt(item.querySelector('.price').textContent);
          
          if(gameState.unlocked[itemId]) {
            showNotification('Already purchased!', 'info');
            return;
          }
          
          if(gameState.coins >= price) {
            gameState.coins -= price;
            gameState.unlocked[itemId] = true;
            item.classList.add('purchased');
            document.getElementById('shopCoins').textContent = gameState.coins;
            saveGameData();
            showNotification('Purchase successful! 🎉', 'achievement');
            
            // Check achievement
            const purchasedCount = Object.keys(gameState.unlocked).length;
            if(purchasedCount >= 5) checkAchievement('shopper');
          } else {
            showNotification('Not enough coins!', 'warning');
          }
        });
      });
      
      // Back buttons
      const backButtons = [
        'shopBackBtn', 'achievementBackBtn', 'analyticsBackBtn', 
        'customizeBackBtn', 'helpBackBtn', 'multiplayerBackBtn',
        'leaderboardBackBtn', 'settingsBackBtn'
      ];
      
      backButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if(btn) {
          btn.addEventListener('click', () => {
            hideAllScreens();
            elements.startScreen.hidden = false;
          });
        }
      });
      
      // Game controls
      document.addEventListener('keydown', (e) => {
        if(!gameState.playing) return;
        
        switch(e.key) {
          case 'ArrowLeft':
          case 'a':
          case 'A':
            e.preventDefault();
            moveShip('left');
            break;
          case 'ArrowRight':
          case 'd':
          case 'D':
            e.preventDefault();
            moveShip('right');
            break;
          case 'ArrowDown':
          case 's':
          case 'S':
          case ' ':
            e.preventDefault();
            fireWeapon();
            break;
          case 'Escape':
            e.preventDefault();
            if(gameState.paused) {
              resumeGame();
            } else {
              pauseGame();
            }
            break;
          case 'p':
          case 'P':
            showNotification('Power-ups: Shield, Life, Slow, Double, Bomb, Coin, Mega', 'info');
            break;
        }
      });
      
      // Touch controls
      document.querySelectorAll('.touchZone').forEach(zone => {
        zone.addEventListener('click', () => {
          const lane = parseInt(zone.dataset.lane);
          if(lane === 0 && gameState.shipPosition > 0) {
            moveShip('left');
          } else if(lane === 2 && gameState.shipPosition < 2) {
            moveShip('right');
          } else if(lane === 1) {
            fireWeapon();
          }
        });
      });
      
      // Pause/Resume
      document.getElementById('pauseBtn').addEventListener('click', pauseGame);
      document.getElementById('resumeBtn').addEventListener('click', resumeGame);
      document.getElementById('restartBtn').addEventListener('click', () => {
        resumeGame();
        endGame();
        startGame(gameState.mode);
      });
      document.getElementById('mainMenuBtn').addEventListener('click', () => {
        resumeGame();
        endGame();
        hideAllScreens();
        elements.startScreen.hidden = false;
      });
      
      // Game over buttons
      document.getElementById('playAgainBtn').addEventListener('click', () => {
        hideAllScreens();
        startGame(gameState.mode);
      });
      
      document.getElementById('gameOverMenuBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.startScreen.hidden = false;
      });
      
      document.getElementById('shareScoreBtn').addEventListener('click', () => {
        const text = `I scored ${gameState.score} points in Galactic Math Quest! 🚀`;
        if(navigator.share) {
          navigator.share({ text });
        } else {
          navigator.clipboard.writeText(text);
          showNotification('Score copied to clipboard!', 'info');
        }
      });
      
      document.getElementById('viewStatsBtn').addEventListener('click', () => {
        hideAllScreens();
        elements.analyticsScreen.hidden = false;
        updateAnalyticsScreen();
      });
      
      // Speed control
      elements.speedSlider.addEventListener('input', (e) => {
        const speed = parseInt(e.target.value);
        gameState.speedMultiplier = speed / 100;
        elements.speedValue.textContent = speed + '%';
      });
      
      document.querySelectorAll('.speed-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          const speed = parseInt(btn.dataset.speed);
          elements.speedSlider.value = speed;
          elements.speedSlider.dispatchEvent(new Event('input'));
        });
      });
      
      // Settings
      document.getElementById('themeBtn').addEventListener('click', () => {
        const themes = ['space', 'nebula', 'nova', 'matrix', 'cyberpunk'];
        const currentIndex = themes.indexOf(gameState.settings.theme);
        const nextIndex = (currentIndex + 1) % themes.length;
        gameState.settings.theme = themes[nextIndex];
        document.body.className = `theme-${themes[nextIndex]}`;
        document.getElementById('themeBtn').textContent = `🌌 THEME: ${themes[nextIndex].toUpperCase()}`;
        saveGameData();
      });
      
      document.getElementById('qualityBtn').addEventListener('click', () => {
        const qualities = ['low', 'medium', 'high'];
        const currentIndex = qualities.indexOf(gameState.settings.quality);
        const nextIndex = (currentIndex + 1) % qualities.length;
        gameState.settings.quality = qualities[nextIndex];
        document.getElementById('qualityBtn').textContent = `✨ QUALITY: ${qualities[nextIndex].toUpperCase()}`;
        
        // Apply quality settings
        if(qualities[nextIndex] === 'low') {
          gameState.settings.particles = false;
          gameState.settings.shake = false;
        } else if(qualities[nextIndex] === 'medium') {
          gameState.settings.particles = true;
          gameState.settings.shake = false;
        } else {
          gameState.settings.particles = true;
          gameState.settings.shake = true;
        }
        
        saveGameData();
      });
      
      document.getElementById('resetStatsBtn').addEventListener('click', () => {
        if(confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
          localStorage.clear();
          location.reload();
        }
      });
      
      // Mobile menu
      elements.menuToggle.addEventListener('click', () => {
        elements.sidePanel.classList.toggle('open');
      });
      
      // Fullscreen
      document.getElementById('fullscreenBtn').addEventListener('click', () => {
        if(!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      });
      
      // Sound toggle
      document.getElementById('soundMainBtn').addEventListener('click', () => {
        gameState.settings.sound = !gameState.settings.sound;
        document.getElementById('soundMainBtn').textContent = gameState.settings.sound ? '🔊' : '🔇';
        saveGameData();
      });
      
      // Help button in game
      document.getElementById('helpGameBtn').addEventListener('click', () => {
        if(gameState.playing) {
          pauseGame();
        }
        hideAllScreens();
        elements.helpScreen.hidden = false;
      });
      
      // Responsive check
      if(window.innerWidth <= 1024) {
        elements.menuToggle.hidden = false;
      }
      
      window.addEventListener('resize', () => {
        elements.menuToggle.hidden = window.innerWidth > 1024;
      });
      
      // Konami code easter egg
      let konamiCode = [];
      const konamiPattern = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
      
      document.addEventListener('keydown', (e) => {
        konamiCode.push(e.key);
        konamiCode = konamiCode.slice(-10);
        
        if(konamiCode.join(',') === konamiPattern.join(',')) {
          checkAchievement('konami');
          showNotification('🎮 Konami Code Activated! +1000 coins!', 'achievement');
          gameState.coins += 1000;
          saveGameData();
          updateDisplay();
        }
      });
      
      // Initialize displays
      updateDisplay();
      updateMissionBrief();
      updateShipOnMiniMap();
      
      // Apply saved theme
      if(gameState.settings.theme !== 'space') {
        document.body.className = `theme-${gameState.settings.theme}`;
      }
      
      // Show loading complete
      console.log('🚀 Galactic Math Quest v3.0 - Ready for launch!');
    });
  </script>
</body>
</html>
